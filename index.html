<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×”×“×¨×š ×”×§×œ×” ×œ×¤×¨×’×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid white; }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 35px; height: 35px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-24 pb-12 text-right">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let currentUploadedFile = null;
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative flex flex-col min-h-[500px]">
        <!-- Header ×§×‘×•×¢ -->
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" class="w-32 h-32 bg-white rounded-3xl mx-auto -mt-24 mb-4 shadow-xl border-4 border-white object-cover">
        <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight uppercase leading-none">TipTap</h1>
        <p id="ui-card-label" class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest"></p>

        <!-- ××¡×š ×˜×¢×™× ×” -->
        <div id="loader-view" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 font-bold italic tracking-tighter">××¢×‘×“ × ×ª×•× ×™×...</p>
        </div>

        <!-- ×”×•×“×¢×ª ×”×¦×œ×—×” ×‘××™×¤×•×¡ -->
        <div id="reset-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>

        <!-- ×ª×•×›×Ÿ ××ª×—×œ×£ -->
        <div id="app-view" class="hidden flex-grow flex flex-col"></div>

        <!-- ×¤×•×˜×¨ (×™×•×¤×™×¢ ×ª××™×“) -->
        <div class="mt-auto pt-6 flex flex-col items-center gap-2">
            <a href="mailto:TIPTAP2026@GMAIL.COM" class="text-[10px] font-black text-slate-300 hover:text-blue-500 transition-colors uppercase italic tracking-widest decoration-slate-100 underline underline-offset-4 uppercase">âœ‰ï¸ ×¦×•×¨ ×§×©×¨ ×•×ª××™×›×” ×˜×›× ×™×ª</a>
        </div>
    </div>

    <!-- Modals (FAQ / Guide / Terms) -->
    <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4">
        <button onclick="toggleModal('guide-modal',false)" class="self-end text-white text-3xl mb-2">&times;</button>
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="max-w-full rounded-3xl border-2 border-white shadow-2xl">
    </div>

    <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm text-right">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-6 modal-enter flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6 border-b pb-4"><h3 class="font-bold text-xl">×¢×–×¨×” ×•×©××œ×•×ª × ×¤×•×¦×•×ª</h3><button onclick="toggleModal('faq-modal',false)" class="text-2xl text-slate-300">&times;</button></div>
            <div class="space-y-3 overflow-y-auto text-sm pr-1">
                <details class="bg-slate-50 p-4 rounded-xl"><summary class="font-bold cursor-pointer">××™×š ××•×¦×™××™× QR ××‘×™×˜?</summary>
                    <p class="mt-2 leading-relaxed">×”×™×›× ×¡×• ×œ××¤×œ×™×§×¦×™×” > 3 × ×§×•×“×•×ª ×‘×ª×¤×¨×™×˜ ×”×¢×œ×™×•×Ÿ > "×§×•×“ ×”-QR ×”×§×‘×•×¢ ×©×œ×™ ×œ×§×‘×œ×ª ×›×¡×£" > ×¦×œ××• ××¡×š ×•×”×¢×œ×•.</p></details>
                <details class="bg-red-50 p-4 rounded-xl text-red-600 border border-red-100"><summary class="font-bold cursor-pointer underline">×©×›×—×ª×™ ××ª ×”×§×•×“ ×”×¡×•×“×™?</summary>
                    <p class="mt-2 text-xs font-normal">×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ×§×•×“ ×©××‘×“. ×‘××™×“×” ×•×©×›×—×ª×, ×œ× ×ª×•×›×œ×• ×œ××¤×¡ ××ª ×”×›×¨×˜×™×¡ ×•×ª×¦×˜×¨×›×• ×œ×¨×›×•×© ×›×¨×˜×™×¡ ×—×“×©. ×¨×©××• ××•×ª×• ×‘××§×•× ×‘×˜×•×—!</p></details>
                <details class="bg-slate-50 p-4 rounded-xl"><summary class="font-bold cursor-pointer">×”×× ×”×©×™×¨×•×ª ×¢×•×œ×” ×œ×™ ×›×¡×£?</summary>
                    <p class="mt-2 italic font-black"><b>×œ×.</b> ×”××•×ª×’ TipTap ×œ× ×’×•×‘×” ×¢××œ×” ×¢×œ ×”×˜×™×¤×™× ×©×œ×š. ×”×›×¡×£ ×¢×•×‘×¨ ×‘-100% ×™×©×™×¨×•×ª ×œ×—×©×‘×•×Ÿ ×”×‘×™×˜ ×©×œ×š.</p></details>
                <details class="bg-slate-50 p-4 rounded-xl"><summary class="font-bold cursor-pointer">×”×× ×”××™×“×¢ ×©×œ×™ ×××•×‘×˜×—?</summary>
                    <p class="mt-2 font-black italic">×›×Ÿ. ×× ×—× ×• ×©×•××¨×™× ×¨×§ ××ª ×”×§×™×©×•×¨ ×”×¦×™×‘×•×¨×™ ×œ×ª×©×œ×•×. ××™×Ÿ ×œ× ×• ×©×•× ×’×™×©×” ×œ×—×©×‘×•×Ÿ ×”×‘× ×§, ×œ×™×ª×¨×” ××• ×œ×¤×¨×˜×™× ×”××™×©×™×™× ×‘×ª×•×š ×”×‘×™×˜.</p></details>
            </div>
            <button onclick="toggleModal('faq-modal',false)" class="w-full bg-slate-800 text-white py-4 rounded-2xl mt-6 font-bold uppercase tracking-widest italic font-black uppercase">×¡×’×•×¨</button>
        </div>
    </div>

    <!-- ××•×“×œ ×ª×§× ×•×Ÿ -->
    <div id="terms-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-8 text-right modal-enter">
            <h3 class="font-black text-xl mb-4 border-b pb-4 uppercase tracking-tighter italic font-black uppercase italic tracking-widest uppercase italic font-black uppercase italic tracking-widest uppercase">×ª× ××™ ×©×™××•×©</h3>
            <div class="text-xs text-slate-500 space-y-4">
                <p>â€¢ ×”×©×™×¨×•×ª × ×™×ª×Ÿ ×œ×œ× ××—×¨×™×•×ª ×œ×©×™×‘×•×©×™× ×¦×“ ×’'.</p>
                <p>â€¢ ×”×›×¨×˜×™×¡ × × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”. ××™×‘×•×“ ×§×•×“ ×¡×•×“×™ ×™×“×¨×•×© ×›×¨×˜×™×¡ ×—×“×©.</p>
                <p>â€¢ ×”××¢×¨×›×ª ×¨×©××™×ª ×œ×”×¤×¡×™×§ ×©×™×¨×•×ª ×‘×›×œ ×¢×ª.</p>
            </div>
            <button onclick="toggleModal('terms-modal',false)" class="w-full bg-blue-600 text-white py-4 rounded-2xl mt-6 font-bold shadow-lg">×§×¨××ª×™ ×•××™×©×¨×ª×™</button>
        </div>
    </div>

    <script>
        async function init() {
            if(!cardId) { renderUI('<p class="py-10 text-slate-500 font-bold italic tracking-tighter">× × ×œ×¡×¨×•×§ QR ×ª×§×™×Ÿ ××”×›×¨×˜×™×¡</p>'); return; }
            document.getElementById('ui-card-label').innerText = `CARD #${cardId}`;
            if(urlParams.get('reset')) document.getElementById('reset-success').classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const data = await res.json();
                if (data.status === "ACTIVE") renderPayment(data);
                else renderPick();
            } catch(e) { renderUI('<p class="text-red-500 font-bold p-10">×—×™×‘×•×¨ ×œ×©×¨×ª × ×›×©×œ. × ×¡×” ×œ×¨×¢× ×Ÿ.</p>'); }
        }

        function renderUI(h) {
            document.getElementById('loader-view').classList.add('hidden');
            const v = document.getElementById('app-view');
            v.innerHTML = h; v.classList.remove('hidden');
        }

        function renderPick() {
            renderUI(`
                <p class="text-sm font-bold text-slate-600 mb-6 italic tracking-tight">××” ×”-TipTap ×©×œ×š ×™×¢×©×”?</p>
                <button onclick="renderRegistration('tip')" class="w-full p-4 mb-4 border-2 border-blue-100 rounded-2xl bg-white hover:bg-blue-50 transition-all flex items-center gap-4 text-right">
                    <div class="text-3xl">ğŸ’°</div>
                    <div class="leading-none"><span class="font-black text-blue-900 block text-right font-black uppercase">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-500 italic tracking-tighter">×—×™×‘×•×¨ ×œ-Bit (××œ×¦×¨×™× ×•×©×œ×™×—×™×)</span></div>
                </button>
                <button onclick="renderRegistration('link')" class="w-full p-4 mb-10 border-2 border-orange-100 rounded-2xl bg-white hover:bg-orange-50 transition-all flex items-center gap-4 text-right">
                    <div class="text-3xl">ğŸš€</div>
                    <div class="leading-none text-right"><span class="font-black text-orange-900 block font-black uppercase italic tracking-tighter uppercase italic tracking-tighter italic">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400 italic">××¢×‘×¨ ×œ×§×™×©×•×¨ ××ª×¨ / ××™×©×™</span></div>
                </button>
                <div class="space-y-4">
                    <button onclick="toggleModal('guide-modal',true)" class="text-sm font-bold text-orange-600 underline">ğŸ“¸ ×”×“×¨×›×” ×œ×”×¤×¢×œ×”</button><br>
                    <button onclick="toggleModal('faq-modal',true)" class="text-xs text-slate-300 underline font-bold uppercase tracking-widest italic font-black uppercase italic tracking-tighter uppercase font-black italic tracking-widest italic font-black italic uppercase">×¢×–×¨×” ×•×©××œ×•×ª × ×¤×•×¦×•×ª</button>
                </div>
            `);
        }

        function renderRegistration(m) {
            renderUI(`
                <button onclick="renderPick()" class="text-xs font-bold text-blue-500 mb-6 underline flex items-center tracking-tighter">â† ×—×–×¨×”</button>
                <div class="space-y-5 text-right flex flex-col">
                    ${m==='tip' ? `
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-2 uppercase font-black tracking-widest uppercase italic tracking-tighter">×”×¢×œ××ª ×§×•×“ ×”-QR ×©×œ×š ××‘×™×˜:</p>
                    <label id="upload-box" class="flex items-center gap-4 p-5 border-2 border-dashed border-blue-200 rounded-[1.5rem] bg-white cursor-pointer hover:bg-blue-50">
                        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-10">
                        <span id="stext" class="text-sm font-bold text-slate-400 italic uppercase">×œ×—×¥ ×œ×‘×—×™×¨×”...</span>
                        <input type="file" id="finput" class="hidden" accept="image/*" onchange="currentUploadedFile=this.files[0];document.getElementById('stext').innerText='× ×‘×—×¨ âœ…'">
                    </label></div>` : `
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-2 italic tracking-tighter font-black">×”×“×‘×§ ×§×™×©×•×¨ ××ª×¨ / ××™× ×¡×˜×’×¨×:</p>
                    <input type="url" id="link-field" placeholder="https://..." class="w-full p-4 border-2 border-slate-100 rounded-xl bg-slate-50 text-left outline-none font-mono"></div>`}
                    
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-1 italic font-black italic uppercase">×©× ×‘×¢×œ ×”×›×¨×˜×™×¡:</p>
                    <input type="text" id="name-field" placeholder="×“×•×’××”: ××‘×™ ×”××œ×š ğŸ‘‘" class="w-full p-3 border-2 border-slate-100 rounded-xl italic font-black bg-slate-50 focus:border-blue-400 outline-none"></div>
                    
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-1 italic tracking-widest uppercase">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª):</p>
                    <input type="tel" id="pin-field" maxlength="4" placeholder="____" class="w-full p-3 border-2 border-slate-100 rounded-xl text-center text-3xl font-black tracking-[0.5em] outline-none"></div>

                    <div class="flex gap-2 p-3 bg-slate-50 rounded-xl border">
                        <input type="checkbox" id="check-v" class="mt-1 w-5 h-5 cursor-pointer">
                        <label class="text-[10px] text-slate-400 leading-tight">×× ×™ ×××©×¨ ××ª <button onclick="toggleModal('terms-modal',true)" class="underline font-bold text-blue-600">×”×ª×§× ×•×Ÿ</button>. ×”×›×¨×˜×™×¡ ×—×“ ×¤×¢××™ ×•× × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”.</label>
                    </div>
                    <button onclick="handleSend('${m}')" class="w-full bg-blue-600 text-white font-black py-4 rounded-[1.8rem] shadow-xl text-xl mt-4 active:scale-95 transition-all">×”×¤×¢×œ TipTap ğŸš€</button>
                </div>
            `);
        }

        async function handleSend(m) {
            const name = document.getElementById('name-field').value;
            const pin = document.getElementById('pin-field').value;
            const chk = document.getElementById('check-v').checked;
            if(!name || pin.length!==4 || !chk) return alert("××œ× ×¤×¨×˜×™×, 4 ×¡×¤×¨×•×ª ×§×•×“ ×•××©×¨ ×ª×§× ×•×Ÿ");

            renderUI('<div class="py-20 flex flex-col items-center"><div class="loader mb-4"></div><p class="font-black text-blue-600 animate-pulse italic tracking-tighter uppercase italic tracking-widest">××’×“×™×¨ ×›×¨×˜×™×¡...</p></div>');
            try {
                let bit = "", dir = "";
                if(m==='tip') {
                    if(!currentUploadedFile) throw "×”×¢×œ×” ×§×•×‘×¥";
                    bit = await scanQR(currentUploadedFile); if(!bit) throw "QR ×œ× ×–×•×”×”";
                } else { dir = document.getElementById('link-field').value; }
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${m}&name=${encodeURIComponent(name)}&pin=${pin}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(dir)}`;
            } catch(e) { alert("×©×’×™××”: "+e); renderPick(); }
        }

        function renderPayment(d) {
            renderUI(`
                <h1 class="text-3xl font-black text-slate-800 mb-1 italic tracking-tight font-black uppercase italic tracking-tighter uppercase font-black uppercase">×¤×¨×’×Ÿ ×œ${d.name}!</h1>
                <p class="text-slate-500 text-sm mb-10 tracking-tight italic font-black uppercase tracking-tighter italic">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×××•×‘×˜×— ×‘-bit</p>
                <button onclick="openLink('${d.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg mb-4 active:scale-95 transition-all">
                    <div class="flex items-center gap-4 italic font-black"><img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-10"><span>×ª×©×œ×•× ×‘-bit</span></div>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="3"/></svg>
                </button>
                ${d.type==='link' ? `<a href="${d.link}" target="_top" class="w-full bg-orange-500 text-white p-6 rounded-2xl text-xl font-black shadow-lg block italic uppercase italic tracking-tighter italic tracking-widest uppercase mb-10 text-center uppercase">×‘×™×§×•×¨ ×‘××ª×¨ ğŸš€</a>`:''}
                <div class="mt-4 bg-green-50 border border-green-100 rounded-xl p-3 flex items-center justify-center gap-3">
                   <div class="text-green-600 rounded-full"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2.166 10.324a.75.75 0 01.666-1.292C6.197 10.885 10 10.885 13.168 9.032a.75.75 0 01.764 1.288c-3.583 2.095-7.965 2.095-11.766-.996zM10 1.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 1.5z"/></svg></div>
                   <span class="text-green-800 font-bold text-[10px]">ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×”×¡×ª×™×™××” ×‘×”×¦×œ×—×” â€¢ ×ª×©×œ×•× ××•×’×Ÿ</span>
                </div>
                <div class="mt-12"><button onclick="showPers()" class="text-xs font-black text-blue-500 underline py-2 decoration-blue-200">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button></div>
            `);

            if(!document.getElementById('pm')) {
               document.body.insertAdjacentHTML('beforeend', `
               <div id="pm" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                  <div class="bg-white rounded-[2rem] p-6 w-full max-w-xs text-center shadow-2xl relative">
                     <h3 class="font-black mb-4 border-b pb-4 text-right">××–×•×¨ ××™×©×™</h3>
                     <input type="tel" id="pp" placeholder="PIN" maxlength="4" class="w-full text-center text-4xl font-black p-4 border-2 border-slate-100 rounded-xl mb-4 bg-slate-50 focus:border-blue-400 outline-none italic tracking-widest uppercase italic font-bold">
                     <button id="pbtn" onclick="fetchP()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl text-xl shadow-xl italic font-black uppercase">×›× ×™×¡×”</button>
                     <button onclick="toggleModal('pm',false)" class="text-slate-300 mt-6 text-xs uppercase font-black uppercase">×¡×’×•×¨</button>
                     <div id="pout" class="mt-6 hidden bg-blue-50 p-4 rounded-xl italic"></div>
                  </div>
               </div>`);
            }
        }

        async function fetchP() {
            const pin = document.getElementById('pp').value; if(pin.length!==4)return;
            document.getElementById('pbtn').innerText='...';
            try {
               const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${pin}`);
               const d = await r.json(); document.getElementById('pbtn').innerText='×›× ×™×¡×”';
               const o = document.getElementById('pout'); o.classList.remove('hidden');
               if(d.success) o.innerHTML=`×¡×¨×™×§×•×ª: <b class='text-blue-600 text-xl'>${d.total}</b><br>×××•×¦×¢ ×œ×™×•×: <b class='text-blue-600'>${d.average}</b><hr class='my-3'><button onclick="window.location.href='${API_URL}?action=reset&id=${cardId}&pin=${pin}'" class='text-red-500 font-bold underline'>ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×”</button>`;
               else o.innerHTML="×§×•×“ ×©×’×•×™ âŒ";
            } catch(e) { alert("×ª×§×œ×”"); }
        }

        function toggleModal(i,s) { const el=document.getElementById(i); if(s){el.classList.remove('hidden');el.classList.add('flex');} else {el.classList.add('hidden');el.classList.remove('flex');} }
        function showPers() { toggleModal('pm',true); }
        function openLink(u) { const b=u.trim().startsWith('h')?u:'https://'+u; const w=window.open(b,'_blank'); if(!w || w.closed) window.top.location.href=b; }

        async function scanQR(f) {
           return new Promise(resolve=>{
               const reader = new FileReader(); reader.readAsDataURL(f);
               reader.onload = e=>{
                   const im = new Image(); im.src=e.target.result;
                   im.onload = ()=>{
                       const c=document.createElement('canvas'); const ct=c.getContext('2d');
                       const sc=Math.min(800/im.width,800/im.height);
                       c.width=im.width*sc; c.height=im.height*sc;
                       ct.drawImage(im,0,0,c.width,c.height);
                       let q=jsQR(ct.getImageData(0,0,c.width,c.height).data, c.width, c.height);
                       if(!q) { ct.drawImage(im,0,im.height*0.25,im.width,im.height*0.5,0,0,c.width,c.height); q=jsQR(ct.getImageData(0,0,c.width,c.height).data, c.width, c.height); }
                       resolve(q?q.data:null);
                   }
               }
           });
        }
        init();
    </script>
</body>
</html>
