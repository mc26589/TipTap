<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipTap | ×”×›×¨×˜×™×¡ ×”×—×›×</title>
    
    <!-- ×”×—×–×¨×ª×™ ×œ×˜×¢×™× ×” ×¨×’×™×œ×” (×‘×œ×™ defer) ×œ×× ×™×¢×ª ×§×¨×™×¡×•×ª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f0f4f8; overflow-x: hidden; touch-action: manipulation; }
        
        /* Glass Style */
        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.05); 
        }

        .fade-in-up { animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader Animation */
        .loader-ring { width: 32px; height: 32px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .btn-press:active { transform: scale(0.97); transition: 0.1s; }
        
        /* FAQ Styling */
        details > summary { list-style: none; } 
        details > summary::-webkit-details-marker { display: none; }
        
        /* Toast Visible State */
        .toast-visible { opacity: 1 !important; transform: translate(-50%, 0) !important; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- === TOAST NOTIFICATION (×”×•×“×¢×” ×¦×¤×”) === -->
    <div id="toast-container" class="fixed top-8 left-1/2 -translate-x-1/2 z-[100] transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none">
        <div id="toast-body" class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[200px] justify-center backdrop-blur-md">
            <span id="toast-icon">â„¹ï¸</span>
            <span id="toast-message" class="text-sm font-bold">×”×•×“×¢×”</span>
        </div>
    </div>

    <!-- === CARD CONTAINER === -->
    <div class="glass w-full max-w-md rounded-[2.5rem] p-8 text-center relative flex flex-col min-h-[550px]">
        
        <header class="mb-4 z-10 relative">
            <div class="w-24 h-24 bg-white rounded-[1.5rem] mx-auto -mt-20 mb-3 shadow-xl border-4 border-white overflow-hidden">
                <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" id="logo-img" class="w-full h-full object-cover">
            </div>
            <h1 class="text-3xl font-black text-slate-800 italic uppercase tracking-tight">TipTap</h1>
            <p id="ui-id" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] mt-1 uppercase">Loading...</p>
        </header>

        <!-- LOADER -->
        <div id="loader-view" class="flex-grow flex flex-col items-center justify-center py-10 space-y-3">
            <div class="loader-ring"></div>
            <p id="loader-text" class="text-xs font-bold text-slate-400 animate-pulse">××ª×—×‘×¨ ×œ×©×¨×ª...</p>
        </div>

        <!-- 1. INTRO (××¡×š ×‘×—×™×¨×”) -->
        <div id="intro-view" class="hidden flex-col gap-4 fade-in-up px-1 text-right mt-4">
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest text-center mb-2">×©×œ×‘ 1: ×‘×—×™×¨×ª ××¡×œ×•×œ</p>
            
            <button onclick="goToSetup('tip')" class="btn-press bg-white border border-blue-100 p-4 rounded-2xl flex items-center gap-4 hover:border-blue-300 hover:shadow-md transition-all">
                <div class="text-2xl bg-blue-50 p-3 rounded-xl">ğŸ’°</div>
                <div><span class="block font-black text-slate-800 text-lg">××¡×œ×•×œ ×˜×™×¤</span><span class="text-xs text-slate-400 font-bold">×—×™×‘×•×¨ ×œ-Bit</span></div>
            </button>
            
            <button onclick="goToSetup('link')" class="btn-press bg-white border border-orange-100 p-4 rounded-2xl flex items-center gap-4 hover:border-orange-300 hover:shadow-md transition-all">
                <div class="text-2xl bg-orange-50 p-3 rounded-xl">ğŸš€</div>
                <div><span class="block font-black text-slate-800 text-lg">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-xs text-slate-400 font-bold">×§×™×©×•×¨ ×œ××ª×¨ / ××™× ×¡×˜×’×¨×</span></div>
            </button>
            
            <div class="mt-6 flex justify-between px-2">
                <button onclick="toggleModal('faq-modal', true)" class="text-xs font-bold text-slate-400 underline decoration-slate-200 hover:text-slate-600">â“ ×©××œ×•×ª × ×¤×•×¦×•×ª</button>
                <button onclick="toggleModal('guide-modal', true)" class="text-xs font-bold text-orange-400 underline decoration-orange-200 hover:text-orange-500">ğŸ“¸ ××™×š ×œ×”×•×¦×™× QR?</button>
            </div>
        </div>

        <!-- 2. SETUP (×˜×•×¤×¡ ×”×’×“×¨×•×ª) -->
        <div id="setup-form-view" class="hidden fade-in-up flex-col gap-3 text-right">
            <button onclick="backToIntro()" class="text-[10px] font-bold text-slate-500 w-fit mb-2 hover:text-slate-700 bg-slate-100 px-3 py-1 rounded-full transition-colors">âœ ×—×–×¨×”</button>
            <h2 id="setup-title" class="text-xl font-black text-slate-800 mb-2">×”×’×“×¨×ª × ×ª×•× ×™×</h2>

            <!-- QR Input -->
            <div id="input-group-bit" class="hidden">
                <p class="text-xs font-bold text-slate-500 mb-1">×”×¢×œ××ª QR (×¦×™×œ×•× ××¡×š ××‘×™×˜)</p>
                <label id="bit-label" class="flex flex-col items-center justify-center h-28 border-2 border-dashed border-blue-200 bg-blue-50/50 rounded-2xl cursor-pointer hover:bg-blue-50 transition-colors">
                    <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-6 opacity-60 mb-2">
                    <span id="bit-text" class="text-[10px] font-bold text-blue-400 uppercase tracking-wide">×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥</span>
                    <input type="file" id="fixed-file-input" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                </label>
            </div>

            <!-- Link Input -->
            <div id="input-group-link" class="hidden">
                <p class="text-xs font-bold text-slate-500 mb-1">×›×ª×•×‘×ª ×”×§×™×©×•×¨ (URL)</p>
                <input type="url" id="fixed-link-input" dir="ltr" placeholder="www.yourwebsite.com" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-slate-800 transition-colors shadow-inner">
            </div>

            <!-- Fields -->
            <div>
                <p class="text-xs font-bold text-slate-500 mb-1 mt-2">×©× ××œ×</p>
                <input type="text" id="fixed-name-input" placeholder="×œ××©×œ: ×“× ×™××œ" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-slate-800 transition-colors shadow-inner text-right">
            </div>

            <div>
                <p class="text-xs font-bold text-slate-500 mb-1 mt-2">×§×•×“ ××™×©×™ (PIN)</p>
                <input type="tel" id="fixed-pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-black text-center text-xl tracking-[0.5em] outline-none focus:border-slate-800 transition-colors shadow-inner">
            </div>

            <button onclick="saveCardSafe()" class="btn-press w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl text-sm mt-3 flex items-center justify-center gap-2">
                <span>×©××•×¨ ×•×”×¤×¢×œ ×›×¨×˜×™×¡</span><span>ğŸš€</span>
            </button>
        </div>

        <!-- 3. ACTIVE CARD (×ª×¦×•×’×” ×œ×œ×§×•×—) -->
        <div id="active-view" class="hidden fade-in-up flex-col text-center h-full pt-2">
            <!-- ×”×ª×•×›×Ÿ ×™×•×–×¨×§ ×¢"×™ JS -->
        </div>

    </div>

    <!-- === MODALS === -->
    <div id="faq-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target.id==='faq-modal') toggleModal('faq-modal', false)">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="font-black text-xl text-slate-800">××¨×›×– ×¢×–×¨×”</h3>
                <button onclick="toggleModal('faq-modal', false)" class="text-slate-300 text-2xl hover:text-slate-600">&times;</button>
            </div>
            <div class="space-y-3 text-right">
                <details class="group bg-slate-50 rounded-2xl border border-slate-100"><summary class="flex justify-between p-4 cursor-pointer font-bold text-slate-700 text-sm"><span>××™×š ×–×” ×¢×•×‘×“?</span><span>â–¼</span></summary><div class="p-4 pt-0 text-xs text-slate-500">×× ×—× ×• ××§×©×¨×™× ×‘×™×Ÿ ×›×¨×˜×™×¡ ×”-NFC ××• ×”-QR ×œ××¤×œ×™×§×¦×™×™×ª ×‘×™×˜.</div></details>
                <details class="group bg-slate-50 rounded-2xl border border-slate-100"><summary class="flex justify-between p-4 cursor-pointer font-bold text-slate-700 text-sm"><span>×™×© ×¢××œ×•×ª?</span><span>â–¼</span></summary><div class="p-4 pt-0 text-xs text-slate-500 font-bold text-green-600">×œ×! ×”×˜×™×¤ ×¢×•×‘×¨ 100% ×™×©×™×¨×•×ª ××œ×™×š.</div></details>
                <details class="group bg-slate-50 rounded-2xl border border-slate-100"><summary class="flex justify-between p-4 cursor-pointer font-bold text-slate-700 text-sm"><span>×–×” ×××•×‘×˜×—?</span><span>â–¼</span></summary><div class="p-4 pt-0 text-xs text-slate-500">×›×Ÿ. ×”×ª×©×œ×•× ×¢×¦××• ××ª×‘×¦×¢ ×‘××¤×œ×™×§×¦×™×™×ª ×‘×™×˜ ×©×œ ×”×‘× ×§×™×.</div></details>
            </div>
            <button onclick="toggleModal('faq-modal', false)" class="w-full mt-6 bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg">×”×‘× ×ª×™, ×ª×•×“×”</button>
        </div>
    </div>

    <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-sm" onclick="toggleModal('guide-modal', false)">
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="max-w-full rounded-[2rem] shadow-2xl border-4 border-white/20">
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/40 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-md" onclick="if(event.target.id==='admin-modal') toggleModal('admin-modal', false)">
         <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 text-center relative shadow-2xl fade-in-up">
            <button onclick="toggleModal('admin-modal', false)" class="absolute top-6 left-6 text-slate-300 font-bold">&times;</button>
            <h3 class="font-black text-xl mb-6 text-slate-800">× ×™×”×•×œ ×›×¨×˜×™×¡</h3>
            <div id="admin-login-view" class="space-y-4">
                <input type="tel" id="admin-pin" placeholder="PIN" maxlength="4" class="w-full text-center text-3xl font-black p-4 bg-slate-50 border rounded-2xl tracking-[0.5em] outline-none focus:border-blue-400">
                <button onclick="checkStats()" class="btn-press w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
            </div>
            <div id="admin-stats-view" class="hidden">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100"><span class="text-[10px] text-slate-400 font-black">×¡×¨×™×§×•×ª</span><p id="stat-scans" class="text-3xl font-black text-blue-600">-</p></div>
                    <div class="bg-purple-50 p-4 rounded-2xl border border-purple-100"><span class="text-[10px] text-slate-400 font-black">×××•×¦×¢</span><p id="stat-avg" class="text-3xl font-black text-purple-600">-</p></div>
                </div>
                <button onclick="doReset()" class="w-full bg-white text-red-500 font-bold py-2 rounded-xl text-xs border border-red-100 hover:bg-red-50">ğŸ—‘ï¸ ××—×™×§×ª ×›×¨×˜×™×¡</button>
            </div>
         </div>
    </div>

    <script>
        // *** CONFIGURATION ***
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec"; 
        
        const ASSETS = {
            main: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg",
            bit: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png"
        };
        document.getElementById('logo-img').src = ASSETS.main;

        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let currentMode = 'tip'; 
        let selectedBitFile = null;

        // Loader logic with Safety Check
        const loadTxt = document.getElementById('loader-text');
        const phrases = ["×™×•×¦×¨ ×§×©×¨ ×××•×‘×˜×—...", "××××ª × ×ª×•× ×™×...", "×˜×•×¢×Ÿ..."];
        let phraseIdx = 0;
        let phraseInterval = null;

        function startLoaderAnim() {
            phraseInterval = setInterval(() => {
                if(document.getElementById('loader-view') && !document.getElementById('loader-view').classList.contains('hidden')) {
                     loadTxt.innerText = phrases[phraseIdx];
                     phraseIdx = (phraseIdx + 1) % phrases.length;
                }
            }, 800);
        }

        function stopLoader(msg, isError) {
            if(phraseInterval) clearInterval(phraseInterval);
            if(msg) {
                const view = document.getElementById('loader-view');
                if(view) {
                    view.innerHTML = `<p class="font-bold ${isError?'text-red-400':'text-slate-400'} bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100 text-sm">${msg}</p>`;
                }
                if(isError) showToast(msg, true);
            } else {
                document.getElementById('loader-view').classList.add('hidden');
            }
        }

        // *** TOAST NOTIFICATION ***
        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const body = document.getElementById('toast-body');
            const icon = document.getElementById('toast-icon');
            const msgEl = document.getElementById('toast-message');

            body.className = isError 
                ? "bg-red-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[200px] justify-center backdrop-blur-md border border-red-400"
                : "bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[200px] justify-center backdrop-blur-md border border-slate-600";
            
            icon.innerText = isError ? "âš ï¸" : "â„¹ï¸";
            msgEl.innerText = message;
            container.classList.add('toast-visible');
            setTimeout(() => container.classList.remove('toast-visible'), 3500);
        }

        // *** INIT APP ***
        async function init() {
            startLoaderAnim(); // Start animation safely

            if(!cardId) {
                stopLoader("×œ× ×–×•×”×” ×›×¨×˜×™×¡ (×—×¡×¨ ID)", true);
                document.getElementById('ui-id').innerText = "ERROR";
                return;
            }
            document.getElementById('ui-id').innerText = `CARD #${cardId}`;

            try {
                // Fetch with a small timeout wrapper ideally, but for now standard fetch
                const res = await fetch(`${API_URL}?action=getData&id=${cardId}`);
                if(!res.ok) throw new Error("Server Error");
                
                const data = await res.json();
                stopLoader(); // Success

                if (data.status === 'NEW') {
                    document.getElementById('intro-view').classList.remove('hidden');
                    document.getElementById('intro-view').classList.add('flex');
                } else if (data.status === 'ACTIVE') {
                    renderActiveCard(data);
                } else if (data.status === 'LOCKED') {
                    stopLoader(`× ×¢×•×œ ×œ-${data.minutes} ×“×§'`, true);
                }
            } catch(e) {
                stopLoader("×©×’×™××ª ×ª×§×©×•×¨×ª. ×¨×¢× ×Ÿ ××ª ×”×“×£.", true);
                console.error(e);
            }
        }

        // --- SETUP LOGIC ---
        function goToSetup(mode) {
            currentMode = mode;
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('intro-view').classList.remove('flex');
            
            document.getElementById('setup-form-view').classList.remove('hidden');
            document.getElementById('setup-form-view').classList.add('flex');

            const t = document.getElementById('setup-title');
            const bg = document.getElementById('input-group-bit');
            const lg = document.getElementById('input-group-link');

            if(mode==='tip') {
                t.innerText = "×”×’×“×¨×ª ×‘×™×˜ (×˜×™×¤)";
                bg.classList.remove('hidden');
                lg.classList.add('hidden');
            } else {
                t.innerText = "×”×’×“×¨×ª ×§×™×©×•×¨ ×¢×¡×§×™";
                bg.classList.add('hidden');
                lg.classList.remove('hidden');
            }
        }

        function backToIntro() {
            document.getElementById('setup-form-view').classList.add('hidden');
            document.getElementById('setup-form-view').classList
