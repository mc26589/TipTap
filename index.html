<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipTap | ×¤×©×•×˜ ×œ×¤×¨×’×Ÿ</title>
    
    <!-- ×¡×¤×¨×™×•×ª ×¢×™×¦×•×‘, QR ×•×× ×™××¦×™×™×ª ×§×•× ×¤×˜×™ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f0f4f8; overflow-x: hidden; user-select: none; }
        
        /* Glass Card Effect */
        .glass-card { 
            background: rgba(255, 255, 255, 0.98); 
            border: 1px solid rgba(255,255,255,1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }

        /* Animations */
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* Button Press Effect */
        .btn-press:active { transform: scale(0.95); transition: transform 0.1s; }

        /* Custom Loader */
        .loader-ring { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        input { -webkit-appearance: none; appearance: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <script>
        // *** ×”×’×“×¨×•×ª ***
        // ×•×•×“× ×©×–×” ×”-URL ×”×¢×“×›× ×™ ××”×’×•×’×œ ×¡×§×¨×™×¤×˜ ×©×œ×š (Deploy -> Executable)
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        
        const ASSETS = {
            mainLogo: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg",
            bitLogo: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png",
            guideImage: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png"
        };
    </script>

    <div class="glass-card w-full max-w-md rounded-[2.5rem] p-6 text-center relative flex flex-col min-h-[500px] border border-white">
        
        <!-- Header ×§×‘×•×¢ -->
        <header class="mb-4 z-10 relative">
            <div class="w-28 h-28 bg-white rounded-[2rem] mx-auto -mt-20 mb-3 shadow-xl border-4 border-white overflow-hidden">
                <img src="" id="logo-img" class="w-full h-full object-cover">
            </div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight italic uppercase">TipTap</h1>
            <p id="ui-card-id" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] uppercase mt-1">CONNECTING...</p>
        </header>

        <!-- Loader -->
        <div id="loader-view" class="flex-grow flex flex-col items-center justify-center py-10">
            <div class="loader-ring mb-3"></div>
            <span class="text-xs font-bold text-slate-400 animate-pulse">×˜×•×¢×Ÿ × ×ª×•× ×™×...</span>
        </div>

        <!-- Toast Notifications (×”×•×“×¢×•×ª ×¦×¤×•×ª) -->
        <div id="toast" class="fixed top-10 left-0 right-0 mx-auto w-fit bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-50 hidden opacity-0 transition-opacity"></div>

        <!-- Dynamic Main Content -->
        <div id="main-view" class="hidden flex-grow flex flex-col slide-up text-right"></div>
        
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 z-50 hidden backdrop-blur-sm items-center justify-center p-6" onclick="closeModals(event)">
        <!-- Guide Image Modal -->
        <div id="guide-modal" class="hidden relative">
            <button onclick="closeModals(null, true)" class="absolute -top-4 -right-4 bg-white text-black rounded-full w-10 h-10 font-bold shadow-lg z-10 text-xl">&times;</button>
            <img src="" id="guide-img" class="rounded-3xl max-h-[70vh] shadow-2xl">
        </div>

        <!-- Admin / Personal Area -->
        <div id="admin-modal" class="hidden bg-white w-full max-w-xs rounded-3xl p-6 text-center shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="font-black text-xl mb-6 text-slate-800 border-b pb-4">× ×™×”×•×œ ×›×¨×˜×™×¡</h3>
            
            <div id="admin-login">
                <input type="tel" id="admin-pin-input" placeholder="****" maxlength="4" class="w-full text-center text-4xl font-black tracking-[0.5em] p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-blue-400 mb-6">
                <button onclick="checkAdminPin()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200">×›× ×™×¡×”</button>
            </div>

            <div id="admin-dashboard" class="hidden">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-2xl">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">×¡×¨×™×§×•×ª</span>
                        <p class="text-3xl font-black text-blue-600" id="stat-scans">-</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-2xl">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">×××•×¦×¢</span>
                        <p class="text-xl font-black text-purple-600 mt-1" id="stat-avg">-</p>
                    </div>
                </div>
                <button onclick="resetCardComplete()" class="text-red-500 text-xs font-bold underline py-2 decoration-red-200">××¤×¡ ×•××—×§ ×›×¨×˜×™×¡</button>
            </div>
        </div>
    </div>

    <script>
        // Init Assets
        document.getElementById('logo-img').src = ASSETS.mainLogo;
        document.getElementById('guide-img').src = ASSETS.guideImage;

        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let currentMode = 'tip'; 
        let selectedBitFile = null;

        async function init() {
            if(!cardId) {
                document.getElementById('loader-view').innerHTML = `<p class="text-red-500 font-bold">×¡×¨×•×§ ××ª ×”×›×¨×˜×™×¡ ××—×“×©</p>`;
                return;
            }
            document.getElementById('ui-card-id').innerText = `CARD #${cardId}`;
            
            try {
                // Fetch Data from Google Sheet
                const response = await fetch(`${API_URL}?action=getData&id=${cardId}`);
                const data = await response.json();
                
                // Hide Loader
                document.getElementById('loader-view').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');

                if(data.status === "NEW") {
                    renderSetupScreen();
                } else if(data.status === "ACTIVE") {
                    renderActiveScreen(data);
                } else if(data.status === "LOCKED") {
                    document.getElementById('main-view').innerHTML = `<div class="text-center p-10"><p class="text-xl font-black">×”×›×¨×˜×™×¡ × ×¢×•×œ</p><p>× ×¡×” ×©×•×‘ ×‘×¢×•×“ ${data.minutes} ×“×§×•×ª</p></div>`;
                }

            } catch(e) {
                alert('×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª');
            }
        }

        // --- Active Screen (××” ×©×”×œ×§×•×— ×¨×•××”) ---

        function renderActiveScreen(data) {
            // ×”×—×–×¨×ª×™ ××ª ×”×˜×§×¡×˜ ×©××”×‘×ª: "×¤×¨×’×Ÿ ×œ..."
            
            let btnHtml = '';
            
            // ×‘×“×™×§×” ×”×× ×–×” ××¡×œ×•×œ ×˜×™×¤ ××• ×§×™×©×•×¨
            if(data.type === 'tip') {
                btnHtml = `
                <button onclick="handlePaymentAction('${data.bit}', 'tip')" class="btn-press group w-full bg-white border-2 border-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg shadow-blue-50 mb-8 relative overflow-hidden">
                    <div class="flex items-center gap-4 relative z-10">
                        <img src="${ASSETS.bitLogo}" class="w-10">
                        <div class="text-right">
                            <span class="block font-black text-[#00b0e9] text-xl italic uppercase">×ª×©×œ×•× ×‘-Bit</span>
                            <span class="text-[10px] text-slate-400 font-bold">×”×¢×‘×¨×” ××”×™×¨×” ×•×××•×‘×˜×—×ª</span>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-full"><svg class="w-6 h-6 text-[#00b0e9]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg></div>
                </button>`;
            } else {
                btnHtml = `
                <button onclick="handlePaymentAction('${data.link}', 'link')" class="btn-press group w-full bg-gradient-to-l from-slate-900 to-slate-800 text-white p-5 rounded-2xl flex items-center justify-between shadow-xl shadow-slate-200 mb-8">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/10 p-2 rounded-xl text-2xl">ğŸ”—</div>
                        <div class="text-right">
                            <span class="block font-black text-lg">××¢×‘×¨ ×œ×§×™×©×•×¨</span>
                            <span class="text-[11px] opacity-70 font-light">××ª×¨ / ×¨×©×ª ×—×‘×¨×ª×™×ª</span>
                        </div>
                    </div>
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>`;
            }

            document.getElementById('main-view').innerHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-black text-slate-800 mb-1">×¤×¨×’×Ÿ ×œ${data.name}!</h1>
                    <div class="flex items-center justify-center gap-2 text-slate-400 text-xs font-bold bg-slate-50 w-fit mx-auto px-4 py-1 rounded-full border border-slate-100">
                        <span>ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×ª×§×™× ×”</span>
                    </div>
                </div>

                ${btnHtml}

                <div class="mt-auto border-t border-slate-100 pt-6 flex justify-center">
                    <button onclick="toggleModal('admin')" class="text-[10px] font-bold text-slate-300 tracking-widest uppercase hover:text-slate-500 transition-colors">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button>
                </div>
            `;
        }

        function handlePaymentAction(url, type) {
            if(!url) return;

            // *** ×”×¤×¢×œ×ª ××¤×§×˜ ×”×§×•× ×¤×˜×™ ***
            triggerConfetti();

            // ×•×™×“×•× ×ª×§×™× ×•×ª ×œ×™× ×§
            let targetUrl = url;
            if(!targetUrl.startsWith('http')) targetUrl = 'https://' + targetUrl;

            // ×”×©×”×™×™×” ×§×¦×¨×¦×¨×” ×©×œ 800ms ×›×“×™ ×©×”×œ×§×•×— ×™×¨××” ××ª ×”×§×•× ×¤×˜×™, ×•××– ××¢×‘×¨
            setTimeout(() => {
                if(type === 'tip') {
                    // ×‘×™×˜ ××¢×“×™×£ window.open
                    window.open(targetUrl, '_blank');
                } else {
                    // ×§×™×©×•×¨×™× ×¨×’×™×œ×™× - ×”×¤× ×™×” ×‘××•×ª×• ×—×œ×•×Ÿ ××• ×—×œ×•×Ÿ ×—×“×©
                    window.top.location.href = targetUrl;
                }
            }, 800);
        }

        function triggerConfetti() {
            var duration = 2000;
            var end = Date.now() + duration;

            // ×©×™×’×•×¨ ×§×•× ×¤×˜×™ ××¦×“ ×©×××œ ×•×™××™×Ÿ
            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#00b0e9', '#ffffff', '#fbbf24'] // ×¦×‘×¢×™ ×‘×™×˜/×–×”×‘
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#00b0e9', '#ffffff', '#fbbf24']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }


        // --- Setup Screen (×”×¤×¢×œ×” ×¨××©×•× ×™×ª) ---

        function renderSetupScreen() {
            document.getElementById('main-view').innerHTML = `
                <p class="text-center text-slate-400 text-xs font-bold uppercase tracking-widest mb-8">×”×’×“×¨×ª ×›×¨×˜×™×¡ ×—×“×©</p>
                
                <div class="space-y-4">
                    <button onclick="renderFinalSetup('tip')" class="btn-press w-full p-4 border-2 border-blue-50 bg-white hover:border-blue-200 hover:bg-blue-50 rounded-2xl flex items-center gap-4 transition-all shadow-sm">
                        <span class="text-2xl bg-blue-100 p-2 rounded-xl">ğŸ’°</span>
                        <div class="text-right">
                            <span class="block font-black text-slate-800">××¡×œ×•×œ ×˜×™×¤</span>
                            <span class="text-xs text-slate-400">×—×™×‘×•×¨ ×œ-Bit (××œ×¦×¨×™×/×¢×¦×××™×™×)</span>
                        </div>
                    </button>

                    <button onclick="renderFinalSetup('link')" class="btn-press w-full p-4 border-2 border-slate-50 bg-white hover:border-slate-200 hover:bg-slate-50 rounded-2xl flex items-center gap-4 transition-all shadow-sm">
                        <span class="text-2xl bg-slate-100 p-2 rounded-xl">ğŸš€</span>
                        <div class="text-right">
                            <span class="block font-black text-slate-800">××¡×œ×•×œ ×¢×¡×§×™</span>
                            <span class="text-xs text-slate-400">×§×™×©×•×¨ ×œ××ª×¨ / ××™× ×¡×˜×’×¨× / ×’×•×’×œ</span>
                        </div>
                    </button>
                    
                    <button onclick="document.getElementById('modal-overlay').classList.remove('hidden');document.getElementById('guide-modal').classList.remove('hidden');" class="text-center w-full text-xs font-bold text-orange-400 mt-4 underline decoration-orange-200">ğŸ“¸ ××™×š ××•×¦×™××™× ×§×•×“ QR?</button>
                </div>
            `;
        }

        function renderFinalSetup(type) {
            currentMode = type;
            const isTip = type === 'tip';

            const inputField = isTip ? 
                `<label class="block w-full h-32 border-2 border-dashed border-blue-300 bg-blue-50 rounded-2xl flex flex-col items-center justify-center cursor-pointer mb-4" id="upload-label">
                    <img src="${ASSETS.bitLogo}" class="w-8 opacity-50 mb-2">
                    <span class="text-xs font-bold text-blue-400" id="file-text">×‘×—×¨ ×¦×™×œ×•× ××¡×š ××‘×™×˜...</span>
                    <input type="file" class="hidden" accept="image/*" onchange="handleFile(this)">
                 </label>` : 
                `<div class="mb-4">
                    <p class="text-xs font-bold text-slate-400 mb-2">×”×“×‘×§ ×§×™×©×•×¨ (URL)</p>
                    <input type="url" id="link-field" dir="ltr" placeholder="www.yoursite.com" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold outline-none focus:border-slate-800">
                 </div>`;

            document.getElementById('main-view').innerHTML = `
                <button onclick="renderSetupScreen()" class="text-xs font-bold text-slate-400 mb-6 block">â† ×—×–×¨×”</button>
                
                <h2 class="text-xl font-black text-slate-800 mb-6 text-center">
                    ${isTip ? '×”×’×“×¨×ª ×‘×™×˜' : '×”×’×“×¨×ª ×§×™×©×•×¨'}
                </h2>

                ${inputField}
                
                <div class="mb-4">
                    <p class="text-xs font-bold text-slate-400 mb-2">×©× ×©×™×•×¤×™×¢ ×¢×œ ×”×›×¨×˜×™×¡</p>
                    <input type="text" id="name-field" placeholder="×™×©×¨××œ ×™×©×¨××œ×™" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold outline-none focus:border-slate-800 text-right">
                </div>

                <div class="mb-8">
                    <p class="text-xs font-bold text-slate-400 mb-2">×§×•×“ ×¡×•×“×™ (PIN) ×œ××–×•×¨ ××™×©×™</p>
                    <input type="tel" id="pin-field" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl font-black text-center text-xl tracking-[0.5em] outline-none focus:border-slate-800">
                </div>

                <button onclick="saveCard()" class="btn-press w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl text-lg">
                    ×©××•×¨ ×•×”×¤×¢×œ ×›×¨×˜×™×¡
                </button>
            `;
        }

        // --- Logic & Saving ---

        function handleFile(input) {
            if (input.files && input.files[0]) {
                selectedBitFile = input.files[0];
                document.getElementById('file-text').innerText = "×§×•×‘×¥ × ×‘×—×¨ âœ…";
                document.getElementById('upload-label').classList.replace('bg-blue-50','bg-green-50');
                document.getElementById('upload-label').classList.replace('border-blue-300','border-green-400');
            }
        }

        async function saveCard() {
            const name = document.getElementById('name-field').value;
            const pin = document.getElementById('pin-field').value;
            let bitData = "";
            let directLink = "";

            if (!name) return showToast('× × ×œ×”×–×™×Ÿ ×©×', true);
            if (pin.length !== 4) return showToast('× × ×œ×”×–×™×Ÿ ×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª)', true);

            // ×”×¤×¢×œ×ª ×œ×•××“×¨ ××œ×
            document.getElementById('main-view').innerHTML = `<div class="py-20 text-center"><div class="loader-ring mx-auto mb-4"></div><p class="font-bold">×©×•××¨ ×”×’×“×¨×•×ª...</p></div>`;

            try {
                if (currentMode === 'tip') {
                    if (!selectedBitFile) throw "×—×•×‘×” ×œ×”×¢×œ×•×ª ×ª××•× ×ª QR";
                    bitData = await scanQRImage(selectedBitFile);
                    if (!bitData) throw "×œ× ×–×•×”×” ×§×•×“ QR ×‘×ª××•× ×”";
                } else {
                    const lf = document.getElementById('link-field');
                    if (!lf || !lf.value) throw "×—×•×‘×” ×œ×”×–×™×Ÿ ×§×™×©×•×¨";
                    let val = lf.value.trim();
                    // ×ª×™×§×•×Ÿ ××•×˜×•××˜×™ ×œ×§×™×©×•×¨
                    if (!val.startsWith('http')) val = 'https://' + val;
                    directLink = val;
                }

                // ×”×¤× ×™×” ×œ×©××™×¨×” (GET Redirect Method - ×××™×Ÿ ×™×•×ª×¨ ×‘-GAS ×—×™× ××™)
                // ×©×™××•×© ×‘-encodeURIComponent ×”×•× ×§×¨×™×˜×™ ×›×“×™ ×©×”×¢×‘×¨×™×ª ×•×”×ª×•×•×™× ×”××™×•×—×“×™× ×‘×§×™×©×•×¨ ×œ× ×™×™×©×‘×¨×•
                const finalUrl = `${API_URL}?action=save&id=${cardId}&type=${currentMode}&name=${encodeURIComponent(name)}&pin=${pin}&bit=${encodeURIComponent(bitData)}&direct=${encodeURIComponent(directLink)}`;
                
                window.location.href = finalUrl;

            } catch (err) {
                showToast(err, true);
                setTimeout(() => renderFinalSetup(currentMode), 2000); // ×—×–×¨×” ×œ××¡×š ×¢×¨×™×›×” ×‘××§×¨×” ×›×©×œ
            }
        }

        // --- Helpers ---

        async function scanQRImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // ×¡×¨×™×§×” ×‘×¨×–×•×œ×•×¦×™×” ××•×¤×˜×™××œ×™×ª
                        const scale = Math.min(800 / img.width, 800 / img.height);
