<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×”×“×¨×š ×”×§×œ×” ×œ×¤×¨×’×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-24 pb-12 text-right">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        const LOGO_TIPTAP = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg";
        const LOGO_BIT = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png";
        
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let selectedBitFile = null;
        let activeMode = 'tip';
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[500px]">
        
        <!-- Header ×§×‘×•×¢ - ×œ× × ×¢×œ× ×œ×¢×•×œ× -->
        <div id="static-header">
            <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" 
                 class="w-32 h-32 bg-white rounded-3xl mx-auto -mt-24 mb-4 shadow-xl border-4 border-white object-cover">
            <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight uppercase leading-none">TipTap</h1>
            <p id="ui-card-id" class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest uppercase"></p>
        </div>

        <!-- ×”×•×“×¢×ª ×”×¦×œ×—×”/××™×¤×•×¡ -->
        <div id="reset-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>

        <!-- ×˜×•×¢×Ÿ × ×ª×•× ×™× -->
        <div id="loader-view" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 font-bold">×‘×•×“×§ ×¡×˜×˜×•×¡ ×›×¨×˜×™×¡...</p>
        </div>

        <!-- ××–×•×¨ ×”×ª×•×›×Ÿ ×”××ª×—×œ×£ -->
        <div id="main-view" class="hidden flex-grow flex flex-col">
            
            <!-- ×©×œ×‘ ×: ×‘×—×™×¨×ª ××¡×œ×•×œ -->
            <div id="selection-screen">
                <p class="text-sm font-bold text-slate-600 mb-6 text-center italic uppercase">××” ×”-TipTap ×©×œ×š ×™×¢×©×”?</p>
                <button onclick="showStep2('tip')" class="w-full p-4 mb-3 border-2 border-blue-100 rounded-2xl flex items-center gap-4 bg-white transition-all hover:bg-blue-50 text-right group">
                    <div class="text-3xl italic">ğŸ’°</div>
                    <div class="text-right leading-none"><span class="font-black text-blue-900 block text-right font-black uppercase">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-500 italic">×—×™×‘×•×¨ ×œ-Bit (××œ×¦×¨×™× ×•×©×œ×™×—×™×)</span></div>
                </button>
                <button onclick="showStep2('link')" class="w-full p-4 mb-8 border-2 border-orange-100 rounded-2xl flex items-center gap-4 bg-white transition-all hover:bg-orange-50 text-right group text-right">
                    <div class="text-3xl italic text-right">ğŸš€</div>
                    <div class="text-right leading-none"><span class="font-black text-orange-900 block text-right font-black italic">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400 italic">××¢×‘×¨ ×œ×§×™×©×•×¨ ××ª×¨ / ××™× ×¡×˜×’×¨×</span></div>
                </button>
                <button onclick="toggleModal('guide-modal',true)" class="text-sm font-bold text-orange-600 underline py-2 block w-full mb-2">ğŸ“¸ ×”×“×¨×›×” ×œ×”×¤×¢×œ×ª ×”×›×¨×˜×™×¡</button>
                <button onclick="toggleModal('faq-modal',true)" class="text-xs text-slate-400 underline font-bold uppercase tracking-widest text-center block w-full">×¢×–×¨×” ×•×©××œ×•×ª × ×¤×•×¦×•×ª</button>
            </div>

            <!-- ×©×œ×‘ ×‘: ×˜×•×¤×¡ ×”×¨×©××” -->
            <div id="registration-screen" class="hidden text-right space-y-4">
                <button onclick="showStep1()" class="text-xs font-bold text-blue-500 mb-6 underline flex items-center tracking-tighter italic">â† ×—×–×¨×” ×œ×‘×—×™×¨×”</button>
                
                <!-- ×©×“×” QR (×¨×§ ×œ××¡×œ×•×œ ×˜×™×¤) -->
                <div id="row-qr" class="hidden">
                    <p class="text-xs font-black text-slate-400 mr-1 mb-2 italic tracking-tighter uppercase font-black tracking-widest">×§×•×“ QR ××‘×™×˜:</p>
                    <label id="upload-box" class="flex items-center gap-4 p-5 border-2 border-dashed border-blue-200 rounded-[1.5rem] bg-white cursor-pointer hover:bg-blue-50">
                        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-10">
                        <span id="stext" class="text-sm font-bold text-slate-500 italic">×œ×—×¥ ×œ×‘×—×™×¨×”...</span>
                        <input type="file" id="f-input" class="hidden" accept="image/*" onchange="selectedBitFile=this.files[0];document.getElementById('stext').innerText='×§×•×‘×¥ × ×‘×—×¨ âœ…';">
                    </label>
                </div>

                <!-- ×©×“×” ×§×™×©×•×¨ (×¨×§ ×œ××¡×œ×•×œ ×¢×¡×§×™) -->
                <div id="row-link" class="hidden">
                    <p class="text-xs font-black text-slate-400 mr-1 mb-2 italic tracking-tighter font-black">×”×“×‘×§ ×§×™×©×•×¨ (URL):</p>
                    <input type="url" id="link-field" placeholder="https://..." class="w-full p-4 border-2 border-slate-100 rounded-2xl bg-slate-50 text-left outline-none font-mono">
                </div>

                <!-- ×©×“×•×ª ××©×•×ª×¤×™× -->
                <div>
                    <p class="text-xs font-black text-slate-400 mr-1 mb-1 italic font-black uppercase italic uppercase tracking-tighter italic font-black uppercase tracking-tighter italic">×©× ×‘×¢×œ ×”×›×¨×˜×™×¡:</p>
                    <input type="text" id="name-field" placeholder="×“×•×’××”: ××‘×™ ×”××œ×š ğŸ‘‘" class="w-full p-3 border-2 border-slate-100 rounded-xl italic font-black bg-slate-50 focus:border-blue-400 outline-none text-right transition-all">
                </div>
                
                <div>
                    <p class="text-xs font-black text-slate-400 mr-1 mb-1 italic font-black uppercase">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª) - ×œ××–×•×¨ ×”××™×©×™:</p>
                    <input type="tel" id="pin-field" maxlength="4" placeholder="____" class="w-full p-3 border-2 border-slate-100 rounded-xl text-center text-3xl font-black tracking-[0.5em] outline-none">
                </div>

                <div class="flex items-start gap-2 p-3 bg-slate-50 rounded-xl border border-slate-200 mt-4 text-right leading-none uppercase font-black uppercase tracking-tighter italic font-black uppercase tracking-tighter">
                    <input type="checkbox" id="check-v" class="mt-1 w-5 h-5 cursor-pointer">
                    <label class="text-[10px] text-slate-500 text-right leading-tight">×× ×™ ×××©×¨ ×©×”×§×•×“×™× ×©×”×–× ×ª×™ ×”× ×©×œ×™ ×‘×œ×‘×“ ×•×‘×”×ª×× <button onclick="toggleModal('terms-modal',true)" class="underline font-bold text-blue-600">×œ×ª× ××™ ×”×©×™×¨×•×ª</button>. ×”×›×¨×˜×™×¡ ×™×™× ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”.</label>
                </div>

                <button onclick="processFinalActivation()" class="w-full bg-blue-600 text-white font-black py-4 rounded-[1.8rem] shadow-xl text-xl mt-6 transition-all active:scale-95 uppercase tracking-widest italic font-black italic">×”×¤×¢×œ TipTap ğŸš€</button>
            </div>

            <!-- ×©×œ×‘ ×’: ×“×£ ×ª×©×œ×•× / ×›×¨×˜×™×¡ ×¤×¢×™×œ -->
            <div id="payment-screen" class="hidden flex-grow flex flex-col h-full text-center">
                <!-- ×›××Ÿ ×™×™×›× ×¡ ×”×ª×•×›×Ÿ ×©×œ ×”×›×¨×˜×™×¡ ×”×¤×¢×™×œ ×“×¨×š ×”-JS -->
            </div>

        </div>

        <!-- ×¦×•×¨ ×§×©×¨ ×‘×ª×—×ª×™×ª -->
        <div id="footer-contact" class="mt-auto pt-6 flex justify-center items-center gap-1 opacity-20 hover:opacity-100 transition-opacity">
            <a href="mailto:TIPTAP2026@GMAIL.COM" class="text-[10px] font-black text-slate-400 uppercase tracking-widest decoration-slate-300 underline-offset-4 underline italic uppercase font-black">âœ‰ï¸ ×¦×•×¨ ×§×©×¨ ×•×ª××™×›×” ×˜×›× ×™×ª</a>
        </div>
    </div>

    <!-- Modals -->
    <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4 backdrop-blur-md">
        <button onclick="toggleModal('guide-modal',false)" class="self-end text-white text-3xl mb-2">&times;</button>
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="max-w-full rounded-3xl border-4 border-white shadow-2xl">
    </div>

    <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm text-right leading-none uppercase font-black uppercase tracking-tighter italic font-black">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-6 modal-view">
            <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl">×©××œ×•×ª ×•×ª×©×•×‘×•×ª</h3><button onclick="toggleModal('faq-modal',false)" class="text-2xl text-slate-300">&times;</button></div>
            <div class="space-y-3 text-sm text-slate-600 overflow-y-auto max-h-[60vh] pr-1">
                <details class="bg-slate-50 p-4 rounded-xl border"><summary class="font-bold cursor-pointer">××™×š ××•×¦×™××™× QR ××‘×™×˜?</summary>
                    <p class="mt-2">×‘×™×˜ > 3 × ×§×•×“×•×ª ×œ××¢×œ×” > "×§×•×“ QR ×”×§×‘×•×¢ ×©×œ×™ ×œ×§×‘×œ×ª ×›×¡×£" > ×¦×œ××• ××¡×š.</p></details>
                <details class="bg-red-50 p-4 rounded-xl border border-red-100 text-red-600 font-bold"><summary class="cursor-pointer underline">×©×›×—×ª×™ ×§×•×“ ×¡×•×“×™?</summary>
                    <p class="mt-2 text-xs font-normal">×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨. ×‘××™×“×” ×•×©×›×—×ª×, ×œ× ×ª×•×›×œ×• ×œ××¤×¡ ××ª ×”×›×¨×˜×™×¡ ×•×ª×™××œ×¦×• ×œ×¨×›×•×© ×—×“×©. ×©××¨×• ××•×ª×• ×”×™×˜×‘!</p></details>
                <details class="bg-slate-50 p-4 rounded-xl border"><summary class="font-bold cursor-pointer">×”×× ×™×© ×¢××œ×•×ª?</summary>
                    <p class="mt-2 font-black italic text-right italic uppercase tracking-tighter">×œ×. ×”×›×¡×£ ×¢×•×‘×¨ ×‘-100% ×××›×•× ×ª ×”×œ×§×•×— ××œ×™×š ×œ×—×©×‘×•×Ÿ ×”××¤×œ×™×§×¦×™×”.</p></details>
                <details class="bg-slate-50 p-4 rounded-xl border"><summary class="font-bold cursor-pointer">×”×× ×”×¤×¨×˜×™× ×©×œ×™ ××•×’× ×™×?</summary>
                    <p class="mt-2 text-right">×× ×—× ×• ×©×•××¨×™× ×¨×§ ××ª ×§×™×©×•×¨ ×”×ª×©×œ×•× ×”×¦×™×‘×•×¨×™ ×©× ×•×¦×¨ ×‘××¤×œ×™×§×¦×™×•×ª. ××™×Ÿ ×œ× ×• ×’×™×©×” ×œ×‘× ×§ ×©×œ×›×.</p></details>
            </div>
            <button onclick="toggleModal('faq-modal',false)" class="w-full bg-slate-800 text-white py-4 rounded-2xl mt-8 font-bold">×¡×’×•×¨</button>
        </div>
    </div>

    <div id="terms-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-8 text-right modal-enter">
            <h3 class="font-black text-xl mb-4 border-b pb-4">×ª×§× ×•×Ÿ ×§×¦×¨</h3>
            <div class="text-xs text-slate-500 space-y-4">
                <p>â€¢ ×”×©×™×¨×•×ª × ×™×ª×Ÿ ×œ×œ× ××—×¨×™×•×ª ×œ×ª×§×œ×•×ª ×¦×“ ×’'.</p>
                <p>â€¢ ×”×›×¨×˜×™×¡ × × ×¢×œ ×œ××—×¨ ×”×¤×¢×œ×” (One-time Activate).</p>
                <p>â€¢ ××™×‘×•×“ ×”×§×•×“ ×”×¡×•×“×™ ×”×•× ×‘××—×¨×™×•×ª ×”××©×ª××©.</p>
                <p>â€¢ ×¨×©××™× ×œ×”×¤×¡×™×§ ×©×™×¨×•×ª ×‘×›×œ ×¢×ª.</p>
            </div>
            <button onclick="toggleModal('terms-modal',false)" class="w-full bg-blue-600 text-white py-4 rounded-xl mt-6 font-bold uppercase tracking-widest italic font-black uppercase">×”×‘× ×ª×™ ×•××™×©×¨×ª×™</button>
        </div>
    </div>

    <script>
        async function init() {
            if(!cardId) {
                document.getElementById('loader-view').innerHTML = '<p class="py-10 font-bold">× × ×œ×¡×¨×•×§ QR ×ª×§×™×Ÿ</p>';
                return;
            }
            document.getElementById('ui-card-id').innerText = `CARD #${cardId}`;
            if(urlParams.get('reset')) document.getElementById('reset-success').classList.remove('hidden');

            try {
                const r = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const d = await r.json();
                document.getElementById('loader-view').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');

                if (d.status === "ACTIVE") renderActiveContent(d);
            } catch(e) { 
                document.getElementById('loader-view').innerHTML = '<p class="text-red-500 font-bold p-10 text-center uppercase tracking-tighter">×—×™×‘×•×¨ ×œ×©×¨×ª × ×›×©×œ</p>';
            }
        }

        function showStep1() {
            document.getElementById('selection-screen').classList.remove('hidden');
            document.getElementById('registration-screen').classList.add('hidden');
        }

        function showStep2(mode) {
            activeMode = mode;
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('registration-screen').classList.remove('hidden');
            document.getElementById('row-qr').style.display = (mode === 'tip' ? 'block' : 'none');
            document.getElementById('row-link').style.display = (mode === 'link' ? 'block' : 'none');
        }

        async function processFinalActivation() {
            const nameField = document.getElementById('name-field');
            const pinField = document.getElementById('pin-field');
            const checkV = document.getElementById('check-v');
            const linkField = document.getElementById('link-field');

            if(!nameField.value || pinField.value.length !== 4 || !checkV.checked) {
                return alert("×× × ××œ× ×©×, 4 ×¡×¤×¨×•×ª ×§×•×“ ×•××©×¨ ××ª ×”×ª×§× ×•×Ÿ.");
            }

            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('loader-view').classList.remove('hidden');
            document.querySelector('#loader-view p').innerText = "××¢×‘×“ × ×ª×•× ×™× ×‘×©×¨×ª...";

            try {
                let bit = "", dir = "";
                if(activeMode === 'tip') {
                    if(!selectedBitFile) throw "×—×•×‘×” ×œ×”×¢×œ×•×ª ×¦×™×œ×•× ××¡×š";
                    bit = await scanQrCode(selectedBitFile);
                    if(!bit) throw "×œ× ××¦×× ×• QR ×‘×ª××•× ×”. × ×¡×” ×©×•×‘.";
                } else {
                    dir = linkField.value;
                    if(!dir) throw "×—×•×‘×” ×œ×”×“×‘×™×§ ×§×™×©×•×¨ ×œ×¢×¡×§";
                    if(!dir.startsWith('http')) dir = 'https://' + dir;
                }

                // Redirect ×œ×©××™×¨×” ×××•×‘×˜×—×ª
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${activeMode}&name=${encodeURIComponent(nameField.value)}&pin=${pinField.value}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(dir)}`;
            } catch(e) { 
                alert("×©×’×™××”: " + e); 
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('loader-view').classList.add('hidden');
            }
        }

        function renderActiveContent(d) {
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('payment-screen').classList.remove('hidden');
            document.getElementById('payment-screen').innerHTML = `
                <h1 class="text-3xl font-black text-slate-800 mb-1 uppercase italic italic tracking-tighter">×¤×¨×’×Ÿ ×œ${d.name}!</h1>
                <p class="text-slate-500 text-sm mb-10 italic font-bold">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×××•×‘×˜×— ×‘-bit</p>
                <button onclick="triggerLink('${d.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg shadow-blue-50 transform active:scale-95 transition-all mb-4">
                   <div class="flex items-center gap-4 italic font-black uppercase"><img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-10"><span>×ª×©×œ×•× ×‘-bit</span></div>
                   <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" stroke-linecap="round"/></svg>
                </button>
                ${d.type==='link' ? `<a href="${d.link}" target="_top" class="w-full bg-orange-500 text-white p-6 rounded-2xl text-xl font-black shadow-lg block italic uppercase italic tracking-widest text-center mb-10 italic tracking-tighter italic uppercase italic tracking-tighter italic font-black italic">×‘×™×§×•×¨ ×‘××ª×¨ ğŸš€</a>`:''}
                <div class="mt-8 bg-green-50 border border-green-200 rounded-2xl p-4 flex items-center justify-center gap-4">
                   <div class="bg-green-100 text-green-600 rounded-full p-1"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2.166 10.324a.75.75 0 01.666-1.292C6.197 10.885 10 10.885 13.168 9.032a.75.75 0 01.764 1.288c-3.583 2.095-7.965 2.095-11.766-.996zM10 1.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 1.5z"/></svg></div>
                   <span class="text-green-800 font-bold text-[10px]">ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×”×¡×ª×™×™××” â€¢ ×ª×©×œ×•× ××•×’×Ÿ</span>
                </div>
                <button onclick="toggleModal('psm', true)" class="mt-12 text-sm font-black text-blue-500 underline py-2 decoration-blue-200 uppercase tracking-widest">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button>
            `;
            
            // Stats modal inside container
            if(!document.getElementById('psm')){
               document.body.insertAdjacentHTML('beforeend', `
                <div id="psm" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                   <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-xs text-center shadow-2xl relative modal-enter">
                      <h3 class="font-black text-xl mb-4 italic text-slate-800 italic uppercase">××–×•×¨ ××™×©×™</h3>
                      <input type="tel" id="vp-in" placeholder="____" maxlength="4" class="w-full text-center text-4xl font-black p-4 border-2 border-slate-100 rounded-2xl mb-6 bg-slate-50 outline-none italic tracking-[0.5em] focus:border-blue-400">
                      <button id="vb-go" onclick="getVs()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl text-xl shadow-lg shadow-blue-100 uppercase tracking-widest italic font-black uppercase">×›× ×™×¡×”</button>
                      <button onclick="toggleModal('psm',false)" class="text-slate-300 mt-6 text-xs font-black uppercase tracking-tighter">×‘×™×˜×•×œ</button>
                      <div id="vo-out" class="mt-6 hidden bg-blue-50 p-6 rounded-3xl border border-blue-100"></div>
                   </div>
                </div>`);
            }
        }

        async function getVs() {
           const pin = document.getElementById('vp-in').value; if(pin.length!==4)return;
           document.getElementById('vb-go').innerText='×‘×•×“×§...';
           const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${pin}`);
           const d = await r.json(); document.getElementById('vb-go').innerText='×›× ×™×¡×”';
           const div = document.getElementById('vo-out'); div.classList.remove('hidden');
           if(d.success) div.innerHTML = `<p class='text-xs'>×¡×”"×› ×¡×¨×™×§×•×ª: <b class='text-xl text-blue-600 font-black italic tracking-widest'>${d.total}</b></p><p class='text-xs mt-2 italic font-black'>×××•×¦×¢ ×™×•××™: ${d.average}</p><button onclick="if(confirm('×œ××¤×¡?'))window.location.href='${API_URL}?action=reset&id=${cardId}&pin=${pin}'" class='text-red-500 font-bold underline mt-6 text-[10px] uppercase'>ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×”</button>`;
           else div.innerHTML = '×§×•×“ ×©×’×•×™ âŒ';
        }

        function toggleModal(i,s) { const el=document.getElementById(i); if(s){el.classList.remove('hidden');el.classList.add('flex');}else{el.classList.add('hidden');el.classList.remove('flex');} }
        function triggerLink(u) { const b=u.trim().startsWith('h')?u:'https://'+u; const w=window.open(b,'_blank'); if(!w || w.closed) window.top.location.href = b; }

        async function scanQrCode(f) {
           return new Promise(r=>{
              const reader = new FileReader(); reader.readAsDataURL(f);
              reader.onload = e=>{
                  const img = new Image(); img.src = e.target.result;
                  img.onload = ()=>{
                      const can=document.createElement('canvas'); const ct=can.getContext('2d');
                      const sc=Math.min(800/img.width, 800/img.height);
                      can.width=img.width*sc; can.height=img.height*sc;
                      ct.drawImage(img,0,0,can.width,can.height);
                      let q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                      if(!q) { ct.drawImage(img,0,img.height*0.25,img.width,img.height*0.5,0,0,can.width,can.height); q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height); }
                      r(q?q.data:null);
                  }
              }
           });
        }
        init();
    </script>
</body>
</html>
