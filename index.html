<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×”×“×¨×š ×”×§×œ×” ×œ×¤×¨×’×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-24 pb-12 text-right">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        const LOGO_TIPTAP = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg";
        const LOGO_BIT = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png";
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[500px]">
        
        <!-- Header -->
        <img id="main-logo-ui" src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" class="w-32 h-32 bg-white rounded-3xl mx-auto -mt-20 mb-4 shadow-2xl border-4 border-white object-cover">
        <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight uppercase">TipTap</h1>
        <p id="ui-card-id" class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest uppercase"></p>

        <div id="reset-banner" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>

        <div id="loader-view" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 font-bold">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>

        <div id="app-view" class="hidden flex-grow"></div>
    </div>

    <!-- Modals -->
    <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4">
        <button onclick="toggleModal('guide-modal', false)" class="self-end text-white text-3xl mb-2">&times;</button>
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="max-w-full max-h-[80vh] rounded-3xl border-4 border-white shadow-2xl">
    </div>

    <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-6 modal-enter text-right flex flex-col">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl">×¢×–×¨×”</h3><button onclick="toggleModal('faq-modal', false)" class="text-2xl">&times;</button></div>
            <div class="space-y-3 text-sm">
                <details class="bg-slate-50 p-3 rounded-xl"><summary class="font-bold">××™×š ××•×¦×™××™× QR ××‘×™×˜?</summary>×‘×™×˜ > ×©×œ×•×© × ×§×•×“×•×ª > "×§×•×“ QR ×”×§×‘×•×¢ ×©×œ×™" > ×¦×œ× ××¡×š.</details>
                <details class="bg-red-50 p-3 rounded-xl text-red-600"><summary class="font-bold">×©×›×—×ª×™ ×§×•×“ ×¡×•×“×™?</summary>×œ×œ× ×”×§×•×“ ×œ× × ×™×ª×Ÿ ×œ××¤×¡. ×ª×¦×˜×¨×š ×›×¨×˜×™×¡ ×—×“×©. ×¨×©×•× ××•×ª×• ×œ×¢×¦××š.</details>
            </div>
            <button onclick="toggleModal('faq-modal', false)" class="w-full bg-slate-800 text-white py-4 rounded-xl mt-6">×¡×’×•×¨</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let currentFile = null;

        async function init() {
            if (!cardId) {
                renderView('<h1 class="py-10 font-bold">×¡×¨×•×§ ×§×•×“ ××”×›×¨×˜×™×¡</h1>');
                return;
            }
            document.getElementById('ui-card-id').innerText = `CARD #${cardId}`;
            if(urlParams.get('reset')) document.getElementById('reset-banner').classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const data = await res.json();
                
                document.getElementById('loader-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');

                if (data.status === "ACTIVE") renderPayment(data);
                else renderSelection();
            } catch(e) { renderView('<p class="text-red-500 font-bold">×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª ×’×•×’×œ</p>'); }
        }

        function renderView(html) {
            document.getElementById('loader-view').classList.add('hidden');
            const el = document.getElementById('app-view');
            el.classList.remove('hidden');
            el.innerHTML = html;
        }

        function renderSelection() {
            document.getElementById('app-view').innerHTML = `
                <p class="text-sm font-bold text-slate-500 mb-6">×‘×—×¨ ××¡×œ×•×œ ×œ×”×¤×¢×œ×ª TipTap:</p>
                <button onclick="renderForm('tip')" class="w-full p-4 mb-3 border-2 border-blue-100 rounded-2xl flex items-center gap-4 bg-white transition-all hover:bg-blue-50 text-right group">
                    <div class="text-2xl group-hover:scale-110 transition-transform">ğŸ’°</div>
                    <div class="leading-none text-right"><span class="font-black text-blue-900 block">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-400 uppercase font-bold italic tracking-tighter italic">×—×™×‘×•×¨ ×œ-Bit</span></div>
                </button>
                <button onclick="renderForm('link')" class="w-full p-4 mb-8 border-2 border-orange-100 rounded-2xl flex items-center gap-4 bg-white transition-all hover:bg-orange-50 text-right group">
                    <div class="text-2xl group-hover:scale-110 transition-transform">ğŸš€</div>
                    <div class="leading-none text-right"><span class="font-black text-orange-900 block">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400 uppercase font-bold italic tracking-tighter italic font-black uppercase italic tracking-tighter italic font-black">××¢×‘×¨ ×™×©×™×¨ ×œ×§×™×©×•×¨</span></div>
                </button>
                <button onclick="toggleModal('guide-modal', true)" class="text-sm font-bold text-orange-600 underline decoration-orange-300">ğŸ“¸ ×”×“×¨×›×” ×œ×”×¤×¢×œ×”</button><br>
                <button onclick="toggleModal('faq-modal', true)" class="text-xs text-slate-400 mt-4 underline font-bold uppercase tracking-widest italic font-bold italic font-black italic">×©××œ×•×ª × ×¤×•×¦×•×ª</button>
            `;
        }

        function renderForm(mode) {
            document.getElementById('app-view').innerHTML = `
                <button onclick="renderSelection()" class="text-xs font-bold text-blue-500 mb-6 flex items-center">â† ×—×–×¨×”</button>
                <div class="space-y-4">
                    ${mode==='tip' ? `
                    <p class="text-xs font-bold text-slate-400 text-right">×”×¢×œ××ª ×§×•×“ ×”-QR ××‘×™×˜:</p>
                    <label id="upload-box" class="flex items-center gap-4 p-4 border-2 border-dashed border-blue-200 rounded-2xl bg-white cursor-pointer transition-all hover:bg-blue-50 text-right">
                        <img src="${LOGO_BIT}" class="w-10">
                        <span id="stxt" class="text-sm font-bold text-slate-500 italic">×‘×—×¨ ×¦×™×œ×•× ××¡×š...</span>
                        <input type="file" id="f-input" accept="image/*" class="hidden" onchange="handleFile(this)">
                    </label>` : `
                    <p class="text-xs font-bold text-slate-400 text-right italic uppercase font-black tracking-widest uppercase italic tracking-tighter italic">×”×“×‘×§ ×§×™×©×•×¨ (URL):</p>
                    <input type="url" id="link-input" placeholder="https://..." class="w-full p-4 border-2 border-slate-100 rounded-2xl bg-slate-50 text-left outline-none">`}
                    
                    <p class="text-xs font-bold text-slate-400 text-right mt-6 italic">×©× ×‘×¢×œ ×”×›×¨×˜×™×¡ (××‘×™ ×”××œ×š):</p>
                    <input type="text" id="name-input" placeholder="××‘×™ ×”××œ×š" class="w-full p-3 border-2 border-slate-100 rounded-xl bg-slate-50 font-bold outline-none text-right">
                    
                    <p class="text-xs font-bold text-slate-400 text-right mt-6 leading-tight uppercase font-black uppercase tracking-tighter italic font-black italic tracking-widest italic uppercase">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª) - ×œ××–×•×¨ ×”××™×©×™:</p>
                    <input type="tel" id="pin-input" maxlength="4" placeholder="____" class="w-full p-3 border-2 border-slate-100 rounded-xl text-center text-3xl font-black tracking-[0.5em] outline-none">
                    
                    <div class="flex items-start gap-2 bg-slate-100 p-3 rounded-xl">
                        <input type="checkbox" id="chk-terms" class="mt-1">
                        <label class="text-[10px] text-slate-400 text-right leading-tight">×§×¨××ª×™ ×•××™×©×¨×ª×™ ××ª ×”×ª×§× ×•×Ÿ. ×”×›×¨×˜×™×¡ × × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”.</label>
                    </div>

                    <button onclick="submitSave('${mode}')" class="w-full bg-blue-600 text-white font-black py-4 rounded-[2rem] shadow-xl mt-4 active:scale-95 italic transition-all">×”×¤×¢×œ TipTap ğŸš€</button>
                </div>
            `;
        }

        function handleFile(el) { if(el.files[0]) { currentFile = el.files[0]; document.getElementById('stxt').innerText = '×§×•×‘×¥ × ×‘×—×¨ âœ…'; document.getElementById('upload-box').classList.add('border-blue-500', 'bg-blue-50'); } }

        async function submitSave(mode) {
            const name = document.getElementById('name-input').value;
            const pin = document.getElementById('pin-input').value;
            const check = document.getElementById('chk-terms').checked;
            
            if(!name || pin.length !== 4 || !check) return alert("××œ× ×¤×¨×˜×™× ×ª×§×™× ×™× ×•××©×¨ ×ª×§× ×•×Ÿ");

            renderView('<div class="py-20 flex flex-col items-center"><div class="loader mb-4"></div><p class="font-bold text-blue-600">×©×•××¨ ×‘×©×¨×ª...</p></div>');

            try {
                let bit = "", link = "";
                if(mode==='tip') {
                   if(!currentFile) throw "× × ×œ×”×¢×œ×•×ª ×ª××•× ×”";
                   bit = await scanImage(currentFile);
                   if(!bit) throw "QR ×œ× ×–×•×”×”. × ×¡×” ×ª××•× ×” ××—×¨×ª.";
                } else {
                   link = document.getElementById('link-input').value;
                }
                
                // ×©×œ×™×—×” ×œ×©×¨×ª ×’×•×’×œ ×‘-REDIRECT (×¢×•×§×£ ×‘×¢×™×•×ª CORS ×‘×—×™× ××™)
                const saveUrl = `${API_URL}?action=save&id=${cardId}&type=${mode}&name=${encodeURIComponent(name)}&pin=${pin}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(link)}`;
                window.location.href = saveUrl;
                
            } catch(e) { alert("×©×’×™××”: " + e); renderSelection(); }
        }

        function renderPayment(data) {
            document.getElementById('app-view').innerHTML = `
                <h1 class="text-2xl font-black text-slate-800 mb-1 italic">×¤×¨×’×Ÿ ×œ${data.name}!</h1>
                <p class="text-slate-400 text-sm mb-10 tracking-tight italic">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×××•×‘×˜×— ×‘-bit</p>
                
                <button onclick="openDeep('${data.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-4 rounded-2xl flex items-center justify-between shadow-lg active:scale-95 transition-all mb-4">
                   <div class="flex items-center gap-4"><img src="${LOGO_BIT}" class="w-10 h-10 object-contain"><span class="text-xl font-bold tracking-tight">×ª×©×œ×•× ×‘-bit</span></div>
                   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7" stroke-linecap="round"/></svg>
                </button>
                
                ${data.type==='link' ? `<a href="${data.link}" target="_top" class="w-full bg-orange-500 text-white p-5 rounded-2xl text-xl font-black shadow-lg block italic uppercase tracking-tighter mb-10">×‘×™×§×•×¨ ×‘××ª×¨ ğŸš€</a>` : ''}

                <div class="mt-8 bg-green-50 border border-green-100 rounded-xl p-3 flex items-center justify-center gap-3">
                   <span class="text-green-700 font-bold text-[10px] italic">ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×”×¡×ª×™×™××” ×‘×”×¦×œ×—×” â€¢ ×ª×©×œ×•× ××•×’×Ÿ</span>
                </div>

                <div class="mt-10"><button onclick="showS()" class="text-xs font-bold text-blue-500 underline py-2 decoration-blue-200">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button></div>
            `;
            
            if(!document.getElementById('v-modal')) {
               document.body.insertAdjacentHTML('beforeend', `
               <div id="v-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                  <div class="bg-white rounded-[2rem] p-6 w-full max-w-xs text-center shadow-2xl relative">
                     <h3 class="font-black mb-4 border-b pb-4 text-right italic text-slate-800 italic uppercase italic tracking-tighter italic">×›× ×™×¡×” ×œ××–×•×¨ ××™×©×™</h3>
                     <input type="tel" id="v-pin" placeholder="×§×•×“ ×¡×•×“×™" maxlength="4" class="w-full text-center text-4xl font-black p-4 border-2 border-slate-100 rounded-xl mb-4 focus:border-blue-400 outline-none italic tracking-widest uppercase italic font-bold">
                     <button id="s-btn" onclick="runStats()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg shadow-blue-100">×›× ×™×¡×”</button>
                     <button onclick="toggleModal('v-modal', false)" class="text-[10px] text-slate-300 mt-6 font-bold tracking-widest italic underline decoration-slate-200">×¡×’×•×¨</button>
                     <div id="s-res" class="mt-6 hidden bg-blue-50 p-4 rounded-2xl"></div>
                  </div>
               </div>`);
            }
        }

        async function runStats() {
           const pin = document.getElementById('v-pin').value;
           if(pin.length!==4) return;
           document.getElementById('s-btn').innerText = '×‘×•×“×§...';
           const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${pin}`);
           const d = await r.json();
           document.getElementById('s-btn').innerText = '×›× ×™×¡×”';
           const div = document.getElementById('s-res'); div.classList.remove('hidden');
           if(d.success) {
               div.innerHTML = `<p class="text-xs text-slate-500">×¡×”"×› ×¡×¨×™×§×•×ª: <b class="text-blue-600 text-xl font-black">${d.total}</b></p><p class="text-xs mt-2 border-t pt-2 text-slate-500">×××•×¦×¢ ×œ×™×•×: <b class="text-blue-600 text-lg">${d.average}</b></p><button onclick="window.location.href='${API_URL}?action=reset&id=${cardId}&pin=${pin}'" class="mt-8 text-red-500 text-[10px] font-bold underline opacity-50 italic">ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×ª ×§×™×©×•×¨×™×</button>`;
           } else div.innerHTML = '<span class="text-red-600 font-bold italic tracking-tighter italic">×§×•×“ ×©×’×•×™</span>';
        }

        function toggleModal(id, show) { const m = document.getElementById(id); m.classList.toggle('hidden', !show); m.classList.toggle('flex', show); }
        function openDeep(url) { if(!url) return; const bit = url.trim().toLowerCase().startsWith('h') ? url : 'https://'+url; const w = window.open(bit, '_blank'); if(!w || w.closed) window.top.location.href = bit; }
        function showS() { toggleModal('v-modal', true); }

        async function scanImage(file) {
            return new Promise(r => {
                const reader = new FileReader(); reader.readAsDataURL
