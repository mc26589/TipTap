<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×”×“×¨×š ×”×§×œ×” ×œ×¤×¨×’×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-24 pb-12 text-right">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let selectedFile = null;
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[500px]">
        
        <!-- Header ×§×‘×•×¢ -->
        <div id="static-header">
            <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" 
                 class="w-32 h-32 bg-white rounded-3xl mx-auto -mt-24 mb-4 shadow-2xl border-4 border-white object-cover">
            <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight uppercase">TipTap</h1>
            <p id="card-label" class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest uppercase"></p>
        </div>

        <!-- ×”×•×“×¢×ª ××™×¤×•×¡ -->
        <div id="reset-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>

        <!-- ×˜×•×¢×Ÿ -->
        <div id="boot-loader" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 font-bold tracking-widest">×‘×•×“×§ × ×ª×•× ×™×...</p>
        </div>

        <!-- ×ª×•×›×Ÿ ××ª×—×œ×£ -->
        <div id="view-content" class="hidden flex-grow flex flex-col"></div>
    </div>

    <!-- Modals -->
    <div id="modals-container">
        <!-- FAQ Modal -->
        <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-[2rem] w-full max-w-md p-6 flex flex-col max-h-[85vh] modal-enter">
                <div class="flex justify-between items-center mb-4"><h3 class="font-black text-xl">×©××œ×•×ª × ×¤×•×¦×•×ª</h3><button onclick="toggleM('faq-modal',false)" class="text-2xl text-slate-300">&times;</button></div>
                <div class="space-y-3 overflow-y-auto text-sm pr-1">
                    <details class="bg-slate-50 p-3 rounded-xl border"><summary class="font-bold cursor-pointer text-right">××™×š ××•×¦×™××™× QR ×-Bit?</summary>
                        <p class="mt-2 text-right">×”×™×›× ×¡×• ×œ××¤×œ×™×§×¦×™×” > 3 × ×§×•×“×•×ª ("×¢×•×“") > "×§×•×“ ×”-QR ×”×§×‘×•×¢ ×©×œ×™ ×œ×§×‘×œ×ª ×›×¡×£" > ×¦×œ××• ××¡×š ×•×”×¢×œ×•.</p>
                    </details>
                    <details class="bg-red-50 p-3 rounded-xl text-red-600 border border-red-100"><summary class="font-bold cursor-pointer text-right">×©×›×—×ª×™ ××ª ×”×§×•×“ ×”×¡×•×“×™?</summary>
                        <p class="mt-2 text-right text-xs">××˜×¢××™ ××‘×˜×—×” ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ×§×•×“ ×©××‘×“. ×× ×©×›×—×ª×, ×œ× ×ª×•×›×œ×• ×œ××¤×¡ ××ª ×”×›×¨×˜×™×¡ ×•×ª×™×“×¨×©×• ×œ×¨×›×•×© ×›×¨×˜×™×¡ ×—×“×©.</p>
                    </details>
                    <details class="bg-slate-50 p-3 rounded-xl border"><summary class="font-bold cursor-pointer text-right">×”×× ×”×©×™×¨×•×ª ×¢×•×œ×” ×›×¡×£?</summary>
                        <p class="mt-2 text-right"><b>×œ×.</b> ×”××•×ª×’ TipTap ×œ× ×’×•×‘×” ×¢××œ×” ×¢×œ ×”×˜×™×¤×™× ×©×œ×š. ×”×›×¡×£ ×¢×•×‘×¨ ×‘-100% ×™×©×™×¨×•×ª ××œ×™×š ×œ×‘×™×˜.</p>
                    </details>
                </div>
                <button onclick="toggleM('faq-modal',false)" class="w-full bg-slate-800 text-white py-4 rounded-2xl mt-6 font-bold shadow-lg">×¡×’×•×¨</button>
            </div>
        </div>

        <!-- Guide Modal -->
        <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4 backdrop-blur-md">
            <button onclick="toggleM('guide-modal',false)" class="self-end text-white text-3xl mb-2">&times;</button>
            <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="max-w-full max-h-[80vh] rounded-3xl border-2 border-white">
        </div>

        <!-- Terms Modal -->
        <div id="terms-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-[2rem] w-full max-w-md p-8 text-right modal-enter shadow-2xl border">
                <h3 class="font-black text-xl mb-4 text-slate-800 border-b pb-4 tracking-tighter italic">×ª×§× ×•×Ÿ ×•×ª× ××™ ×©×™××•×©</h3>
                <div class="text-xs text-slate-500 space-y-4 leading-relaxed italic font-bold italic font-black">
                    <p>â€¢ ×”×©×™×¨×•×ª × ×™×ª×Ÿ ×œ×œ× ××—×¨×™×•×ª ×œ×©×™×‘×•×©×™× ×¦×“ ×’' (Bit).</p>
                    <p>â€¢ ×”×›×¨×˜×™×¡ × × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”. ××™×‘×•×“ ×§×•×“ ×¡×•×“×™ ×™×“×¨×•×© ×›×¨×˜×™×¡ ×—×“×©.</p>
                    <p>â€¢ ×”××¢×¨×›×ª ×¨×©××™×ª ×œ×”×¤×¡×™×§ ××ª ×”×©×™×¨×•×ª ×‘×›×œ ×¢×ª.</p>
                </div>
                <button onclick="toggleM('terms-modal', false)" class="w-full bg-blue-600 text-white py-4 rounded-2xl mt-8 font-bold">×¡×’×•×¨ ×•××™×©×•×¨</button>
            </div>
        </div>
    </div>

    <script>
        async function init() {
            if(!cardId) { showView('<h1 class="py-10 font-bold">×¡×¨×•×§ ×§×•×“ ××”×›×¨×˜×™×¡</h1>'); return; }
            document.getElementById('card-label').innerText = `CARD #${cardId}`;
            if(urlParams.get('reset')) document.getElementById('reset-success').classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const data = await res.json();
                
                document.getElementById('boot-loader').classList.add('hidden');
                document.getElementById('view-content').classList.remove('hidden');

                if (data.status === "ACTIVE") renderActive(data);
                else renderPick();
            } catch(e) {
                showView('<p class="text-red-500 font-bold">×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª</p>');
            }
        }

        function showView(html) {
            document.getElementById('boot-loader').classList.add('hidden');
            const v = document.getElementById('view-content');
            v.innerHTML = html;
            v.classList.remove('hidden');
        }

        function renderPick() {
            showView(`
                <p class="text-sm font-bold text-slate-500 mb-6 italic tracking-tight text-center uppercase">××” ×”-TipTap ×©×œ×š ×™×¢×©×”?</p>
                <button onclick="renderFinalForm('tip')" class="w-full p-4 mb-4 border-2 border-blue-100 rounded-2xl flex items-center gap-4 bg-white hover:border-blue-500 transition-all text-right group shadow-sm shadow-blue-50 italic">
                    <div class="text-3xl italic">ğŸ’°</div>
                    <div class="leading-none text-right font-black italic"><span class="font-black text-blue-900 block uppercase italic">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-500 italic font-black">×—×™×‘×•×¨ ×œ-Bit</span></div>
                </button>
                <button onclick="renderFinalForm('link')" class="w-full p-4 mb-10 border-2 border-orange-100 rounded-2xl flex items-center gap-4 bg-white hover:border-orange-500 transition-all text-right group shadow-sm shadow-orange-50">
                    <div class="text-3xl italic text-right italic font-black uppercase">ğŸš€</div>
                    <div class="leading-none text-right font-black italic tracking-tighter"><span class="font-black text-orange-900 block italic uppercase">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400 italic">×§×™×©×•×¨ ×™×©×™×¨ ×œ××ª×¨</span></div>
                </button>
                <div class="flex flex-col gap-3">
                    <button onclick="toggleM('guide-modal', true)" class="text-sm font-bold text-orange-600 underline text-center block w-full decoration-orange-300 transition-all italic">ğŸ“¸ ×”×“×¨×›×” ×¢×œ ×”×”×¤×¢×œ×”</button>
                    <button onclick="toggleM('faq-modal', true)" class="text-xs text-slate-400 underline font-bold uppercase tracking-widest text-center italic decoration-slate-300 transition-all italic">×¢×–×¨×” ×•×©××œ×•×ª × ×¤×•×¦×•×ª</button>
                </div>
            `);
        }

        function renderFinalForm(mode) {
            showView(`
                <button onclick="renderPick()" class="text-xs font-bold text-blue-500 mb-6 underline flex items-center italic">â† ×—×–×¨×” ×œ×‘×—×™×¨×”</button>
                <div class="space-y-5 text-right flex flex-col">
                    ${mode==='tip' ? `
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-2 italic">×§×•×“ ×”-QR ×©×œ×š ××‘×™×˜:</p>
                    <label id="upbox" class="flex items-center gap-4 p-5 border-2 border-dashed border-blue-200 rounded-[1.5rem] bg-white cursor-pointer hover:bg-blue-50">
                        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-8">
                        <span id="stext" class="text-sm font-bold text-slate-400 italic font-black tracking-tighter italic">×œ×—×¥ ×œ×‘×—×™×¨×ª ×¦×™×œ×•× ××¡×š...</span>
                        <input type="file" id="input-f" accept="image/*" class="hidden" onchange="selectedFile=this.files[0];document.getElementById('stext').innerText='×§×•×‘×¥ × ×‘×—×¨ âœ…';">
                    </label></div>` : `
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-2 italic font-black tracking-widest italic tracking-widest italic">×”×“×‘×§ ×§×™×©×•×¨ (URL):</p>
                    <input type="url" id="link-field" placeholder="https://..." class="w-full p-4 border-2 border-slate-100 rounded-2xl bg-slate-50 text-left outline-none font-mono focus:border-orange-500"></div>`}
                    
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-1 italic font-black uppercase">×©× ×‘×¢×œ ×”×›×¨×˜×™×¡:</p>
                    <input type="text" id="name-field" placeholder="×“×•×’××”: ××‘×™ ×”××œ×š ğŸ‘‘" class="w-full p-4 border-2 border-slate-100 rounded-xl bg-slate-50 italic font-black focus:border-blue-400 outline-none text-right"></div>
                    
                    <div><p class="text-xs font-black text-slate-400 mr-1 mb-1 italic font-black tracking-tighter uppercase leading-none italic uppercase">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª) - ×œ××–×•×¨ ×”××™×©×™:</p>
                    <input type="tel" id="pin-field" maxlength="4" placeholder="____" class="w-full p-4 border-2 border-slate-100 rounded-xl text-center text-4xl font-black tracking-[0.5em] outline-none"></div>

                    <div class="flex items-start gap-2 p-3 bg-slate-50 rounded-xl">
                        <input type="checkbox" id="check-v" class="mt-1">
                        <label class="text-[10px] text-slate-500 text-right leading-tight italic uppercase tracking-tighter italic font-black italic">×× ×™ ×××©×¨ ××ª <button onclick="toggleM('terms-modal',true)" class="underline font-bold text-blue-600 uppercase">×”×ª×§× ×•×Ÿ</button>. ×™×“×•×¢ ×œ×™ ×©×”×›×¨×˜×™×¡ ×™×™× ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”.</label>
                    </div>

                    <button onclick="submitTipTap('${mode}')" class="w-full bg-blue-600 text-white font-black py-5 rounded-[1.8rem] shadow-xl text-xl mt-4 active:scale-95 italic transition-all italic tracking-tighter italic uppercase italic tracking-widest italic font-black">×”×¤×¢×œ TipTap ğŸš€</button>
                </div>
            `);
        }

        async function submitTipTap(mode) {
            const nameEl = document.getElementById('name-field');
            const pinEl = document.getElementById('pin-field');
            const checkEl = document.getElementById('check-v');

            if(!nameEl.value || pinEl.value.length !== 4 || !checkEl.checked) return alert("××œ× ×¤×¨×˜×™× ×ª×§×™× ×™× ×•××©×¨ ×ª×§× ×•×Ÿ");

            showView('<div class="py-20 flex flex-col items-center"><div class="loader mb-4"></div><p class="font-black text-blue-600 animate-pulse italic uppercase tracking-tighter">××¢×‘×“ ×•××’×“×™×¨...</p></div>');

            try {
                let bit = "", dir = "";
                if (mode === 'tip') {
                    if(!selectedFile) throw "×”×¢×œ×” ×¦×™×œ×•× ××¡×š ×©×œ ×‘×™×˜";
                    bit = await scanQRNow(selectedFile);
                    if(!bit) throw "QR ×œ× ×–×•×”×”. × ×¡×” ×ª××•× ×” ××—×¨×ª.";
                } else {
                    dir = document.getElementById('link-field').value;
                }
                
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${mode}&name=${encodeURIComponent(nameEl.value)}&pin=${pinEl.value}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(dir)}`;
            } catch(e) { alert("×©×’×™××”: " + e); init(); }
        }

        function renderActive(d) {
            showView(`
                <h1 class="text-3xl font-black text-slate-800 mb-1 italic tracking-tight">×¤×¨×’×Ÿ ×œ${d.name}!</h1>
                <p class="text-slate-500 text-sm mb-10 italic font-bold">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×××•×‘×˜×— ×‘-bit</p>
                
                <button onclick="forceOpenBit('${d.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg active:scale-95 transition-all mb-4">
                    <div class="flex items-center gap-4"><img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-12 h-12 object-contain"><span class="text-2xl font-black">×ª×©×œ×•× ×‘-bit</span></div>
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" stroke-linecap="round"/></svg>
                </button>
                
                ${d.type==='link' ? `<a href="${d.link}" target="_top" class="w-full bg-orange-500 text-white p-6 rounded-2xl text-xl font-black shadow-lg block italic uppercase italic tracking-tighter italic tracking-widest italic font-black uppercase text-center italic tracking-widest italic">×‘×™×§×•×¨ ×‘××ª×¨ ğŸš€</a>`:''}

                <div class="mt-10 bg-green-50 border border-green-100 rounded-2xl p-4 flex items-center justify-center gap-4">
                    <span class="text-green-700 font-bold text-xs uppercase font-black uppercase italic italic">ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×‘×•×¦×¢×” ×‘×”×¦×œ×—×” â€¢ ×ª×©×œ×•× ××•×’×Ÿ</span>
                </div>
                
                <button onclick="toggleM('stats-v-m',true)" class="mt-14 text-sm text-blue-500 underline font-black p-2 italic">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button>
                <div class="mt-4"><a href="mailto:TIPTAP2026@GMAIL.COM" class="text-xs text-slate-300">âœ‰ï¸ ×¦×•×¨ ×§×©×¨</a></div>
            `);

            if(!document.getElementById('stats-v-m')){
                document.body.insertAdjacentHTML('beforeend', `
                <div id="stats-v-m" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                   <div class="bg-white rounded-[2rem] p-8 w-full max-w-xs text-center shadow-2xl relative modal-enter">
                      <h3 class="font-black text-xl mb-4 italic tracking-widest uppercase italic font-black uppercase italic tracking-tighter italic border-b pb-4 text-right">××–×•×¨ ××™×©×™</h3>
                      <input type="tel" id="v-pin-in" placeholder="×§×•×“ ×¡×•×“×™" maxlength="4" class="w-full text-center text-4xl font-black p-4 border-2 rounded-xl mb-4 focus:border-blue-400 outline-none italic tracking-[0.5em]">
                      <button id="st-btn" onclick="getStatsV()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl text-xl italic font-black shadow-xl">×›× ×™×¡×”</button>
                      <button onclick="toggleM('stats-v-m', false)" class="text-xs text-slate-300 mt-6 underline font-bold italic tracking-tighter italic font-black uppercase">×¡×’×•×¨</button>
                      <div id="stats-out" class="mt-6 hidden bg-blue-50 p-4 rounded-xl border border-blue-100 text-center italic uppercase italic tracking-tighter"></div>
                   </div>
                </div>`);
            }
        }

        async function getStatsV() {
            const pin = document.getElementById('v-pin-in').value;
            if(pin.length!==4) return;
            document.getElementById('st-btn').innerText = '×‘×•×“×§...';
            try {
                const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${pin}`);
                const d = await r.json();
                document.getElementById('st-btn').innerText = '×›× ×™×¡×”';
                const out = document.getElementById('stats-out'); out.classList.remove('hidden');
                if(d.success) {
                   out.innerHTML = `<div class="space-y-4"><div><p class="text-xs text-slate-400">×¡×¨×™×§×•×ª:</p><p class="text-3xl font-black text-blue-600">${d.total}</p></div><button onclick="if(confirm('×œ××¤×¡?')){window.location.href='${API_URL}?action=reset&id=${cardId}&pin=${pin}'}" class="mt-4 text-red-500 font-bold underline italic text-xs italic tracking-widest italic font-black uppercase italic">ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×”</button></div>`;
                } else out.innerHTML = '×§×•×“ ×©×’×•×™ âŒ';
            } catch(e){ alert("×©×’×™××ª ×¨×©×ª"); }
        }

        function toggleM(id, s) { const el=document.getElementById(id); el.classList.toggle('hidden', !s); el.classList.toggle('flex', s); }
        function forceOpenBit(url) { 
            const u = url.trim().toLowerCase().startsWith('h') ? url : 'https://'+url; 
            const w=window.open(u, '_blank'); 
            if(!w || w.closed) window.top.location.href = u; 
        }

        async function scanQRNow(f) {
           return new Promise(r=>{
               const reader = new FileReader(); reader.readAsDataURL(f);
               reader.onload = e=>{
                   const im = new Image(); im.src = e.target.result;
                   im.onload = ()=>{
                       const can=document.createElement('canvas'); const ct=can.getContext('2d');
                       const s = Math.min(800/im.width, 800/im.height);
                       can.width=im.width*s; can.height=im.height*s;
                       ct.drawImage(im, 0, 0, can.width, can.height);
                       let q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                       if(!q){
                          ct.drawImage(im,0,im.height*0.25,im.width,im.height*0.5,0,0,can.width,can.height);
                          q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                       }
                       r(q?q.data:null);
                   }
               }
           });
        }
        init();
    </script>
</body>
</html>
