<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipTap | ×”×›×¨×˜×™×¡ ×”×—×›×</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Heebo', sans-serif;
            background: #f0f4f8;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.05);
        }

        .fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loader-ring {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .btn-press:active {
            transform: scale(0.97);
            transition: 0.1s;
        }

        details>summary {
            list-style: none;
            outline: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        .toast-visible {
            opacity: 1 !important;
            transform: translate(-50%, 0) !important;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Toast Notification -->
    <div id="toast-container"
        class="fixed top-8 left-1/2 -translate-x-1/2 z-[100] transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none">
        <div id="toast-body"
            class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[200px] justify-center backdrop-blur-md">
            <span id="toast-icon">â„¹ï¸</span>
            <span id="toast-message" class="text-sm font-bold">×”×•×“×¢×”</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="glass w-full max-w-md rounded-[2.5rem] p-8 text-center relative flex flex-col min-h-[550px]">

        <header class="mb-4 z-10 relative">
            <div
                class="w-24 h-24 bg-white rounded-[1.5rem] mx-auto -mt-20 mb-3 shadow-xl border-4 border-white overflow-hidden">
                <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" id="logo-img"
                    class="w-full h-full object-cover">
            </div>
            <h1 class="text-3xl font-black text-slate-800 italic uppercase tracking-tight">TipTap</h1>
            <p id="ui-id" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] mt-1 uppercase">Loading...</p>
        </header>

        <!-- Loader -->
        <div id="loader-view" class="flex-grow flex flex-col items-center justify-center py-10 space-y-3">
            <div class="loader-ring"></div>
            <p id="loader-text" class="text-xs font-bold text-slate-400 animate-pulse">××ª×—×‘×¨ ×œ×©×¨×ª...</p>
        </div>

        <!-- 1. Intro View -->
        <div id="intro-view" class="hidden flex-col gap-4 fade-in-up px-1 text-right mt-1">

            <!-- About Section -->
            <div class="bg-white/60 rounded-[1.5rem] p-5 border border-white scroll-card mb-2 shadow-sm">
                <h2 class="text-center font-black text-slate-800 text-xl tracking-tight mb-4">
                    ×”×¤×¢×œ ×›×¨×˜×™×¡ <span
                        class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">TipTap</span>
                </h2>

                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2">××” ×–×” ×”×›×¨×˜×™×¡?</h3>

                <div class="space-y-3">
                    <p class="text-sm font-medium text-slate-600 leading-relaxed">
                        ×”×›×¨×˜×™×¡ ×”×—×›× ×”×•× ×”×××©×§ ×”××”×™×¨ ×•×”× ×•×— ×‘×™×•×ª×¨ ×œ×§×‘×œ×ª ×˜×™×¤×™× ×™×©×™×¨×•×ª ×œ×‘×™×˜, ×œ×œ× ×¦×•×¨×š ×‘××¤×œ×™×§×¦×™×” ××• ×¡×¨×™×§×•×ª
                        ××¡×•×¨×‘×œ×•×ª.
                    </p>

                    <div class="bg-blue-50/50 p-3 rounded-xl border border-blue-100/50">
                        <p class="text-[11px] text-slate-500 leading-relaxed">
                            ×›×™×•× ×œ×¨×•×‘ ×”×× ×©×™× ××™×Ÿ ××–×•××Ÿ. ×”×›×¨×˜×™×¡ ×¤×•×ª×¨ ××ª ×‘×¢×™×™×ª "×”××™×Ÿ ×¢×œ×™×™" ×•×—×•×¡×š ××ª ×”×¡×™×¨×‘×•×œ ×©×œ ×”×—×œ×¤×ª
                            ××¡×¤×¨×™×.
                        </p>
                    </div>

                    <div
                        class="flex items-center gap-3 bg-green-50 p-3 rounded-xl border border-green-100 shadow-sm transform hover:scale-[1.02] transition-transform">
                        <span class="text-xl">ğŸ“ˆ</span>
                        <div>
                            <span class="block text-[10px] font-bold text-green-600 uppercase tracking-wide">× ×ª×•×Ÿ
                                ××•×›×—</span>
                            <span class="text-xs font-bold text-slate-700">×”×’×“×œ×ª ×›××•×ª ×”×˜×™×¤×™× ×‘-<span
                                    class="font-black text-green-600 text-sm">30%</span> ×‘×™×•×!</span>
                        </div>
                    </div>
                </div>

                <button onclick="toggleModal('guide-modal', true)"
                    class="btn-press w-full bg-slate-800 text-white font-bold py-3 rounded-xl text-sm mt-5 shadow-lg shadow-slate-200 flex items-center justify-center gap-2 hover:bg-slate-700 transition-colors">
                    <span>ğŸ¥</span> <span>×œ×—×¦×• ×›××Ÿ ×œ××“×¨×™×š ×”×”×¤×¢×œ×”</span>
                </button>
            </div>

            <div class="space-y-3">
                <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest text-center mb-1">×‘×—×¨×• ××¡×œ×•×œ
                    ×œ×”××©×š</p>

                <button onclick="goToSetup('tip')"
                    class="btn-press bg-white border border-blue-100 p-3 rounded-2xl flex items-center gap-3 hover:border-blue-300 hover:shadow-md transition-all w-full group relative overflow-hidden">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-blue-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <div class="text-2xl bg-blue-50 p-2.5 rounded-xl z-10 shrink-0">ğŸ’°</div>
                    <div class="z-10 grow text-right">
                        <span class="block font-black text-slate-800 text-base">××¡×œ×•×œ ×¤×¨×’×•×Ÿ ×‘×˜×™×¤</span>
                        <span class="text-xs text-slate-500 font-bold">×œ×©×œ×™×—×™× ×•××œ×¦×¨×™× (×—×™×‘×•×¨ ×œ-Bit / PayBox)</span>
                    </div>
                    <div class="text-blue-400 font-bold px-2 z-10">âœ</div>
                </button>

                <button onclick="goToSetup('link')"
                    class="btn-press bg-white border border-orange-100 p-3 rounded-2xl flex items-center gap-3 hover:border-orange-300 hover:shadow-md transition-all w-full group relative overflow-hidden">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-orange-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <div class="text-2xl bg-orange-50 p-2.5 rounded-xl z-10 shrink-0">ğŸš€</div>
                    <div class="z-10 grow text-right">
                        <span class="block font-black text-slate-800 text-base">××¡×œ×•×œ ×¢×¡×§×™</span>
                        <span class="text-xs text-slate-500 font-bold">×§×™×©×•×¨ ×œ××ª×¨ / ××™× ×¡×˜×’×¨×</span>
                    </div>
                    <div class="text-orange-400 font-bold px-2 z-10">âœ</div>
                </button>
            </div>

            <div class="mt-4 text-center">
                <button onclick="toggleModal('faq-modal', true)"
                    class="text-[11px] font-bold text-slate-400 hover:text-slate-600 transition-colors flex items-center justify-center gap-1 mx-auto">
                    <span>â“</span> <span>×©××œ×•×ª × ×¤×•×¦×•×ª ×•×¢×–×¨×”</span>
                </button>
            </div>
        </div>

        <!-- 2. Setup Form -->
        <div id="setup-form-view" class="hidden fade-in-up flex-col gap-3 text-right">
            <button onclick="backToIntro()"
                class="text-[10px] font-bold text-slate-500 w-fit mb-2 bg-slate-100 px-3 py-1 rounded-full">âœ
                ×—×–×¨×”</button>
            <h2 id="setup-title" class="text-xl font-black text-slate-800 mb-2">×”×’×“×¨×ª × ×ª×•× ×™×</h2>

            <div id="input-group-bit" class="hidden space-y-4">
                <!-- Bit Section -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-xs font-bold text-slate-500">×”×¢×œ××ª QR (××‘×™×˜)</p>
                        <button onclick="toggleModal('guide-modal', true)"
                            class="text-[10px] font-bold text-blue-500 underline decoration-blue-200">××™×š ××•×¦××™×?
                            ×œ××“×¨×™×š</button>
                    </div>
                    <label id="bit-label"
                        class="flex flex-col items-center justify-center h-24 border-2 border-dashed border-blue-200 bg-blue-50/50 rounded-2xl cursor-pointer hover:bg-blue-50 transition-colors">
                        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png"
                            class="w-6 opacity-60 mb-2">
                        <span id="bit-text" class="text-[10px] font-bold text-blue-400 uppercase tracking-wide">×œ×—×¥
                            ×œ×‘×—×™×¨×ª
                            ×§×•×‘×¥</span>
                        <input type="file" id="fixed-file-input" class="hidden" accept="image/*"
                            onchange="handleFileSelect(this)">
                    </label>
                </div>

                <!-- PayBox Section -->
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-xs font-bold text-slate-500">×§×™×©×•×¨ ×œ-PayBox</p>
                        <button onclick="toggleModal('paybox-guide-modal', true)"
                            class="text-[10px] font-bold text-blue-500 underline decoration-blue-200">××™×š ××•×¦××™×?
                            ×œ××“×¨×™×š</button>
                    </div>
                    <div class="relative">
                        <input type="url" id="paybox-input" dir="ltr" placeholder="https://payboxapp.page.link/..."
                            class="w-full p-4 pl-12 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-blue-400 transition-colors">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/9/97/PayBox_Logo.png"
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 object-contain opacity-50">
                    </div>
                </div>
            </div>

            <div id="input-group-link" class="hidden">
                <p class="text-xs font-bold text-slate-500 mb-1">×›×ª×•×‘×ª ×”×§×™×©×•×¨ (URL)</p>
                <input type="url" id="fixed-link-input" dir="ltr" placeholder="www.yoursite.com"
                    class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none">
            </div>

            <div>
                <p class="text-xs font-bold text-slate-500 mb-1 mt-2">×©× ××œ×</p>
                <input type="text" id="fixed-name-input" placeholder="×œ××©×œ: ×“× ×™××œ"
                    class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none text-right">
            </div>

            <div>
                <p class="text-xs font-bold text-slate-500 mb-1 mt-2">×‘×—×¨ ×§×•×“ ××™×©×™ ×œ× ×™×”×•×œ ×”×›×¨×˜×™×¡</p>
                <input type="tel" id="fixed-pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢"
                    class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-black text-center text-xl tracking-[0.5em] outline-none mb-1">
                <p class="text-[10px] text-slate-400 leading-tight">* ×”×§×•×“ ××©××© ×¨×§ ×œ××‘×˜×—×ª ×”×›×¨×˜×™×¡ ×©×œ×›× ×‘-TipTap ×•××™×Ÿ ×œ×•
                    ×©×•× ×§×©×¨ ×œ×‘×™×˜.</p>
            </div>

            <button onclick="preValidateSave()"
                class="btn-press w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl text-sm mt-3 flex items-center justify-center gap-2">
                <span>×©××•×¨ ×•×”×¤×¢×œ ×›×¨×˜×™×¡</span><span>ğŸš€</span>
            </button>
        </div>

        <!-- 2.5 Success View -->
        <div id="success-view" class="hidden fade-in-up flex-col items-center justify-center text-center h-full py-10">
            <div
                class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-green-50 animate-bounce">
                <span class="text-4xl">âœ¨</span>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">×”×›×¨×˜×™×¡ ×”×•×¤×¢×œ ×‘×”×¦×œ×—×”!</h2>
            <p class="text-sm font-medium text-slate-500 leading-relaxed px-4">
                ×”×™× ×š ××•×¢×‘×¨ ×œ××¡×š ×ª×©×œ×•× ×”×˜×™×¤ ×©×™×©××© ××•×ª×š ××¢×›×©×™×• ×œ×§×‘×œ×ª ×˜×™×¤ ×‘×¦×•×¨×” ××”×™×¨×”.
            </p>
            <div class="loader-ring mt-8 border-green-200 border-t-green-500"></div>
        </div>

        <!-- 3. Active View -->
        <div id="active-view" class="hidden fade-in-up flex-col text-center h-full pt-2">
            <!-- Dynamic Content -->
        </div>

    </div>

    <!-- Modals -->
    <div id="faq-modal"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"
        onclick="if(event.target.id==='faq-modal') toggleModal('faq-modal', false)">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
            <h3 class="font-black text-xl text-slate-800 mb-4 border-b pb-4">×¢×–×¨×” ×•×©××œ×•×ª</h3>
            <div class="space-y-3 text-right">
                <details class="bg-slate-50 rounded-2xl border border-slate-100 p-3">
                    <summary class="font-bold text-slate-700 text-sm cursor-pointer">××™×š ×–×” ×¢×•×‘×“?</summary>
                    <div class="text-xs text-slate-500 mt-2">×§×™×©×•×¨ ×™×©×™×¨ ×•××”×™×¨ ×œ×‘×™×˜ ×©×œ×š ×œ×œ× ×¦×•×¨×š ×‘××¤×œ×™×§×¦×™×”.</div>
                </details>
                <details class="bg-slate-50 rounded-2xl border border-slate-100 p-3">
                    <summary class="font-bold text-slate-700 text-sm cursor-pointer">×™×© ×¢××œ×•×ª?</summary>
                    <div class="text-xs text-green-600 font-bold mt-2">×œ×! ×”×›×¡×£ ×¢×•×‘×¨ ×‘-100% ××œ×™×š.</div>
                </details>
                <details class="bg-slate-50 rounded-2xl border border-slate-100 p-3">
                    <summary class="font-bold text-slate-700 text-sm cursor-pointer">×”×× ×–×” ×××•×‘×˜×—?</summary>
                    <div class="text-xs text-slate-500 mt-2">×›×Ÿ. ×”××¢×¨×›×ª ×¨×§ ××‘×¦×¢×ª ×”×¤× ×™×” (Redirect) ×•×”×ª×©×œ×•× ×‘×‘×™×˜.</div>
                </details>
            </div>
            <button onclick="toggleModal('faq-modal', false)"
                class="w-full mt-6 bg-slate-800 text-white font-bold py-3 rounded-xl">×¡×’×•×¨</button>
        </div>
    </div>

    <div id="guide-modal"
        class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-sm"
        onclick="toggleModal('guide-modal', false)">
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png"
            class="max-w-full rounded-[2rem] shadow-2xl">
    </div>

    <!-- PayBox Guide Modal -->
    <div id="paybox-guide-modal"
        class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-sm"
        onclick="toggleModal('paybox-guide-modal', false)">
        <img src="PayBox.png" class="max-w-full rounded-[2rem] shadow-2xl">
    </div>

    <!-- One Method Warning Modal -->
    <div id="one-method-warning-modal"
        class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 backdrop-blur-sm"
        onclick="if(event.target.id==='one-method-warning-modal') toggleModal('one-method-warning-modal', false)">
        <div
            class="bg-white w-full max-w-sm rounded-[2rem] p-6 text-center shadow-2xl skew-y-0 transform transition-all">
            <div class="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">ğŸ’¡</span>
            </div>
            <h3 class="font-black text-xl text-slate-800 mb-2">×”××œ×¦×” ×—××”</h3>
            <p class="text-sm font-medium text-slate-500 mb-6 leading-relaxed">
                ×©××ª×™ ×œ×‘ ×©×©××ª ×¨×§ ××—×“ ××©×ª×™ ×©×™×˜×•×ª ×”×ª×©×œ×•×.<br>××•××œ×¥ ×œ×”×›× ×™×¡ ××ª ×©×ª×™×”× ×¢×œ ×× ×ª ×œ×¤× ×•×ª ×œ×§×”×œ ×¨×—×‘ ×™×•×ª×¨ ×•×œ×”×’×“×™×œ ××ª
                ×”×˜×™×¤×™×.<br>×”×× ×‘×¨×¦×•× ×š ×œ×”××©×™×š ×‘×›×œ ×–××ª?
            </p>
            <div class="flex gap-3">
                <button onclick="toggleModal('one-method-warning-modal', false)"
                    class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-200 transition-colors">×œ×,
                    ×”×•×¡×£ ×©×™×˜×”</button>
                <button onclick="saveCardSafe(true)"
                    class="flex-1 bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-yellow-200 hover:bg-yellow-600 transition-colors">×›×Ÿ,
                    ×”××©×š</button>
            </div>
        </div>
    </div>

    <div id="admin-modal"
        class="fixed inset-0 bg-black/40 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-md"
        onclick="if(event.target.id==='admin-modal') toggleModal('admin-modal', false)">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 text-center relative shadow-2xl fade-in-up">
            <button onclick="toggleModal('admin-modal', false)"
                class="absolute top-6 left-6 text-slate-300 font-bold">&times;</button>
            <h3 class="font-black text-xl mb-6 text-slate-800">× ×™×”×•×œ ×›×¨×˜×™×¡</h3>
            <div id="admin-login-view" class="space-y-4">
                <input type="tel" id="admin-pin" placeholder="×§×•×“ ××™×©×™" maxlength="4"
                    class="w-full text-center text-3xl font-black p-4 bg-slate-50 border rounded-2xl tracking-[0.5em] outline-none focus:border-blue-400">
                <button onclick="checkStats()"
                    class="btn-press w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg">×›× ×™×¡×”</button>
            </div>
            <div id="admin-stats-view" class="hidden">
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100"><span
                            class="text-xs text-slate-400 font-black uppercase tracking-widest">×¡×”"×› ×¡×¨×™×§×•×ª</span>
                        <p id="stat-scans" class="text-5xl font-black text-blue-600 mt-2">-</p>
                    </div>
                </div>
                <button onclick="toggleModal('reset-warn-modal', true)"
                    class="w-full bg-white text-red-500 font-bold py-3 rounded-xl text-sm border border-red-100 hover:bg-red-50 transition-colors">ğŸ”„
                    ××™×¤×•×¡ ×›×¨×˜×™×¡</button>
            </div>
        </div>
    </div>
    <div id="reset-warn-modal"
        class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 backdrop-blur-sm"
        onclick="if(event.target.id==='reset-warn-modal') toggleModal('reset-warn-modal', false)">
        <div
            class="bg-white w-full max-w-sm rounded-[2rem] p-6 text-center shadow-2xl skew-y-0 transform transition-all">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">âš ï¸</span>
            </div>
            <h3 class="font-black text-xl text-slate-800 mb-2">××™×¤×•×¡ ×›×¨×˜×™×¡</h3>
            <p class="text-sm font-medium text-slate-500 mb-6 leading-relaxed">
                ×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ××¤×¡ ××ª ×›×¨×˜×™×¡×š?<br>×œ××—×¨ ×”××™×¤×•×¡ ×”×›×¨×˜×™×¡ ×™×—×–×•×¨ ×œ××¦×‘ ×”×”×ª×—×œ×ª×™ ×©×œ×•.
            </p>
            <div class="flex gap-3">
                <button onclick="toggleModal('reset-warn-modal', false)"
                    class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-200 transition-colors">×‘×™×˜×•×œ</button>
                <button onclick="executeReset()"
                    class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-red-200 hover:bg-red-600 transition-colors">×›×Ÿ,
                    ××¤×¡ ×›×¨×˜×™×¡</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        //   â–¼â–¼â–¼â–¼ ×”×“×‘×§ ××ª ×”×›×ª×•×‘×ª ×©×œ×š ×›××Ÿ ×œ××˜×” â–¼â–¼â–¼â–¼
        // ============================================

        const API_URL = "/api/card";

        // ============================================
        //   â–²â–²â–²â–² ×”×“×‘×§ ××ª ×”×›×ª×•×‘×ª ×©×œ×š ×›××Ÿ ×œ××¢×œ×” â–²â–²â–²â–²
        // ============================================

        const ASSETS = {
            bit: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png",
            paybox: "LOGO PAYBOX.png"
        };

        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let currentMode = 'tip';
        let selectedBitFile = null;

        // Loader
        const loadTxt = document.getElementById('loader-text');
        const phrases = ["×™×•×¦×¨ ×§×©×¨ ×××•×‘×˜×—...", "×‘×•×“×§ ×›×¨×˜×™×¡...", "×˜×•×¢×Ÿ × ×ª×•× ×™×..."];
        let phraseIdx = 0;
        let phraseInterval = null;

        function startLoaderAnim() {
            phraseInterval = setInterval(() => {
                if (!document.getElementById('loader-view').classList.contains('hidden')) {
                    loadTxt.innerText = phrases[phraseIdx];
                    phraseIdx = (phraseIdx + 1) % phrases.length;
                }
            }, 1000);
        }

        function stopLoader(msg, isError) {
            clearInterval(phraseInterval);
            if (msg) {
                document.getElementById('loader-view').innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-xl border border-red-100"><p class="font-black text-red-500 mb-2">×©×’×™××”</p><p class="text-sm text-slate-600">${msg}</p></div>`;
                if (isError) showToast("×©×’×™××” ×‘×˜×¢×™× ×”", true);
            } else {
                document.getElementById('loader-view').classList.add('hidden');
            }
        }

        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const body = document.getElementById('toast-body');
            const icon = document.getElementById('toast-icon');
            const msgEl = document.getElementById('toast-message');

            body.className = isError
                ? "bg-red-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[200px] justify-center backdrop-blur-md"
                : "bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[200px] justify-center backdrop-blur-md";

            icon.innerText = isError ? "âš ï¸" : "â„¹ï¸";
            msgEl.innerText = message;
            container.classList.add('toast-visible');
            setTimeout(() => container.classList.remove('toast-visible'), 3000);
        }

        async function init() {
            startLoaderAnim();

            if (!cardId) {
                stopLoader("×œ× × ××¦× ××¡×¤×¨ ×›×¨×˜×™×¡ (ID)", true);
                document.getElementById('ui-id').innerText = "MISSING ID";
                return;
            }
            document.getElementById('ui-id').innerText = `CARD #${cardId}`;

            try {
                // ×‘×“×™×§×ª ×˜×™×™×-×××•×˜ ×× ×”×©×¨×ª ×œ× ××’×™×‘ ×ª×•×š 7 ×©× ×™×•×ª
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 7000);

                const res = await fetch(`${API_URL}?action=getData&id=${cardId}`, { signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await res.json();
                stopLoader();

                if (data.status === 'NEW') {
                    document.getElementById('intro-view').classList.remove('hidden');
                    document.getElementById('intro-view').classList.add('flex');
                } else if (data.status === 'ACTIVE') {
                    renderActiveCard(data);
                } else if (data.status === 'LOCKED') {
                    stopLoader(`× ×¢×•×œ ×œ-${data.minutes} ×“×§'`, true);
                }
            } catch (e) {
                stopLoader("×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª. ×‘×“×•×§ ××ª ×”×§×™×©×•×¨ ××• ××ª ×”×—×™×‘×•×¨ ×œ×¨×©×ª.", true);
            }
        }

        // Setup
        function goToSetup(mode) {
            currentMode = mode;
            document.getElementById('intro-view').classList.remove('flex');
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('setup-form-view').classList.remove('hidden');
            document.getElementById('setup-form-view').classList.add('flex');

            const t = document.getElementById('setup-title');
            const bg = document.getElementById('input-group-bit');
            const lg = document.getElementById('input-group-link');

            if (mode === 'tip') {
                t.innerText = "×”×’×“×¨×ª ×××¦×¢×™ ×ª×©×œ×•×";
                bg.classList.remove('hidden');
                lg.classList.add('hidden');
            } else {
                t.innerText = "×”×’×“×¨×ª ×§×™×©×•×¨ ×¢×¡×§×™";
                bg.classList.add('hidden');
                lg.classList.remove('hidden');
            }
        }

        function backToIntro() {
            document.getElementById('setup-form-view').classList.add('hidden');
            document.getElementById('setup-form-view').classList.remove('flex');
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('intro-view').classList.add('flex');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedBitFile = input.files[0];
                document.getElementById('bit-text').innerText = "×§×•×‘×¥ × ×‘×—×¨ âœ…";
                document.getElementById('bit-label').classList.replace('bg-blue-50/50', 'bg-green-50');
                document.getElementById('bit-label').classList.replace('border-blue-200', 'border-green-400');
            }
        }

        function preValidateSave() {
            if (currentMode === 'tip') {
                const payboxLink = document.getElementById('paybox-input').value.trim();
                const hasBit = !!selectedBitFile;
                const hasPaybox = !!payboxLink;

                if (!hasBit && !hasPaybox) return showToast("×—×•×‘×” ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª ×××¦×¢×™ ×ª×©×œ×•× ××—×“", true);
                if ((hasBit && !hasPaybox) || (!hasBit && hasPaybox)) {
                    toggleModal('one-method-warning-modal', true);
                } else {
                    saveCardSafe(true);
                }
            } else {
                saveCardSafe(true);
            }
        }

        async function saveCardSafe(force = false) {
            if (currentMode === 'tip' && !force) return preValidateSave();

            toggleModal('one-method-warning-modal', false); // Close warning if open

            const name = document.getElementById('fixed-name-input').value.trim();
            const pin = document.getElementById('fixed-pin-input').value.trim();
            let bitData = "", directLink = "";

            if (!name) return showToast("×—×¡×¨ ×©× ××œ×", true);
            if (pin.length !== 4) return showToast("PIN ×—×™×™×‘ ×œ×”×™×•×ª 4 ×¡×¤×¨×•×ª", true);

            // Find button depending on where call came from (modal or form)
            // But actually, we triggered it via function, so let's find the main save button
            // To animate it we need to select it specifically
            const btn = document.querySelector('#setup-form-view button.btn-press.bg-slate-900');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="loader-ring w-5 h-5 border-white border-t-transparent mx-auto"></div>`;
            btn.disabled = true;

            try {
                if (currentMode === 'tip') {
                    if (selectedBitFile) {
                        bitData = await scanQRWrapper(selectedBitFile);
                        if (!bitData) throw "QR ×œ× ×–×•×”×” ×‘×ª××•× ×” (Bit)";
                    }
                    // For tip mode, PayBox link goes into 'directLink'
                    const pb = document.getElementById('paybox-input').value.trim();
                    if (pb) directLink = pb.startsWith('http') ? pb : 'https://' + pb;

                } else {
                    const l = document.getElementById('fixed-link-input').value.trim();
                    if (!l) throw "× × ×œ×”×–×™×Ÿ ×§×™×©×•×¨";
                    directLink = l.startsWith('http') ? l : 'https://' + l;
                }

                // First save the data
                await fetch(`${API_URL}?action=save&id=${cardId}&type=${currentMode}&name=${encodeURIComponent(name)}&pin=${pin}&bit=${encodeURIComponent(bitData)}&direct=${encodeURIComponent(directLink)}`);

                // Show Success Hook
                document.getElementById('setup-form-view').classList.remove('flex');
                document.getElementById('setup-form-view').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                document.getElementById('success-view').classList.add('flex');

                if (window.confetti) {
                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: ['#22c55e', '#3b82f6', '#fbbf24']
                    });
                }

                // Wait 2 seconds then reload
                setTimeout(() => {
                    window.location.reload();
                }, 2500);

            } catch (err) {
                showToast(err, true);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Active
        function renderActiveCard(data) {
            const container = document.getElementById('active-view');
            container.classList.remove('hidden');
            container.classList.add('flex');

            const headerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-black text-slate-800 mb-1 drop-shadow-sm">×¤×¨×’×Ÿ ×œ${data.name}!</h1>
                    <div class="inline-flex items-center gap-1 bg-green-50 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold border border-green-100 shadow-sm">
                        <span>ğŸ›¡ï¸</span><span>×××•××ª ×•×××•×‘×˜×—</span>
                    </div>
                </div>`;

            let actionHTML = '';
            if (data.type === 'tip') {
                // Check if we have Bit, Paybox, or Both
                const hasBit = data.bit && data.bit.length > 5;
                const hasPaybox = data.link && data.link.length > 5;

                actionHTML = '<div class="space-y-3 w-full">';

                if (hasBit) {
                    actionHTML += `
                    <button onclick="triggerAction('${data.bit}', 'bit')" class="btn-press group relative w-full bg-white p-1 rounded-3xl shadow-xl shadow-blue-100 transition-all overflow-hidden border border-white">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-blue-500 to-blue-600 opacity-10"></div>
                        <div class="relative bg-white border border-blue-50 rounded-[1.3rem] p-4 flex items-center justify-between z-10">
                            <div class="flex items-center gap-3">
                                <img src="${ASSETS.bit}" class="w-10 h-10 object-contain">
                                <div class="text-right">
                                    <span class="block font-black text-slate-800 text-lg tracking-tight">×˜×™×¤ ×‘-Bit</span>
                                    <span class="text-[10px] text-slate-400 font-bold">×”×¢×‘×¨×” ××”×™×¨×”</span>
                                </div>
                            </div>
                            <div class="bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center text-blue-500 text-sm">âœ</div>
                        </div>
                    </button>`;
                }

                if (hasPaybox) {
                    actionHTML += `
                    <button onclick="triggerAction('${data.link}', 'link')" class="btn-press group relative w-full bg-white p-1 rounded-3xl shadow-xl shadow-blue-100 transition-all overflow-hidden border border-white">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-blue-500 to-blue-600 opacity-5"></div>
                        <div class="relative bg-white border border-blue-50 rounded-[1.3rem] p-4 flex items-center justify-between z-10">
                            <div class="flex items-center gap-3">
                                <img src="${ASSETS.paybox}" class="w-10 h-10 object-contain rounded-lg">
                                <div class="text-right">
                                    <span class="block font-black text-slate-800 text-lg tracking-tight">×˜×™×¤ ×‘-PayBox</span>
                                    <span class="text-[10px] text-slate-400 font-bold">×”×¢×‘×¨×” ××”×™×¨×” ×“×¨×š PayBox</span>
                                </div>
                            </div>
                            <div class="bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center text-blue-500 text-sm">âœ</div>
                        </div>
                    </button>`;
                }

                actionHTML += '</div>';
            } else {
                actionHTML = `
                <button onclick="triggerAction('${data.link}', 'link')" class="btn-press w-full bg-slate-900 text-white p-5 rounded-3xl flex items-center justify-between shadow-2xl shadow-slate-200 border border-slate-700">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl">ğŸŒ</span>
                        <div class="text-right">
                            <span class="block font-black text-lg">×›× ×™×¡×” ×œ×§×™×©×•×¨</span>
                            <span class="text-xs text-slate-400 font-bold">××¢×‘×¨ ×œ××ª×¨</span>
                        </div>
                    </div>
                    <span>âœ</span>
                </button>`;
            }
            container.innerHTML = headerHTML + actionHTML + `<div class="mt-auto pt-8 pb-2"><button onclick="toggleModal('admin-modal', true)" class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] hover:text-slate-500 transition-colors">âš™ï¸ × ×™×”×•×œ ×›×¨×˜×™×¡</button></div>`;
        }

        function triggerAction(url, type) {
            if (window.confetti) confetti({ particleCount: 150, spread: 60, origin: { y: 0.7 }, colors: ['#3b82f6', '#fbbf24'] });
            const target = url.startsWith('http') ? url : 'https://' + url;
            setTimeout(() => {
                if (type === 'bit') window.open(target, '_blank');
                else window.top.location.href = target;
            }, 800);
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if (show) { el.classList.remove('hidden'); el.classList.add('flex'); }
            else { el.classList.add('hidden'); el.classList.remove('flex'); }
        }

        async function checkStats() {
            const p = document.getElementById('admin-pin').value;
            if (p.length !== 4) return showToast("×”×–×Ÿ 4 ×¡×¤×¨×•×ª", true);

            const btn = event.currentTarget;
            const originalTxt = btn.innerText;
            btn.innerText = "××××ª...";
            btn.disabled = true;

            try {
                const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${p}`);
                const d = await r.json();

                if (d.success) {
                    document.getElementById('admin-login-view').classList.add('hidden');
                    document.getElementById('admin-stats-view').classList.remove('hidden');
                    document.getElementById('stat-scans').innerText = d.total;
                    // Removed Average
                    // document.getElementById('stat-avg').innerText = d.average;
                } else {
                    handleSecurityError(d); // ×¤×•× ×§×¦×™×” ×©××˜×¤×œ×ª ×‘×”×•×“×¢×•×ª ×”× ×¢×™×œ×”
                }
            } catch (e) { showToast("×©×’×™××ª ×¨×©×ª", true); }

            btn.innerText = originalTxt;
            btn.disabled = false;
        }

        async function executeReset() {
            const p = document.getElementById('admin-pin').value;
            try {
                await fetch(`${API_URL}?action=reset&id=${cardId}&pin=${p}`);
                window.location.reload();
            } catch (e) {
                showToast("×©×’×™××” ×‘×‘×™×¦×•×¢ ×”××™×¤×•×¡", true);
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ××‘×˜×—×”
        function handleSecurityError(data) {
            if (data.msg === "LOCKED") {
                showToast(`×”×—×©×‘×•×Ÿ × × ×¢×œ ×œ-${data.minutesLeft} ×“×§×•×ª!`, true);
            } else if (data.msg === "WRONG_PIN") {
                showToast(`×§×•×“ ×©×’×•×™ (× ×•×ª×¨×• ${data.attemptsLeft} × ×™×¡×™×•× ×•×ª)`, true);
            } else {
                showToast("×§×•×“ ××™×©×™ ×©×’×•×™", true);
            }
        }

        async function scanQRWrapper(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = Math.min(800, img.width);
                        const scale = size / img.width;
                        canvas.width = size; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dt = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let c = jsQR(dt.data, dt.width, dt.height);
                        if (!c) {
                            ctx.drawImage(img, 0, -img.height * 0.25, canvas.width, canvas.height);
                            const dt2 = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            c = jsQR(dt2.data, dt2.width, dt2.height);
                        }
                        r(c ? c.data : null);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        init();
    </script>
</body>

</html>