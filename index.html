<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×”×“×¨×š ×”×§×œ×” ×œ×¤×¨×’×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 35px; height: 35px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-20 pb-12">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let selectedBitFile = null;
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[500px]">
        <!-- Header -->
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" class="w-32 h-32 bg-white rounded-3xl mx-auto -mt-24 mb-4 shadow-xl border-4 border-white object-cover">
        <h1 class="text-2xl font-black text-slate-800 italic uppercase">TipTap</h1>
        <p id="ui-id" class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest"></p>

        <!-- ××¡×š ×˜×¢×™× ×” -->
        <div id="loading-view" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400">×˜×•×¢×Ÿ...</p>
        </div>

        <!-- ×”×¦×œ×—×ª ××™×¤×•×¡ -->
        <div id="reset-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>

        <!-- ×ª×•×›×Ÿ ××ª×—×œ×£ -->
        <div id="content-view" class="hidden flex-grow flex flex-col"></div>
    </div>

    <!-- Modals -->
    <div id="guide-m" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4">
        <button onclick="toggleM('guide-m', false)" class="self-end text-white text-3xl mb-2">&times;</button>
        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="max-w-full rounded-3xl border-2 border-white shadow-2xl">
    </div>

    <script>
        async function init() {
            if(!cardId) { renderContent('×¡×¨×•×§ ×§×•×“ ×ª×§×™×Ÿ ××”×›×¨×˜×™×¡'); return; }
            document.getElementById('ui-id').innerText = `CARD #${cardId}`;
            if(urlParams.get('reset')) document.getElementById('reset-success').classList.remove('hidden');

            try {
                const r = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const d = await r.json();
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('content-view').classList.remove('hidden');
                if (d.status === "ACTIVE") renderActive(d);
                else renderPick();
            } catch(e) { renderContent('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª'); }
        }

        function renderContent(h) {
            document.getElementById('loading-view').classList.add('hidden');
            const v = document.getElementById('content-view');
            v.innerHTML = h; v.classList.remove('hidden');
        }

        function renderPick() {
            document.getElementById('content-view').innerHTML = `
                <p class="text-sm font-bold text-slate-500 mb-6">×‘×—×¨ ××¡×œ×•×œ ×œ×”×¤×¢×œ×”:</p>
                <button onclick="renderFinal('tip')" class="w-full p-4 mb-4 border-2 border-blue-100 rounded-2xl flex items-center gap-4 bg-white transition-all hover:bg-blue-50 text-right group">
                    <div class="text-3xl italic">ğŸ’°</div>
                    <div class="text-right leading-none"><span class="font-black text-blue-900 block text-right">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-500 italic">×—×™×‘×•×¨ ×œ-Bit</span></div>
                </button>
                <button onclick="renderFinal('link')" class="w-full p-4 mb-10 border-2 border-orange-100 rounded-2xl flex items-center gap-4 bg-white transition-all hover:bg-orange-50 text-right group text-right">
                    <div class="text-3xl italic text-right">ğŸš€</div>
                    <div class="text-right leading-none"><span class="font-black text-orange-900 block text-right">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400 italic">×§×™×©×•×¨ ×™×©×™×¨ ×œ××ª×¨</span></div>
                </button>
                <button onclick="toggleM('guide-m', true)" class="text-sm font-bold text-orange-600 underline">ğŸ“¸ ×”×“×¨×›×” ×œ×”×¤×¢×œ×”</button>
            `;
        }

        function renderFinal(mode) {
            document.getElementById('content-view').innerHTML = `
                <button onclick="renderPick()" class="text-xs font-bold text-blue-500 mb-6 underline">â† ×—×–×¨×”</button>
                <div class="space-y-4 text-right">
                    ${mode==='tip' ? `
                    <div><p class="text-xs font-bold text-slate-400 mb-1 italic text-right uppercase italic tracking-tighter">×§×•×“ QR ××‘×™×˜:</p>
                    <label id="up-b" class="flex items-center gap-3 p-4 border-2 border-dashed border-blue-200 rounded-2xl cursor-pointer">
                        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-8">
                        <span id="st" class="text-sm font-bold text-slate-400">×‘×—×¨ ×¦×™×œ×•× ××¡×š...</span>
                        <input type="file" id="f-i" class="hidden" accept="image/*" onchange="selectedBitFile=this.files[0];document.getElementById('st').innerText='×§×•×‘×¥ × ×‘×—×¨ âœ…';">
                    </label></div>` : `
                    <div><p class="text-xs font-bold text-slate-400 mb-1 italic text-right uppercase italic tracking-tighter">×”×“×‘×§ ×§×™×©×•×¨ (URL):</p>
                    <input type="url" id="link-in" placeholder="https://..." class="w-full p-4 border-2 rounded-xl text-left font-mono text-sm bg-slate-50 outline-none focus:border-orange-500 transition-all"></div>`}
                    
                    <p class="text-xs font-bold text-slate-400 italic mb-1 uppercase">×©× (××‘×™ ×”××œ×š):</p>
                    <input type="text" id="name-in" placeholder="×“×•×’××”: ××‘×™ ×”××œ×š" class="w-full p-4 border-2 rounded-xl italic font-bold focus:border-blue-400 outline-none transition-all">
                    
                    <p class="text-xs font-bold text-slate-400 leading-tight mb-1 uppercase">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª):</p>
                    <input type="tel" id="pin-in" maxlength="4" placeholder="____" class="w-full p-4 border-2 rounded-xl text-center text-3xl font-black tracking-[0.5em] outline-none">

                    <div class="flex items-start gap-2 p-3 bg-slate-50 rounded-xl">
                        <input type="checkbox" id="chk-v" class="mt-1">
                        <label class="text-[10px] text-slate-500 leading-tight text-right italic uppercase">×× ×™ ×××©×¨ ××ª ×”×ª×§× ×•×Ÿ. ×™×“×•×¢ ×œ×™ ×©×”×›×¨×˜×™×¡ ×™×™× ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”.</label>
                    </div>

                    <button onclick="saveGo('${mode}')" class="w-full bg-blue-600 text-white font-black py-4 rounded-[1.8rem] shadow-xl text-xl mt-4">×”×¤×¢×œ TipTap ğŸš€</button>
                </div>
            `;
        }

        async function saveGo(mode) {
            const name = document.getElementById('name-in').value;
            const pin = document.getElementById('pin-in').value;
            const checked = document.getElementById('chk-v').checked;

            if(!name || pin.length !== 4 || !checked) return alert("×× × ××œ× ×©×, 4 ×¡×¤×¨×•×ª ×§×•×“ ×•××©×¨ ×ª×§× ×•×Ÿ.");

            renderContent('<div class="py-20 flex flex-col items-center"><div class="loader mb-4"></div><p class="font-black text-blue-600 animate-pulse">××’×“×™×¨ ×›×¨×˜×™×¡...</p></div>');
            
            try {
                let bit = "", dir = "";
                if (mode === 'tip') {
                    if(!selectedBitFile) throw "×”×¢×œ×” ×¦×™×œ×•× ××¡×š ×©×œ ×‘×™×˜";
                    bit = await scanQr(selectedBitFile);
                    if(!bit) throw "QR ×œ× ×–×•×”×” ×‘×ª××•× ×”.";
                } else {
                    const lInput = document.getElementById('link-in');
                    if(!lInput || !lInput.value) throw "×”×–×Ÿ ×§×™×©×•×¨ ×ª×§×™×Ÿ";
                    dir = lInput.value;
                }
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${mode}&name=${encodeURIComponent(name)}&pin=${pin}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(dir)}`;
            } catch(e) { alert("×©×’×™××”: " + e); init(); }
        }

        function renderActive(d) {
            renderContent(`
                <h1 class="text-2xl font-black text-slate-800 mb-1 uppercase italic italic tracking-tighter">×¤×¨×’×Ÿ ×œ${d.name}!</h1>
                <p class="text-slate-500 text-sm mb-10 font-bold italic italic tracking-tighter italic">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×××•×‘×˜×— ×‘-bit</p>
                <button onclick="openDeep('${d.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg mb-4 transform transition-transform active:scale-95">
                    <div class="flex items-center gap-4 italic uppercase italic tracking-tighter font-black uppercase"><img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-10"><span>×ª×©×œ×•× ×‘-bit</span></div>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
                </button>
                ${d.type==='link' ? `<a href="${d.link}" target="_top" class="w-full bg-orange-500 text-white p-6 rounded-2xl text-xl font-black shadow-lg block mb-10 italic uppercase italic tracking-tighter">×‘×™×§×•×¨ ×‘××ª×¨ ğŸš€</a>` : ''}
                <div class="mt-4 bg-green-50 border border-green-100 rounded-2xl p-4 flex items-center justify-center gap-3">
                    <span class="text-green-700 font-bold text-[10px] uppercase font-black uppercase italic italic tracking-tighter">ğŸ›¡ï¸ ×¡×¨×™×§×” ×”×•×©×œ××” â€¢ ×ª×©×œ×•× ××•×’×Ÿ ×¢"×™ TipTap</span>
                </div>
                <button onclick="toggleM('stats-v', true)" class="mt-12 text-sm text-blue-500 underline font-black p-2 italic italic">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button>
            `);

            if(!document.getElementById('stats-v')) {
               document.body.insertAdjacentHTML('beforeend', `
                <div id="stats-v" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                   <div class="bg-white rounded-[2rem] p-6 w-full max-w-xs text-center shadow-2xl relative">
                      <h3 class="font-black mb-4 border-b pb-4 text-right">××–×•×¨ ××™×©×™</h3>
                      <input type="tel" id="p-in" placeholder="×§×•×“ ×¡×•×“×™" maxlength="4" class="w-full text-center text-4xl font-black p-4 border-2 rounded-xl mb-4">
                      <button onclick="fetchS()" id="f-btn" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl text-xl shadow-lg">×›× ×™×¡×”</button>
                      <button onclick="toggleM('stats-v', false)" class="text-slate-300 mt-6 text-xs uppercase font-bold italic tracking-tighter">×¡×’×•×¨</button>
                      <div id="s-div" class="mt-6 hidden bg-blue-50 p-4 rounded-xl text-center"></div>
                   </div>
                </div>`);
            }
        }

        async function fetchS() {
           const p = document.getElementById('p-in').value;
           document.getElementById('f-btn').innerText = '×‘×•×“×§...';
           const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${p}`);
           const d = await r.json();
           document.getElementById('f-btn').innerText = '×›× ×™×¡×”';
           const div = document.getElementById('s-div'); div.classList.remove('hidden');
           if(d.success) {
               div.innerHTML = `<p class="text-xs italic uppercase italic tracking-tighter">×¡×”"×› ×¡×¨×™×§×•×ª: <b class="text-blue-600 text-xl font-black">${d.total}</b></p><button onclick="window.location.href='${API_URL}?action=reset&id=${cardId}&pin=${p}'" class="mt-6 text-red-500 text-xs font-bold underline opacity-50 uppercase">ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×”</button>`;
           } else div.innerHTML = '<span class="text-red-500">×§×•×“ ×©×’×•×™</span>';
        }

        function toggleM(i, s) { const el = document.getElementById(i); if(s){ el.classList.remove('hidden'); el.classList.add('flex'); } else { el.classList.add('hidden'); el.classList.remove('flex'); } }
        function openDeep(url) { if(!url) return; const b = url.trim().startsWith('h') ? url : 'https://'+url; const w=window.open(b,'_blank'); if(!w || w.closed) window.top.location.href=b; }

        async function scanQr(file) {
            return new Promise(r => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    const im = new Image(); im.src = e.target.result;
                    im.onload = () => {
                        const can = document.createElement('canvas'); const ct = can.getContext('2d');
                        const s = Math.min(800/im.width, 800/im.height);
                        can.width = im.width*s; can.height = im.height*s;
                        ct.drawImage(im, 0, 0, can.width, can.height);
                        let qr = jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                        if(!qr) {
                            ct.drawImage(im, 0, im.height*0.25, im.width, im.height*0.5, 0, 0, can.width, can.height);
                            qr = jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                        }
                        r(qr?qr.data:null);
                    }
                }
            });
        }
        init();
    </script>
</body>
</html>
