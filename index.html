<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipTap | ×¤×©×•×˜ ×œ×¤×¨×’×Ÿ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f0f4f8; overflow-x: hidden; touch-action: manipulation; }
        .glass { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-press:active { transform: scale(0.97); transition: 0.1s; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <script>
        // ×•×•×“× ×©×–×” ×”×œ×™× ×§ ×”××¢×•×“×›×Ÿ ×œ×’×•×’×œ ×¡×§×¨×™×¤×˜ ×©×œ×š
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec"; 
        const ASSETS = {
            main: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg",
            bit: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png",
            guide: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png"
        };
    </script>

    <div class="glass w-full max-w-md rounded-[2.5rem] p-6 text-center relative flex flex-col min-h-[500px]">
        
        <!-- Header ×§×‘×•×¢ -->
        <header class="mb-4 z-10 relative">
            <div class="w-28 h-28 bg-white rounded-[2rem] mx-auto -mt-20 mb-3 shadow-xl border-4 border-white overflow-hidden">
                <img src="" id="logo-img" class="w-full h-full object-cover">
            </div>
            <h1 class="text-3xl font-black text-slate-800 italic uppercase tracking-tight">TipTap</h1>
            <p id="ui-id" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] mt-1">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </header>

        <!-- Loader -->
        <div id="loader-view" class="flex-grow flex flex-col items-center justify-center py-12">
            <div class="loader mb-4"></div>
            <span class="text-xs font-bold text-slate-400 animate-pulse">××ª×—×‘×¨ ×œ×©×¨×ª...</span>
        </div>

        <!-- 
           â˜… FIXED DOM STRATEGY â˜… 
           ×›×œ ×”××œ×× ×˜×™× ×©×œ ×”-Setup ×§×™×™××™× ×›××Ÿ ××¨××© ×•××•×¡×ª×¨×™×. 
           ×× ×—× ×• ×œ× ××©×ª××©×™× ×‘-innerHTML ×›×“×™ ×œ×”×¦×™×’ ××•×ª×.
        -->

        <!-- ××¡×š 1: ×‘×—×™×¨×ª ××¡×œ×•×œ -->
        <div id="intro-view" class="hidden flex-col gap-4 slide-up px-2">
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">×”×’×“×¨×ª ×›×¨×˜×™×¡ ×—×“×©</p>
            <button onclick="goToSetup('tip')" class="btn-press bg-white border-2 border-blue-50 p-4 rounded-2xl flex items-center gap-4 hover:bg-blue-50 transition-colors shadow-sm text-right">
                <span class="text-2xl bg-blue-100 p-2 rounded-xl">ğŸ’°</span>
                <div><span class="block font-black text-slate-800">××¡×œ×•×œ ×˜×™×¤</span><span class="text-xs text-slate-400 font-bold">×—×™×‘×•×¨ ×œ-Bit (××œ×¦×¨×™×)</span></div>
            </button>
            <button onclick="goToSetup('link')" class="btn-press bg-white border-2 border-orange-50 p-4 rounded-2xl flex items-center gap-4 hover:bg-orange-50 transition-colors shadow-sm text-right">
                <span class="text-2xl bg-orange-100 p-2 rounded-xl">ğŸš€</span>
                <div><span class="block font-black text-slate-800">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-xs text-slate-400 font-bold">×§×™×©×•×¨ ×œ××ª×¨ / ××™× ×¡×˜×’×¨×</span></div>
            </button>
            <button onclick="document.getElementById('guide-modal').classList.remove('hidden')" class="text-xs font-bold text-orange-400 mt-4 underline decoration-orange-200">ğŸ“¸ ××™×¤×” ××•×¦××™× ××ª ×”-QR?</button>
        </div>

        <!-- ××¡×š 2: ×˜×•×¤×¡ ×”×–× ×” (××©×•×ª×£ ×œ-2 ×”××¡×œ×•×œ×™×) -->
        <div id="setup-form-view" class="hidden slide-up flex-col gap-4 text-right">
            <button onclick="backToIntro()" class="text-xs font-bold text-slate-400 flex items-center mb-2">â† ×—×–×¨×”</button>
            
            <h2 id="setup-title" class="text-xl font-black text-slate-800 text-center mb-4">×”×’×“×¨×•×ª</h2>

            <!-- Input A: Bit Image (×¨×§ ×œ××¡×œ×•×œ ×˜×™×¤) -->
            <div id="input-group-bit" class="hidden">
                <p class="text-xs font-bold text-slate-400 mb-2">×ª××•× ×ª QR ××‘×™×˜:</p>
                <label id="bit-label" class="flex flex-col items-center justify-center h-32 border-2 border-dashed border-blue-200 bg-blue-50 rounded-2xl cursor-pointer">
                    <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-8 opacity-50 mb-2">
                    <span id="bit-text" class="text-xs font-bold text-blue-400">×œ×—×¥ ×œ×”×¢×œ××ª ×¦×™×œ×•× ××¡×š</span>
                    <input type="file" id="fixed-file-input" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                </label>
            </div>

            <!-- Input B: Direct Link (×¨×§ ×œ××¡×œ×•×œ ×¢×¡×§×™) -->
            <div id="input-group-link" class="hidden">
                <p class="text-xs font-bold text-slate-400 mb-2">×”×“×‘×§ ×§×™×©×•×¨ (URL):</p>
                <input type="url" id="fixed-link-input" dir="ltr" placeholder="www.yoursite.com" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold outline-none focus:border-slate-800">
            </div>

            <!-- Inputs C: Common (×ª××™×“ ×§×™×™××™×) -->
            <div>
                <p class="text-xs font-bold text-slate-400 mb-2 mt-2">×©× ×©×™×•×¤×™×¢ ×‘×›×¨×˜×™×¡:</p>
                <input type="text" id="fixed-name-input" placeholder="×œ××©×œ: ×“× ×™××œ" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold outline-none focus:border-slate-800 text-right">
            </div>

            <div>
                <p class="text-xs font-bold text-slate-400 mb-2 mt-2">×§×•×“ ×¡×•×“×™ (PIN) ×œ× ×™×”×•×œ:</p>
                <input type="tel" id="fixed-pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl font-black text-center text-xl tracking-[0.5em] outline-none focus:border-slate-800">
            </div>

            <button onclick="saveCardSafe()" class="btn-press w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl text-lg mt-2">×©××•×¨ ×•×”×¤×¢×œ ğŸš€</button>
        </div>

        <!-- ××¡×š 3: ×›×¨×˜×™×¡ ×¤×¢×™×œ -->
        <div id="active-view" class="hidden slide-up flex-col text-right h-full">
            <!-- ×”×ª×•×›×Ÿ ×›××Ÿ ×™×•×–×¨×§ ×“×™× ××™×ª ×›×™ ×”×•× ×œ×§×¨×™××” ×‘×œ×‘×“ ×•×œ× ×˜×•×¤×¡ -->
        </div>

    </div>

    <!-- Modals (×¢×–×¨×” ×•××™×¤×•×¡) -->
    <div id="guide-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <img src="" id="guide-img" class="max-w-full rounded-3xl shadow-2xl">
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-6 backdrop-blur-sm">
         <div class="bg-white w-full max-w-xs rounded-3xl p-6 text-center shadow-2xl relative">
            <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="absolute top-4 left-4 text-slate-300 font-bold">&times;</button>
            <h3 class="font-black text-xl mb-6 text-slate-800">××–×•×¨ ××™×©×™</h3>
            <div id="admin-login-view">
                <input type="tel" id="admin-pin" placeholder="PIN" maxlength="4" class="w-full text-center text-3xl font-black p-3 bg-slate-50 border-2 border-slate-100 rounded-xl mb-4 tracking-[0.5em] outline-none">
                <button onclick="checkStats()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg btn-press">×›× ×™×¡×”</button>
            </div>
            <div id="admin-stats-view" class="hidden text-center space-y-4">
                <div><p class="text-xs text-slate-400 font-bold uppercase">×¡×”"×› ×¡×¨×™×§×•×ª</p><p id="stat-scans" class="text-4xl font-black text-blue-600">-</p></div>
                <div><p class="text-xs text-slate-400 font-bold uppercase">×××•×¦×¢ ×™×•××™</p><p id="stat-avg" class="text-xl font-bold text-slate-800">-</p></div>
                <button onclick="doReset()" class="text-red-500 font-bold underline text-xs mt-4">××™×¤×•×¡ ×›×¨×˜×™×¡ ×•××—×™×§×”</button>
            </div>
         </div>
    </div>

    <script>
        // Init Assets
        document.getElementById('logo-img').src = ASSETS.main;
        document.getElementById('guide-img').src = ASSETS.guide;

        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let currentMode = 'tip'; 
        let selectedBitFile = null;

        // *** LOGIC START ***

        async function init() {
            if(!cardId) {
                document.getElementById('loader-view').innerHTML = `<p class="font-bold text-slate-400">×œ× ×–×•×”×” ×›×¨×˜×™×¡</p>`;
                document.getElementById('ui-id').innerText = "NO CARD ID";
                return;
            }
            document.getElementById('ui-id').innerText = `CARD #${cardId}`;

            try {
                const res = await fetch(`${API_URL}?action=getData&id=${cardId}`);
                const data = await res.json();
                
                document.getElementById('loader-view').classList.add('hidden');

                if (data.status === 'NEW') {
                    document.getElementById('intro-view').classList.remove('hidden');
                    document.getElementById('intro-view').classList.add('flex');
                } 
                else if (data.status === 'ACTIVE') {
                    renderActiveCard(data);
                } 
                else if (data.status === 'LOCKED') {
                     document.getElementById('loader-view').innerHTML = `<p class="font-black text-red-500">× ×¢×•×œ ×œ-${data.minutes} ×“×§'</p>`;
                     document.getElementById('loader-view').classList.remove('hidden');
                }

            } catch(e) {
                document.getElementById('loader-view').innerHTML = `<p class="font-bold text-red-400">×©×’×™××ª ×—×™×‘×•×¨</p>`;
            }
        }

        // --- Setup Logic (Fixed DOM Implementation) ---

        function goToSetup(mode) {
            currentMode = mode;
            // Hide Intro
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('intro-view').classList.remove('flex');

            // Show Form
            document.getElementById('setup-form-view').classList.remove('hidden');
            document.getElementById('setup-form-view').classList.add('flex');

            // Toggle specific fields using classList
            const bitGroup = document.getElementById('input-group-bit');
            const linkGroup = document.getElementById('input-group-link');
            const title = document.getElementById('setup-title');

            if (mode === 'tip') {
                title.innerText = "×”×’×“×¨×ª ×‘×™×˜";
                bitGroup.classList.remove('hidden');
                linkGroup.classList.add('hidden');
            } else {
                title.innerText = "×”×’×“×¨×ª ×§×™×©×•×¨";
                bitGroup.classList.add('hidden');
                linkGroup.classList.remove('hidden');
            }
        }

        function backToIntro() {
            document.getElementById('setup-form-view').classList.add('hidden');
            document.getElementById('setup-form-view').classList.remove('flex');
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('intro-view').classList.add('flex');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedBitFile = input.files[0];
                document.getElementById('bit-text').innerText = "×ª××•× ×” × ×‘×—×¨×” âœ…";
                document.getElementById('bit-label').classList.replace('bg-blue-50', 'bg-green-50');
                document.getElementById('bit-label').classList.replace('border-blue-200', 'border-green-400');
            }
        }

        async function saveCardSafe() {
            // ×§×¨×™××” ××©×“×•×ª ×§×‘×•×¢×™× (Fixed IDs) ×©×œ× × ×¢×œ××™× ×œ×¢×•×œ×
            const name = document.getElementById('fixed-name-input').value.trim();
            const pin = document.getElementById('fixed-pin-input').value.trim();
            let bitData = "";
            let directLink = "";

            if (!name) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ×©×");
            if (pin.length !== 4) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª)");

            // UI Feedback
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "×©×•××¨...";
            btn.disabled = true;

            try {
                if (currentMode === 'tip') {
                    if (!selectedBitFile) throw "×—×•×‘×” ×œ×”×¢×œ×•×ª ×ª××•× ×”";
                    bitData = await scanQRWrapper(selectedBitFile);
                    if (!bitData) throw "QR ×œ× ×–×•×”×” ×‘×ª××•× ×”";
                } else {
                    const rawLink = document.getElementById('fixed-link-input').value.trim();
                    if (!rawLink) throw "×—×•×‘×” ×œ×”×–×™×Ÿ ×§×™×©×•×¨";
                    // ×ª×™×§×•×Ÿ ××•×˜×•××˜×™
                    directLink = rawLink.startsWith('http') ? rawLink : 'https://' + rawLink;
                }

                // Redirect Save
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${currentMode}&name=${encodeURIComponent(name)}&pin=${pin}&bit=${encodeURIComponent(bitData)}&direct=${encodeURIComponent(directLink)}`;

            } catch (err) {
                alert(err);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // --- Active Logic ---

        function renderActiveCard(data) {
            const container = document.getElementById('active-view');
            container.classList.remove('hidden');
            container.classList.add('flex');

            let mainBtn = '';
            
            // ×œ×•×’×™×§×ª ×˜×¨×™×’×¨ ×•×× ×™××¦×™×” ×œ-2 ×”××¡×œ×•×œ×™×
            if (data.type === 'tip') {
                mainBtn = `
                <button onclick="triggerConfettiAndGo('${data.bit}', 'bit')" class="btn-press w-full bg-white border-2 border-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg shadow-blue-50 mb-8 relative overflow-hidden group">
                    <div class="flex items-center gap-4 relative z-10">
                        <img src="${ASSETS.bit}" class="w-10">
                        <div class="text-right">
                            <span class="block font-black text-[#00b0e9] text-xl italic uppercase">×ª×©×œ×•× ×‘-Bit</span>
                            <span class="text-[10px] text-slate-400 font-bold">×”×¢×‘×¨×” ××”×™×¨×” ×•×××•×‘×˜×—×ª</span>
                        </div>
                    </div>
                </button>`;
            } else {
                mainBtn = `
                <button onclick="triggerConfettiAndGo('${data.link}', 'link')" class="btn-press w-full bg-slate-900 text-white p-5 rounded-2xl flex items-center justify-between shadow-xl mb-8">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-2 rounded-xl text-2xl">ğŸ”—</div>
                        <div class="text-right">
                            <span class="block font-black text-lg">××¢×‘×¨ ×œ×§×™×©×•×¨</span>
                            <span class="text-[10px] text-slate-300 font-bold">××ª×¨ / ×¨×©×ª ×—×‘×¨×ª×™×ª</span>
                        </div>
                    </div>
                </button>`;
            }

            container.innerHTML = `
                <div class="text-center mb-6 mt-4">
                    <h1 class="text-3xl font-black text-slate-800 mb-1">×¤×¨×’×Ÿ ×œ${data.name}!</h1>
                    <div class="flex items-center justify-center gap-2 text-green-600 bg-green-50 px-3 py-1 rounded-full w-fit mx-auto border border-green-100">
                        <span class="text-[10px] font-bold">âœ“ ×”×›×¨×˜×™×¡ ×××•××ª ×•×××•×‘×˜×—</span>
                    </div>
                </div>

                ${mainBtn}

                <div class="mt-auto border-t border-slate-100 pt-6 text-center">
                    <button onclick="document.getElementById('admin-modal').classList.remove('hidden')" class="text-[10px] font-bold text-slate-300 tracking-widest uppercase hover:text-blue-500 transition-colors">××–×•×¨ ××™×©×™ / × ×™×”×•×œ</button>
                </div>
            `;
        }

        // --- Helpers ---

        function triggerConfettiAndGo(url, type) {
            // ×× ×™××¦×™×™×ª ×—×’×™×’×”
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00b0e9','#fbbf24','#ffffff'] });
            
            // ×‘×“×™×§×ª URL
            const target = url.startsWith('http') ? url : 'https://' + url;

            // ×”×©×”×™×™×” ×§×œ×” ×œ××¨××”
            setTimeout(() => {
                if (type === 'bit') window.open(target, '_blank');
                else window.top.location.href = target;
            }, 800);
        }

        async function scanQRWrapper(file) {
            return new Promise(r => {
                const fr = new FileReader();
                fr.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // ×¡×¨×™×§×” ×—×›××”
                        const size = Math.min(800, img.width);
                        const scale = size / img.width;
                        canvas.width = size; 
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const idata = ctx.getImageData(0,0,canvas.width,canvas.height);
                        let code = jsQR(idata.data, idata.width, idata.height);
                        
                        // Fallback crop
                        if(!code) {
                             ctx.drawImage(img, 0, -img.height*0.2, canvas.width, canvas.height); 
                             const idata2 = ctx.getImageData(0,0,canvas.width,canvas.height);
                             code = jsQR(idata2.data, idata2.width, idata2.height);
                        }
                        r(code ? code.data : null);
                    }
                };
                fr.readAsDataURL(file);
            });
        }

        // Admin Helpers
        async function checkStats() {
            const p = document.getElementById('admin-pin').value;
            const btn = event.target;
            btn.innerText = "...";
            try {
                const res = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${p}`);
                const data = await res.json();
                if(data.success) {
                    document.getElementById('admin-login-view').classList.add('hidden');
                    document.getElementById('admin-stats-view').classList.remove('hidden');
                    document.getElementById('stat-scans').innerText = data.total;
                    document.getElementById('stat-avg').innerText = data.average;
                } else {
                    alert('×§×•×“ ×©×’×•×™');
                }
            } catch(e) { alert('×©×’×™××”'); }
            btn.innerText = "×›× ×™×¡×”";
        }

        async function doReset() {
            if(!confirm('×‘×˜×•×—? ×”×¤×¢×•×œ×” ×œ× ×”×¤×™×›×”')) return;
            const p = document.getElementById('admin-pin').value;
            await fetch(`${API_URL}?action=reset&id=${cardId}&pin=${p}`);
            window.location.reload();
        }

        // Run
        init();

    </script>
</body>
</html>
