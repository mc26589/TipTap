<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipTap | ×”×›×¨×˜×™×¡ ×”×—×›×</title>
    
    <!-- ×˜×¢×™× ×” ×—×›××”: defer ×’×•×¨× ×œ×¡×¤×¨×™×•×ª ×œ×”×™×˜×¢×Ÿ ×‘×¨×§×¢ ××‘×œ×™ ×œ×—×¡×•× ××ª ×ª×¦×•×’×ª ×”××ª×¨ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f0f4f8; overflow-x: hidden; touch-action: manipulation; }
        
        /* Glassmorphism Refined */
        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.05), 0 0 15px rgba(0,0,0,0.03); 
        }

        /* Animations */
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Accordion Style for FAQ */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0%    {opacity: 0; transform: translateY(-10px)} 100%  {opacity: 1; transform: translateY(0)} }
        
        .loader-ring { width: 32px; height: 32px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .btn-press:active { transform: scale(0.96); opacity: 0.9; transition: 0.1s; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec"; 
        const ASSETS = {
            main: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg",
            bit: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png",
            guide: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png"
        };
    </script>

    <div class="glass w-full max-w-md rounded-[2.5rem] p-8 text-center relative flex flex-col min-h-[550px] transition-all">
        
        <!-- Header ×§×‘×•×¢ -->
        <header class="mb-2 z-10 relative">
            <div class="w-24 h-24 bg-white rounded-[1.5rem] mx-auto -mt-20 mb-3 shadow-xl border-4 border-white overflow-hidden">
                <img src="" id="logo-img" class="w-full h-full object-cover">
            </div>
            <h1 class="text-3xl font-black text-slate-800 italic uppercase tracking-tight">TipTap</h1>
            <p id="ui-id" class="text-[10px] text-slate-400 font-bold tracking-[0.2em] mt-1 uppercase">Loading System...</p>
        </header>

        <!-- Loading State ××©×•×“×¨×’ -->
        <div id="loader-view" class="flex-grow flex flex-col items-center justify-center py-12 space-y-3">
            <div class="loader-ring"></div>
            <p id="loader-text" class="text-xs font-bold text-slate-400 animate-pulse">×™×•×¦×¨ ×—×™×‘×•×¨ ×××•×‘×˜×—...</p>
        </div>

        <!-- 1. INTRO (×‘×—×™×¨×ª ××¡×œ×•×œ) -->
        <div id="intro-view" class="hidden flex-col gap-4 fade-in-up px-1 text-right mt-4">
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest text-center mb-2">×©×œ×‘ 1 ××ª×•×š 2: ×‘×—×™×¨×ª ××˜×¨×”</p>
            
            <button onclick="goToSetup('tip')" class="btn-press bg-white border border-blue-100 p-4 rounded-2xl flex items-center gap-4 hover:border-blue-300 hover:shadow-lg hover:shadow-blue-50 transition-all group">
                <div class="text-2xl bg-blue-50 p-3 rounded-xl group-hover:bg-blue-100 transition-colors">ğŸ’°</div>
                <div><span class="block font-black text-slate-800 text-lg">××¡×œ×•×œ ×˜×™×¤</span><span class="text-xs text-slate-400 font-bold">×—×™×‘×•×¨ ×œ-Bit (××•××œ×¥ ×œ××œ×¦×¨×™×)</span></div>
            </button>
            
            <button onclick="goToSetup('link')" class="btn-press bg-white border border-orange-100 p-4 rounded-2xl flex items-center gap-4 hover:border-orange-300 hover:shadow-lg hover:shadow-orange-50 transition-all group">
                <div class="text-2xl bg-orange-50 p-3 rounded-xl group-hover:bg-orange-100 transition-colors">ğŸš€</div>
                <div><span class="block font-black text-slate-800 text-lg">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-xs text-slate-400 font-bold">×›×¨×˜×™×¡ ×‘×™×§×•×¨ ×“×™×’×™×˜×œ×™ / ××ª×¨</span></div>
            </button>
            
            <div class="mt-4 flex justify-between px-2">
                <button onclick="toggleModal('faq-modal', true)" class="text-xs font-bold text-slate-400 underline decoration-slate-200">â“ ×©××œ×•×ª × ×¤×•×¦×•×ª</button>
                <button onclick="toggleModal('guide-modal', true)" class="text-xs font-bold text-orange-400 underline decoration-orange-200">ğŸ“¸ ××™×š ××•×¦××™× QR?</button>
            </div>
        </div>

        <!-- 2. SETUP FORM (×”×’×“×¨×•×ª) -->
        <div id="setup-form-view" class="hidden fade-in-up flex-col gap-3 text-right">
            <button onclick="backToIntro()" class="text-[10px] font-bold text-slate-400 flex items-center gap-1 w-fit mb-2 hover:text-slate-600 transition-colors bg-slate-100 px-3 py-1 rounded-full">âœ ×—×–×¨×”</button>
            <h2 id="setup-title" class="text-xl font-black text-slate-800 mb-2">×”×’×“×¨×ª × ×ª×•× ×™×</h2>

            <!-- A. QR Upload -->
            <div id="input-group-bit" class="hidden">
                <p class="text-xs font-bold text-slate-500 mb-1">×”×¢×œ××ª QR (×¦×™×œ×•× ××¡×š ××‘×™×˜)</p>
                <label id="bit-label" class="flex flex-col items-center justify-center h-28 border-2 border-dashed border-blue-200 bg-blue-50/50 rounded-2xl cursor-pointer hover:bg-blue-50 transition-colors">
                    <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-6 opacity-60 mb-2">
                    <span id="bit-text" class="text-[10px] font-bold text-blue-400 uppercase tracking-wide">×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥</span>
                    <input type="file" id="fixed-file-input" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                </label>
            </div>

            <!-- B. Link Input -->
            <div id="input-group-link" class="hidden">
                <p class="text-xs font-bold text-slate-500 mb-1">×§×™×©×•×¨ ×œ××ª×¨ / ××™× ×¡×˜×’×¨×</p>
                <input type="url" id="fixed-link-input" dir="ltr" placeholder="www.website.com" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-slate-800 transition-colors shadow-inner">
            </div>

            <!-- Common Fields -->
            <div>
                <p class="text-xs font-bold text-slate-500 mb-1 mt-2">×©× ××œ× (×™×•×¤×™×¢ ×‘×›×¨×˜×™×¡)</p>
                <input type="text" id="fixed-name-input" placeholder="×œ×“×•×’××”: ×“× ×™××œ ×›×”×Ÿ" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-slate-800 transition-colors shadow-inner text-right">
            </div>

            <div>
                <p class="text-xs font-bold text-slate-500 mb-1 mt-2">×§×•×“ ××™×©×™ (PIN) ×œ× ×™×”×•×œ</p>
                <input type="tel" id="fixed-pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-black text-center text-xl tracking-[0.5em] outline-none focus:border-slate-800 transition-colors shadow-inner">
            </div>

            <button onclick="saveCardSafe()" class="btn-press w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl text-sm mt-3 flex items-center justify-center gap-2">
                <span>×©××•×¨ ×•×”×¤×¢×œ ×›×¨×˜×™×¡</span>
                <span>ğŸš€</span>
            </button>
        </div>

        <!-- 3. ACTIVE CARD (×›×¨×˜×™×¡ ×¤×¢×™×œ) -->
        <div id="active-view" class="hidden fade-in-up flex-col text-center h-full pt-2">
            <!-- ×”×ª×•×›×Ÿ ××•×–×¨×§ ×“×™× ××™×ª -->
        </div>

    </div>

    <!-- ===== MODALS AREA ===== -->

    <!-- FAQ Modal (×©××œ×•×ª ×•×ª×©×•×‘×•×ª) -->
    <div id="faq-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target.id==='faq-modal') toggleModal('faq-modal', false)">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="font-black text-xl text-slate-800">××¨×›×– ×¢×–×¨×”</h3>
                <button onclick="toggleModal('faq-modal', false)" class="text-slate-300 text-2xl hover:text-slate-500">&times;</button>
            </div>
            
            <div class="space-y-3 text-right">
                <details class="group bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
                    <summary class="flex justify-between items-center p-4 cursor-pointer font-bold text-slate-700 text-sm select-none">
                        <span>××™×š ×–×” ×¢×•×‘×“?</span>
                        <span class="transition-transform group-open:rotate-180 text-blue-500">â–¼</span>
                    </summary>
                    <div class="p-4 pt-0 text-xs text-slate-500 leading-relaxed">
                        ×”××¢×¨×›×ª ××§×©×¨×ª ×‘×™×Ÿ ×›×¨×˜×™×¡ ×”-NFC ××• ×§×•×“ ×”-QR ×©×œ×š ×™×©×™×¨×•×ª ×œ×™×¢×“ ×©×‘×—×¨×ª (××¤×œ×™×§×¦×™×™×ª ×‘×™×˜ ××• ×§×™×©×•×¨ ×œ××ª×¨). ×× ×—× ×• ×¨×§ ×”"×’×©×¨" ×©××‘×¦×¢ ××ª ×”×§×™×©×•×¨ ×”××”×™×¨.
                    </div>
                </details>

                <details class="group bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
                    <summary class="flex justify-between items-center p-4 cursor-pointer font-bold text-slate-700 text-sm select-none">
                        <span>×”×× ××ª× ×’×•×‘×™× ×¢××œ×”?</span>
                        <span class="transition-transform group-open:rotate-180 text-blue-500">â–¼</span>
                    </summary>
                    <div class="p-4 pt-0 text-xs text-slate-500 leading-relaxed">
                        <span class="font-black text-green-600">×××© ×œ×!</span> ×”×˜×™×¤ ×¢×•×‘×¨ ×™×©×™×¨×•×ª ××”×œ×§×•×— ××œ×™×š ×‘×‘×™×˜. ×”×›×¡×£ ×œ× ×¢×•×‘×¨ ×“×¨×›× ×• ×‘×©×•× ×©×œ×‘ ×•××™×Ÿ ×œ× ×• × ×’×™×¢×” ××œ×™×•.
                    </div>
                </details>

                <details class="group bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
                    <summary class="flex justify-between items-center p-4 cursor-pointer font-bold text-slate-700 text-sm select-none">
                        <span>×”×× ×”××™×“×¢ ×©×œ×™ ×‘×˜×•×—?</span>
                        <span class="transition-transform group-open:rotate-180 text-blue-500">â–¼</span>
                    </summary>
                    <div class="p-4 pt-0 text-xs text-slate-500 leading-relaxed">
                        ×›×Ÿ. ×× ×—× ×• ×©×•××¨×™× ×¨×§ ××ª ×”×§×™×©×•×¨ ×”×¦×™×‘×•×¨×™ ×©×œ×š. ××™×Ÿ ×œ× ×• ×’×™×©×” ×œ×¤×¨×˜×™ ××©×¨××™, ×œ×—×©×‘×•×Ÿ ×”×‘× ×§ ×©×œ×š ××• ×œ×¡×™×¡×××•×ª. ×”×›×œ ××ª×‘×¦×¢ ×‘××¤×œ×™×§×¦×™×™×ª ×‘×™×˜ ×”×××•×‘×˜×—×ª ×©×œ ×”×‘× ×§×™×.
                    </div>
                </details>

                <details class="group bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
                    <summary class="flex justify-between items-center p-4 cursor-pointer font-bold text-slate-700 text-sm select-none">
                        <span>××” ×œ×¢×©×•×ª ×× ××™×‘×“×ª×™ ×›×¨×˜×™×¡?</span>
                        <span class="transition-transform group-open:rotate-180 text-blue-500">â–¼</span>
                    </summary>
                    <div class="p-4 pt-0 text-xs text-slate-500 leading-relaxed">
                        ××œ ×“××’×”. ×‘×¢×–×¨×ª ×”×§×•×“ ×”××™×©×™ (PIN) ×©×”×’×“×¨×ª, ×ª×•×›×œ ×œ×”×™×›× ×¡ ×œ× ×™×”×•×œ ×•×œ××¤×¡ ××ª ×”×›×¨×˜×™×¡, ×›×š ×©××™ ×©×™××¦× ××•×ª×• ×™×’×™×¢ ×œ×›×¨×˜×™×¡ ×¨×™×§.
                    </div>
                </details>
            </div>
            <button onclick="toggleModal('faq-modal', false)" class="w-full mt-6 bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg">×”×‘× ×ª×™, ×ª×•×“×”!</button>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex flex-col items-center justify-center p-6 backdrop-blur-sm" onclick="toggleModal('guide-modal', false)">
        <span class="text-white mb-4 text-sm font-bold">×œ×—×¥ ×‘×›×œ ××§×•× ×œ×¡×’×™×¨×”</span>
        <img src="" id="guide-img" class="max-w-full rounded-[2rem] shadow-2xl border-4 border-white/20">
    </div>

    <!-- Admin/Personal Area Modal (×‘×¢×™×¦×•×‘ ×—×“×©) -->
    <div id="admin-modal" class="fixed inset-0 bg-black/40 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-md" onclick="if(event.target.id==='admin-modal') toggleModal('admin-modal', false)">
         <div class="glass w-full max-w-xs rounded-[2.5rem] p-8 text-center relative shadow-2xl fade-in-up">
            <button onclick="toggleModal('admin-modal', false)" class="absolute top-6 left-6 text-slate-300 font-bold hover:text-slate-800 transition-colors">&times;</button>
            
            <div class="w-16 h-16 bg-slate-50 rounded-2xl mx-auto mb-4 flex items-center justify-center text-3xl shadow-sm border border-slate-100">âš™ï¸</div>
            <h3 class="font-black text-xl mb-6 text-slate-800">× ×™×”×•×œ ×›×¨×˜×™×¡</h3>
            
            <!-- Login View -->
            <div id="admin-login-view" class="space-y-4">
                <p class="text-xs text-slate-400">×”×–×Ÿ ×§×•×“ PIN ×œ×›× ×™×¡×”</p>
                <input type="tel" id="admin-pin" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" class="w-full text-center text-3xl font-black p-4 bg-slate-50 border border-slate-200 rounded-2xl tracking-[0.5em] outline-none focus:border-blue-500 transition-colors">
                <button onclick="checkStats()" class="btn-press w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg text-sm">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
            </div>

            <!-- Dashboard View -->
            <div id="admin-stats-view" class="hidden">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                        <span class="text-[10px] text-slate-400 font-black uppercase tracking-wider">×¡×¨×™×§×•×ª</span>
                        <p id="stat-scans" class="text-3xl font-black text-blue-600 mt-1">-</p>
                    </div>
                    <div class="bg-purple-50/50 p-4 rounded-2xl border border-purple-100">
                        <span class="text-[10px] text-slate-400 font-black uppercase tracking-wider">×××•×¦×¢</span>
                        <p id="stat-avg" class="text-3xl font-black text-purple-600 mt-1">-</p>
                    </div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                    <p class="text-xs font-bold text-red-800 mb-3">××–×•×¨ ×¡×›× ×”</p>
                    <button onclick="doReset()" class="w-full bg-white text-red-500 font-bold py-2 rounded-xl text-xs border border-red-100 shadow-sm hover:bg-red-500 hover:text-white transition-colors">
                        ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×ª ×›×¨×˜×™×¡
                    </button>
                </div>
            </div>
         </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Init Assets
        document.getElementById('logo-img').src = ASSETS.main;
        document.getElementById('guide-img').src = ASSETS.guide;

        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let currentMode = 'tip'; 
        let selectedBitFile = null;

        // UI Helpers for "Slow" Connection Perception
        const loadTxt = document.getElementById('loader-text');
        const phrases = ["×™×•×¦×¨ ×§×©×¨ ×××•×‘×˜×—...", "××××ª ×›×¨×˜×™×¡...", "××•×©×š × ×ª×•× ×™×..."];
        let phraseIdx = 0;
        const phraseInterval = setInterval(() => {
            phraseIdx = (phraseIdx + 1) % phrases.length;
            if(!document.getElementById('loader-view').classList.contains('hidden')) {
                loadTxt.innerText = phrases[phraseIdx];
            }
        }, 800);

        async function init() {
            if(!cardId) {
                stopLoader("×œ× × ××¦× ××¡×¤×¨ ×›×¨×˜×™×¡ (ID)", true);
                document.getElementById('ui-id').innerText = "NO ID";
                return;
            }
            document.getElementById('ui-id').innerText = `CARD #${cardId}`;

            try {
                // Fetch Logic
                const res = await fetch(`${API_URL}?action=getData&id=${cardId}`);
                const data = await res.json();
                
                // Done Loading
                stopLoader();

                // Router Logic
                if (data.status === 'NEW') {
                    document.getElementById('intro-view').classList.remove('hidden');
                    document.getElementById('intro-view').classList.add('flex');
                } else if (data.status === 'ACTIVE') {
                    renderActiveCard(data);
                } else if (data.status === 'LOCKED') {
                    stopLoader(`×”×›×¨×˜×™×¡ × ×¢×•×œ ×œ-${data.minutes} ×“×§'`, true);
                }

            } catch(e) {
                stopLoader("×©×’×™××ª ×ª×§×©×•×¨×ª. × ×¡×” ×©×•×‘", true);
            }
        }

        function stopLoader(msg, isError) {
            clearInterval(phraseInterval);
            if(msg) {
                document.getElementById('loader-view').innerHTML = `<p class="font-bold ${isError?'text-red-400':'text-slate-400'} bg-white px-4 py-2 rounded-xl shadow-sm">${msg}</p>`;
            } else {
                document.getElementById('loader-view').classList.add('hidden');
            }
        }

        // --- Setup Logic (Fixed DOM) ---
        function goToSetup(mode) {
            currentMode = mode;
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('intro-view').classList.remove('flex');
            
            document.getElementById('setup-form-view').classList.remove('hidden');
            document.getElementById('setup-form-view').classList.add('flex');

            const t = document.getElementById('setup-title');
            const bg = document.getElementById('input-group-bit');
            const lg = document.getElementById('input-group-link');

            if(mode==='tip') {
                t.innerText = "×”×’×“×¨×ª ×‘×™×˜ (×˜×™×¤)";
                bg.classList.remove('hidden');
                lg.classList.add('hidden');
            } else {
                t.innerText = "×”×’×“×¨×ª ×§×™×©×•×¨ ×¢×¡×§×™";
                bg.classList.add('hidden');
                lg.classList.remove('hidden');
            }
        }

        function backToIntro() {
            document.getElementById('setup-form-view').classList.add('hidden');
            document.getElementById('setup-form-view').classList.remove('flex');
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('intro-view').classList.add('flex');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedBitFile = input.files[0];
                document.getElementById('bit-text').innerText = "×§×•×‘×¥ ×”×ª×§×‘×œ âœ…";
                document.getElementById('bit-label').classList.replace('bg-blue-50/50', 'bg-green-50');
                document.getElementById('bit-label').classList.replace('border-blue-200', 'border-green-400');
            }
        }

        async function saveCardSafe() {
            const name = document.getElementById('fixed-name-input').value.trim();
            const pin = document.getElementById('fixed-pin-input').value.trim();
            let bitData = "", directLink = "";

            if (!name) return alert("×—×¡×¨ ×©× ××œ×");
            if (pin.length !== 4) return alert("×—×¡×¨ ×§×•×“ PIN (4 ×¡×¤×¨×•×ª)");

            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="loader-ring w-5 h-5 border-white border-t-transparent mx-auto"></div>`;
            btn.disabled = true;

            try {
                if (currentMode === 'tip') {
                    if (!selectedBitFile) throw "× × ×œ×”×¢×œ×•×ª ×¦×™×œ×•× ××¡×š";
                    bitData = await scanQRWrapper(selectedBitFile);
                    if (!bitData) throw "×œ× ×–×•×”×” QR ×ª×§×™×Ÿ ×‘×ª××•× ×”";
                } else {
                    const l = document.getElementById('fixed-link-input').value.trim();
                    if (!l) throw "× × ×œ×”×–×™×Ÿ ×§×™×©×•×¨";
                    directLink = l.startsWith('http') ? l : 'https://' + l;
                }

                // Redirect Save
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${currentMode}&name=${encodeURIComponent(name)}&pin=${pin}&bit=${encodeURIComponent(bitData)}&direct=${encodeURIComponent(directLink)}`;

            } catch (err) {
                alert(err);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // --- Active Logic ---
        function renderActiveCard(data) {
            const container = document.getElementById('active-view');
            container.classList.remove('hidden');
            container.classList.add('flex');

            // Header Content
            const headerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-black text-slate-800 mb-1 drop-shadow-sm">×¤×¨×’×Ÿ ×œ${data.name}!</h1>
                    <div class="inline-flex items-center gap-1 bg-green-50 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold border border-green-100 shadow-sm">
                        <span>ğŸ›¡ï¸</span><span>×××•××ª ×•×××•×‘×˜×— ×¢"×™ TipTap</span>
                    </div>
                </div>`;

            let actionHTML = '';
            if (data.type === 'tip') {
                actionHTML = `
                <button onclick="triggerAction('${data.bit}', 'bit')" class="btn-press group relative w-full bg-white p-1 rounded-3xl shadow-xl shadow-blue-100 transition-all overflow-hidden border border-white">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-blue-500 to-blue-600 opacity-10"></div>
                    <div class="relative bg-white border border-blue-50 rounded-[1.3rem] p-5 flex items-center justify-between z-10">
                        <div class="flex items-center gap-4">
                            <img src="${ASSETS.bit}" class="w-12 h-12">
                            <div class="text-right">
                                <span class="block font-black text-slate-800 text-xl tracking-tight">×”×¢×‘×¨×ª ×˜×™×¤ ×‘-Bit</span>
                                <span class="text-xs text-slate-400 font-bold">×§×œ, ××”×™×¨ ×•×™×©×™×¨×•×ª ×œ×›×™×¡</span>
                            </div>
                        </div>
                        <div class="bg-blue-50 w-10 h-10 rounded-full flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform">âœ</div>
                    </div>
                </button>`;
            } else {
                actionHTML = `
                <button onclick="triggerAction('${data.link}', 'link')" class="btn-press w-full bg-slate-900 text-white p-5 rounded-3xl flex items-center justify-between shadow-2xl shadow-slate-200 border border-slate-700">
                    <div class="flex items-center gap-4">
                        <span class="text-2xl">ğŸŒ</span>
                        <div class="text-right">
                            <span class="block font-black text-lg">×›× ×™×¡×” ×œ×§×™×©×•×¨</span>
                            <span class="text-xs text-slate-400 font-bold">××¢×‘×¨ ×œ××ª×¨ ×—×™×¦×•× ×™</span>
                        </div>
                    </div>
                    <span>âœ</span>
                </button>`;
            }

            const footerHTML = `
                <div class="mt-auto pt-8 pb-2">
                    <button onclick="toggleModal('admin-modal', true)" class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] hover:text-slate-500 transition-colors">
                        âš™ï¸ ×›× ×™×¡×” ×œ××–×•×¨ ××™×©×™
                    </button>
                </div>
            `;

            container.innerHTML = headerHTML + actionHTML + footerHTML;
        }

        function triggerAction(url, type) {
            // 1. Confetti
            if(window.confetti) {
                confetti({ particleCount: 150, spread: 60, origin: { y: 0.7 }, colors: ['#3b82f6', '#fbbf24'] });
            }
            
            // 2. Navigation
            const target = url.startsWith('http') ? url : 'https://' + url;
            setTimeout(() => {
                if (type === 'bit') window.open(target, '_blank');
                else window.top.location.href = target;
            }, 800);
        }

        // --- Admin & Utils ---
        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if(show) { el.classList.remove('hidden'); el.classList.add('flex'); }
            else { el.classList.add('hidden'); el.classList.remove('flex'); }
        }

        async function checkStats() {
            const p = document.getElementById('admin-pin').value;
            const btn = event.currentTarget;
            const originalTxt = btn.innerText;
            btn.innerText = "×‘×•×“×§...";
            
            try {
                const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${p}`);
                const d = await r.json();
                
                if(d.success) {
                    document.getElementById('admin-login-view').classList.add('hidden');
                    document.getElementById('admin-stats-view').classList.remove('hidden');
                    document.getElementById('stat-scans').innerText = d.total;
                    document.getElementById('stat-avg').innerText = d.average;
                } else {
                    alert("×§×•×“ ×©×’×•×™");
                }
            } catch(e) { alert("×©×’×™××”"); }
            
            btn.innerText = originalTxt;
        }

        async function doReset() {
            if(!confirm("×”×× ×œ××—×•×§ ××ª ×”×›×¨×˜×™×¡? ×”×¤×¢×•×œ×” ××™× ×” ×”×¤×™×›×”!")) return;
            const p = document.getElementById('admin-pin').value;
            await fetch(`${API_URL}?action=reset&id=${cardId}&pin=${p}`);
            window.location.reload();
        }

        // QR Util (Fallback support included)
        async function scanQRWrapper(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = Math.min(800, img.width);
                        const scale = size / img.width;
                        canvas.width = size; canvas.height = img.height * scale;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dt = ctx.getImageData(0,0,canvas.width,canvas.height);
                        let c = jsQR(dt.data, dt.width, dt.height);
                        
                        if(!c) { // Fallback Top Crop for Bit Screenshots
                            ctx.drawImage(img, 0, -img.height*0.25, canvas.width, canvas.height);
                            const dt2 = ctx.getImageData(0,0,canvas.width,canvas.height);
                            c = jsQR(dt2.data, dt2.width, dt2.height);
                        }
                        r(c ? c.data : null);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Start App
        init();

    </script>
</body>
</html>
