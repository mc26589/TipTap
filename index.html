<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×¤×©×•×˜ ×œ×¤×¨×’×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-24 pb-12 text-right">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        const LOGO_TIPTAP = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg";
        const LOGO_BIT = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png";
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[500px]">
        
        <!-- Header ×§×‘×•×¢ -->
        <div id="static-header">
            <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" 
                 class="w-32 h-32 bg-white rounded-3xl mx-auto -mt-24 mb-4 shadow-xl border-4 border-white object-cover">
            <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight uppercase">TipTap</h1>
            <p id="ui-card-id" class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest uppercase"></p>
        </div>

        <div id="reset-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>
        <div id="loader-view" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 font-bold">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>

        <div id="main-view" class="hidden flex-grow flex flex-col"></div>
    </div>

    <!-- Modals Container -->
    <div id="modals">
        <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-[2rem] w-full max-w-md p-6 flex flex-col max-h-[85vh] modal-enter">
                <div class="flex justify-between items-center mb-6"><h3 class="font-black text-xl text-right">×¢×–×¨×” ×•×©××œ×•×ª</h3><button onclick="toggleModal('faq-modal',false)" class="text-2xl text-slate-300">&times;</button></div>
                <div class="space-y-3 overflow-y-auto text-sm text-right pr-1">
                    <details class="bg-slate-50 p-4 rounded-xl"><summary class="font-bold cursor-pointer italic uppercase">××™×š ××•×¦×™××™× QR ××‘×™×˜?</summary>
                        <p class="mt-2 leading-relaxed">×‘×™×˜ > ×©×œ×•×© × ×§×•×“×•×ª ×œ××¢×œ×” > "×§×•×“ QR ×”×§×‘×•×¢ ×©×œ×™ ×œ×§×‘×œ×ª ×›×¡×£" > ×¦×œ××• ××¡×š.</p></details>
                    <details class="bg-red-50 p-4 rounded-xl border border-red-100 text-red-600 font-bold"><summary class="cursor-pointer underline">×©×›×—×ª×™ ××ª ×”×§×•×“ ×”×¡×•×“×™?</summary>
                        <p class="mt-2 text-xs font-normal">×œ×œ× ×”×§×•×“ ×”×¡×•×“×™ ×œ× × ×™×ª×Ÿ ×œ××¤×¡ ××ª ×”×›×¨×˜×™×¡. ×‘××§×¨×” ×©×œ ××•×‘×“×Ÿ ×ª×¦×˜×¨×›×• ×œ×¨×›×•×© ×›×¨×˜×™×¡ ×—×“×©. ×©××¨×• ×¢×œ×™×• ×”×™×˜×‘!</p></details>
                    <details class="bg-slate-50 p-4 rounded-xl"><summary class="font-bold cursor-pointer italic">×”×× ×”××™×“×¢ ×××•×‘×˜×—?</summary>
                        <p class="mt-2">×›×Ÿ. ×”××•×ª×’ TipTap ×©×•××¨ ×¨×§ ××ª ×”×§×™×©×•×¨×™× ×”×¦×™×‘×•×¨×™×™× ×©×œ×›×. ××™×Ÿ ×œ× ×• ×’×™×©×” ×œ×—×©×‘×•× ×•×ª ×‘× ×§ ××• ×¤×¨×˜×™× ××™×©×™×™× ×‘×ª×•×š ×”×‘×™×˜.</p></details>
                </div>
                <button onclick="toggleModal('faq-modal',false)" class="w-full bg-slate-800 text-white py-4 rounded-2xl mt-6 font-bold shadow-lg">×”×‘× ×ª×™</button>
            </div>
        </div>

        <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4">
            <button onclick="toggleModal('guide-modal',false)" class="self-end text-white text-3xl mb-2">&times;</button>
            <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="max-w-full rounded-3xl border-4 border-white shadow-2xl">
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let selectedBitFile = null;

        async function init() {
            if(!cardId) { document.getElementById('loader-view').innerHTML='<p class="py-10 font-bold">×¡×¨×•×§ ×§×•×“ ××”×›×¨×˜×™×¡</p>'; return; }
            document.getElementById('ui-card-id').innerText = `CARD #${cardId}`;
            if(urlParams.get('reset')) document.getElementById('reset-success').classList.remove('hidden');

            try {
                const r = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const d = await r.json();
                document.getElementById('loader-view').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');
                if (d.status === "ACTIVE") renderPaymentPage(d);
                else renderStartScreen();
            } catch(e) { document.getElementById('loader-view').innerHTML='<p class="text-red-500 font-bold p-10">×—×™×‘×•×¨ ×œ×©×¨×ª × ×›×©×œ</p>'; }
        }

        function renderStartScreen() {
            document.getElementById('main-view').innerHTML = `
                <p class="text-sm font-bold text-slate-500 mb-6 italic text-center uppercase italic tracking-tighter italic font-black uppercase">×‘×—×¨ ××¡×œ×•×œ ×œ×”×¤×¢×œ×”:</p>
                <button onclick="renderFinalStep('tip')" class="w-full p-4 mb-4 border-2 border-blue-100 rounded-2xl bg-white hover:bg-blue-50 transition-all flex items-center gap-4 text-right shadow-sm">
                    <div class="text-3xl">ğŸ’°</div>
                    <div class="leading-none text-right"><span class="font-black text-blue-900 block font-black uppercase italic tracking-tighter">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-500 italic tracking-widest uppercase">×—×™×‘×•×¨ ×œ-Bit (××œ×¦×¨×™×)</span></div>
                </button>
                <button onclick="renderFinalStep('link')" class="w-full p-4 mb-10 border-2 border-orange-100 rounded-2xl bg-white hover:bg-orange-50 transition-all flex items-center gap-4 text-right shadow-sm">
                    <div class="text-3xl">ğŸš€</div>
                    <div class="leading-none text-right"><span class="font-black text-orange-900 block font-black uppercase italic">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400 italic font-black">××¢×‘×¨ ×™×©×™×¨ ×œ×§×™×©×•×¨</span></div>
                </button>
                <button onclick="toggleModal('guide-modal',true)" class="text-sm font-bold text-orange-600 underline text-center block w-full mb-3 decoration-orange-300">ğŸ“¸ ×”×“×¨×›×” ×œ×”×¤×¢×œ×”</button>
                <button onclick="toggleModal('faq-modal',true)" class="text-xs text-slate-300 underline font-black uppercase tracking-widest text-center block w-full decoration-slate-200 uppercase">×¢×–×¨×” ×•×©××œ×•×ª</button>
            `;
        }

        function renderFinalStep(m) {
            document.getElementById('main-view').innerHTML = `
                <button onclick="renderStartScreen()" class="text-xs font-bold text-blue-500 mb-6 flex items-center italic tracking-widest">â† ×—×–×¨×”</button>
                <div class="space-y-4 text-right flex flex-col">
                    ${m==='tip' ? `
                    <div><p class="text-xs font-bold text-slate-400 mr-1 mb-1 italic tracking-widest uppercase">×§×•×“ QR ×-bit:</p>
                    <label id="ubox" class="flex items-center gap-3 p-4 border-2 border-dashed border-blue-200 rounded-2xl cursor-pointer hover:bg-blue-50 bg-white">
                        <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-8">
                        <span id="stext" class="text-sm font-bold text-slate-400 italic">×‘×—×¨ ×¦×™×œ×•× ××¡×š...</span>
                        <input type="file" id="fi" class="hidden" accept="image/*" onchange="selectedBitFile=this.files[0];document.getElementById('stext').innerText='×§×•×‘×¥ × ×‘×—×¨ âœ…';">
                    </label></div>` : `
                    <div><p class="text-xs font-bold text-slate-400 mr-1 mb-1 italic tracking-tighter font-black italic">×”×“×‘×§ ×§×™×©×•×¨ (URL):</p>
                    <input type="url" id="link-field" placeholder="https://..." class="w-full p-4 border-2 border-slate-100 rounded-2xl text-left bg-slate-50 focus:border-orange-500 outline-none"></div>`}
                    
                    <p class="text-xs font-bold text-slate-400 mr-1 italic uppercase">×©× ×‘×¢×œ ×”×›×¨×˜×™×¡:</p>
                    <input type="text" id="name-field" placeholder="×“×•×’××”: ××‘×™ ×”××œ×š ğŸ‘‘" class="w-full p-3 border-2 border-slate-100 rounded-xl font-bold bg-slate-50 focus:border-blue-400 outline-none">
                    
                    <p class="text-xs font-bold text-slate-400 mt-4 leading-none uppercase italic font-black uppercase italic tracking-tighter font-black">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª) - ×œ××–×•×¨ ×”××™×©×™:</p>
                    <input type="tel" id="pin-field" maxlength="4" placeholder="____" class="w-full p-3 border-2 border-slate-100 rounded-xl text-center text-3xl font-black tracking-[0.6em] outline-none">

                    <button onclick="handleSave('${m}')" class="w-full bg-blue-600 text-white font-black py-5 rounded-[1.8rem] shadow-xl text-xl mt-6 active:scale-95 transition-all">×”×¤×¢×œ TipTap ğŸš€</button>
                    <p class="text-[9px] text-slate-300 px-4 mt-2 leading-relaxed italic uppercase italic uppercase font-black tracking-widest italic tracking-tighter">×™×“×•×¢ ×œ×™ ×©×”×›×¨×˜×™×¡ ×™×™× ×¢×œ ×•× ×™×ª×Ÿ ×œ××¤×¡×• ×¨×§ ×¢× ×”×§×•×“ ×”×¡×•×“×™.</p>
                </div>
            `;
        }

        async function handleSave(m) {
            const n = document.getElementById('name-field').value;
            const p = document.getElementById('pin-field').value;
            if(!n || p.length!==4) return alert("×”×–×Ÿ ×©× ×•×§×•×“ ×¡×•×“×™ ×ª×§×™×Ÿ");

            document.getElementById('main-view').innerHTML = '<div class="py-20 flex flex-col items-center"><div class="loader mb-4"></div><p class="font-bold text-blue-600 animate-pulse italic uppercase tracking-tighter italic">××¢×‘×“ TipTap...</p></div>';
            
            try {
                let bit = "", dir = "";
                if(m === 'tip') {
                    if(!selectedBitFile) throw "×”×¢×œ×” ×§×•×‘×¥ ×‘×™×˜";
                    bit = await scanQRNow(selectedBitFile); if(!bit) throw "QR ×œ× ×–×•×”×”";
                } else {
                    const lf = document.getElementById('link-field');
                    if(!lf || !lf.value) throw "×”×–×Ÿ ×§×™×©×•×¨ ×ª×§×™×Ÿ";
                    dir = lf.value.startsWith('http') ? lf.value : 'https://' + lf.value;
                }
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${m}&name=${encodeURIComponent(n)}&pin=${p}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(dir)}`;
            } catch(e){ alert(e); location.reload(); }
        }

        function renderPaymentPage(d) {
            let actionBtn = "";
            if (d.type === 'tip') {
                actionBtn = `
                <button onclick="triggerLink('${d.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg shadow-blue-50 transform active:scale-95 transition-all mb-6">
                    <div class="flex items-center gap-4 italic font-black uppercase"><img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png" class="w-10"><span>×ª×©×œ×•× ×‘-bit</span></div>
                    <svg class="w-7 h-7 text-[#00b0e9]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" stroke-linecap="round"/></svg>
                </button>`;
            } else {
                actionBtn = `
                <a href="${d.link}" target="_top" rel="noreferrer" class="group w-full bg-white border-2 border-orange-500 text-orange-600 p-5 rounded-2xl flex items-center justify-between shadow-lg shadow-orange-50 transform active:scale-95 transition-all mb-10">
                    <div class="flex items-center gap-4 italic font-black uppercase">
                        <div class="bg-orange-100 p-2 rounded-lg">ğŸš€</div>
                        <span>×‘×™×§×•×¨ ×‘××ª×¨ / ×§×™×©×•×¨</span>
                    </div>
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" stroke-linecap="round"/></svg>
                </a>`;
            }

            document.getElementById('main-view').innerHTML = `
                <h1 class="text-3xl font-black text-slate-800 mb-1 uppercase italic italic tracking-tighter">×¤×¨×’×Ÿ ×œ${d.name}!</h1>
                <p class="text-slate-500 text-sm mb-12 tracking-tight italic font-bold">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×©×™×¨×•×ª ×××•×‘×˜×—</p>
                
                ${actionBtn}
                
                <div class="mt-4 bg-green-50 border border-green-100 rounded-2xl p-4 flex items-center justify-center gap-3">
                   <div class="bg-green-100 text-green-600 rounded-full p-1"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2.166 10.324a.75.75 0 01.666-1.292C6.197 10.885 10 10.885 13.168 9.032a.75.75 0 01.764 1.288c-3.583 2.095-7.965 2.095-11.766-.996zM10 1.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 1.5z"/></svg></div>
                   <span class="text-green-800 font-bold text-[10px] italic">ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×”×¡×ª×™×™××” â€¢ ×ª×©×œ×•× ××•×’×Ÿ</span>
                </div>

                <div class="mt-14"><button onclick="toggleModal('smv',true)" class="text-xs font-black text-blue-500 underline py-2 decoration-blue-100 uppercase tracking-widest italic font-bold italic tracking-tighter uppercase italic tracking-tighter">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button></div>
            `;

            if(!document.getElementById('smv')) {
                document.body.insertAdjacentHTML('beforeend', `
                <div id="smv" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                   <div class="bg-white rounded-[2rem] p-8 w-full max-w-xs text-center shadow-2xl relative modal-enter border">
                      <h3 class="font-black text-xl mb-4 border-b pb-4 text-right">××–×•×¨ ××™×©×™</h3>
                      <input type="tel" id="ppin" placeholder="PIN" maxlength="4" class="w-full text-center text-4xl font-black p-4 border-2 border-slate-100 rounded-xl mb-6 bg-slate-50 outline-none italic tracking-widest focus:border-blue-300">
                      <button id="sgo" onclick="getPersonalS()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl text-xl shadow-lg">×›× ×™×¡×”</button>
                      <button onclick="toggleModal('smv',false)" class="text-slate-300 mt-6 text-[10px] font-bold uppercase tracking-widest italic decoration-slate-200">×¡×’×•×¨</button>
                      <div id="pout" class="mt-6 hidden bg-blue-50 p-6 rounded-3xl text-center border border-blue-100"></div>
                   </div>
                </div>`);
            }
        }

        async function getPersonalS() {
            const p = document.getElementById('ppin').value; if(p.length!==4) return;
            document.getElementById('sgo').innerText='×‘×•×“×§...';
            try {
               const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${p}`);
               const d = await r.json(); document.getElementById('sgo').innerText='×›× ×™×¡×”';
               const out = document.getElementById('pout'); out.classList.remove('hidden');
               if(d.success) out.innerHTML=`<div class='space-y-4 text-center'><div class='border-b pb-4 text-center'><p class='text-[10px] text-slate-400'>×¡×¨×™×§×•×ª:</p><p class='text-4xl font-black text-blue-600 italic tracking-widest'>${d.total}</p></div><div><p class='text-[10px] text-slate-400'>×××•×¦×¢ ×™×•××™:</p><p class='text-2xl font-bold'>${d.average}</p></div><button onclick="if(confirm('××—×™×§×ª ×›×œ ×”×§×™×©×•×¨×™× ××”×›×¨×˜×™×¡?')) window.location.href='${API_URL}?action=reset&id=${cardId}&pin=${p}'" class='text-red-500 font-bold underline mt-6 text-[10px] uppercase'>ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×”</button></div>`;
               else out.innerHTML=`<span class='text-red-600 font-bold'>×§×•×“ ×©×’×•×™ âŒ</span>`;
            } catch(e) { alert("×©×’×™××ª ×¨×©×ª"); }
        }

        function toggleModal(i,s) { const el=document.getElementById(i); if(s){el.classList.remove('hidden');el.classList.add('flex');} else {el.classList.add('hidden');el.classList.remove('flex');} }
        function triggerLink(u) { if(!u) return; const bit=u.trim().startsWith('h')?u:'https://'+u; const w=window.open(bit,'_blank'); if(!w || w.closed) window.top.location.href=bit; }

        async function scanQRNow(f) {
           return new Promise(r=>{
               const rd=new FileReader(); rd.readAsDataURL(f);
               rd.onload = e=>{
                   const im=new Image(); im.src=e.target.result;
                   im.onload=()=>{
                       const can=document.createElement('canvas'); const ct=can.getContext('2d');
                       const s = Math.min(800/im.width,800/im.height);
                       can.width=im.width*s; can.height=im.height*s;
                       ct.drawImage(im,0,0,can.width,can.height);
                       let q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                       if(!q){
                          ct.drawImage(im,0,im.height*0.25,im.width,im.height*0.5,0,0,can.width,can.height);
                          q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                       }
                       r(q?q.data:null);
                   }
               }
           });
        }
        init();
    </script>
</body>
</html>
