<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipTap | ×¤×©×•×˜ ×œ×¤×¨×’×Ÿ</title>
    
    <!-- ×¡×¤×¨×™×•×ª ×—×™×¦×•× ×™×•×ª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- ×”×•×¡×¤×ª ×¡×¤×¨×™×™×ª ×§×•× ×¤×˜×™ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* ×œ×•××“×¨ ××©×•×“×¨×’ ×•×™×–×•××œ×™×ª ××š ×©×•××¨ ×¢×œ ×”××‘× ×” */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }

        /* ××¤×§×˜ ×œ×—×™×¦×” ×œ×›×¤×ª×•×¨×™× */
        .btn-active:active { transform: scale(0.96); transition: 0.1s; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-10 pb-12 text-right">

    <script>
        // ×•×•×“× ×©×–×” ×”×œ×™× ×§ ×œ×¡×§×¨×™×¤×˜ ×©×œ×š
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        const ASSETS = {
            main: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg",
            bit: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png",
            guide: "https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png"
        };
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[500px]">
        
        <!-- Header ×§×‘×•×¢ - ××‘× ×” ×–×”×” ×œ××§×•×¨ -->
        <div id="static-header">
            <div class="relative w-32 h-32 mx-auto -mt-24 mb-4">
                <img src="" id="logo-img" class="w-full h-full bg-white rounded-3xl shadow-xl border-4 border-white object-cover">
            </div>
            <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight uppercase">TipTap</h1>
            <p id="ui-card-id" class="text-[10px] text-slate-400 font-bold mb-6 tracking-widest uppercase">LOADING...</p>
        </div>

        <div id="reset-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>
        
        <!-- ××™×–×•×¨ ×”×˜×¢×™× ×” ×”××§×•×¨×™ -->
        <div id="loader-view" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 font-bold animate-pulse">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>

        <!-- ××™×–×•×¨ ×”×ª×•×›×Ÿ ×”×¨××©×™ (××•×¡×ª×¨ ×‘×”×ª×—×œ×”) -->
        <div id="main-view" class="hidden flex-grow flex flex-col"></div>
    </div>

    <!-- Modals Container (××§×•×¨×™) -->
    <div id="modals">
        <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-[2rem] w-full max-w-md p-6 flex flex-col max-h-[85vh] modal-enter shadow-2xl">
                <div class="flex justify-between items-center mb-6"><h3 class="font-black text-xl text-right">×¢×–×¨×” ×•×©××œ×•×ª</h3><button onclick="toggleModal('faq-modal',false)" class="text-2xl text-slate-300">&times;</button></div>
                <div class="space-y-3 overflow-y-auto text-sm text-right pr-1">
                    <details class="bg-slate-50 p-4 rounded-xl"><summary class="font-bold cursor-pointer italic uppercase flex justify-between"><span>××™×š ××•×¦×™××™× QR ××‘×™×˜?</span><span>+</span></summary>
                        <p class="mt-2 leading-relaxed text-slate-600">×‘×™×˜ > ×©×œ×•×© × ×§×•×“×•×ª ×œ××¢×œ×” > "×§×•×“ QR ×”×§×‘×•×¢ ×©×œ×™ ×œ×§×‘×œ×ª ×›×¡×£" > ×¦×œ××• ××¡×š.</p></details>
                    <details class="bg-red-50 p-4 rounded-xl border border-red-100 text-red-600 font-bold"><summary class="cursor-pointer underline flex justify-between"><span>×©×›×—×ª×™ ××ª ×”×§×•×“ ×”×¡×•×“×™?</span><span>+</span></summary>
                        <p class="mt-2 text-xs font-normal text-red-800">×œ×œ× ×”×§×•×“ ×”×¡×•×“×™ ×œ× × ×™×ª×Ÿ ×œ××¤×¡ ××ª ×”×›×¨×˜×™×¡. ×‘××§×¨×” ×©×œ ××•×‘×“×Ÿ ×ª×¦×˜×¨×›×• ×œ×¨×›×•×© ×›×¨×˜×™×¡ ×—×“×©. ×©××¨×• ×¢×œ×™×• ×”×™×˜×‘!</p></details>
                </div>
                <button onclick="toggleModal('faq-modal',false)" class="w-full bg-slate-800 text-white py-4 rounded-2xl mt-6 font-bold shadow-lg btn-active">×”×‘× ×ª×™</button>
            </div>
        </div>

        <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4 backdrop-blur-md">
            <button onclick="toggleModal('guide-modal',false)" class="absolute top-4 right-4 text-white text-3xl font-bold bg-white/20 w-10 h-10 rounded-full">&times;</button>
            <img src="" id="guide-img" class="max-w-full rounded-3xl border-4 border-white shadow-2xl max-h-[80vh]">
        </div>
    </div>

    <script>
        // ××ª×—×•×œ ×ª××•× ×•×ª
        document.getElementById('logo-img').src = ASSETS.main;
        document.getElementById('guide-img').src = ASSETS.guide;

        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
        let selectedBitFile = null;

        // *** ×¤×•× ×§×¦×™×™×ª Init ×”××§×•×¨×™×ª - ×œ× ×©×•× ×ª×” ×›×“×™ ×œ×× ×•×¢ ×‘××’×™× ***
        async function init() {
            if(!cardId) { 
                document.getElementById('loader-view').innerHTML='<p class="py-10 font-bold text-slate-500">× × ×œ×¡×¨×•×§ ××ª ×”×›×¨×˜×™×¡</p>'; 
                document.getElementById('ui-card-id').innerText = 'NO ID FOUND';
                return; 
            }
            document.getElementById('ui-card-id').innerText = `CARD #${cardId}`;
            if(urlParams.get('reset')) document.getElementById('reset-success').classList.remove('hidden');

            try {
                // ×©×™××•×© ×‘××•×ª×” ×§×¨×™××” ×‘×“×™×•×§ ×©×¢×‘×“×” ×œ×š ×§×•×“×
                const r = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const d = await r.json();
                
                // ×”×¡×ª×¨×ª ×œ×•××“×¨ ×•×”×¦×’×ª ×ª×•×›×Ÿ
                document.getElementById('loader-view').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('main-view').classList.add('modal-enter'); // ×× ×™××¦×™×™×ª ×›× ×™×¡×”

                // × ×™×ª×•×‘ ×œ×¤×™ ×¡×˜×˜×•×¡
                if (d.status === "ACTIVE") renderPaymentPage(d);
                else if (d.status === "NEW") renderStartScreen();
                else if (d.status === "LOCKED") document.getElementById('main-view').innerHTML=`<div class='text-red-500 font-bold py-10'>×”×›×¨×˜×™×¡ × ×¢×•×œ ×œ-${d.minutes} ×“×§×•×ª</div>`;

            } catch(e) { 
                document.getElementById('loader-view').innerHTML='<p class="text-red-500 font-bold p-10 bg-red-50 rounded-xl">×©×’×™××ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª.<br>× ×¡×” ×œ×¨×¢× ×Ÿ.</p>'; 
            }
        }

        // --- ××¡×š ×”×’×“×¨×ª ×›×¨×˜×™×¡ (Setup) ---
        function renderStartScreen() {
            document.getElementById('main-view').innerHTML = `
                <p class="text-sm font-bold text-slate-500 mb-6 italic text-center uppercase tracking-wider">×‘×—×¨ ××¡×œ×•×œ ×œ×”×¤×¢×œ×”:</p>
                <button onclick="renderFinalStep('tip')" class="btn-active w-full p-4 mb-4 border-2 border-blue-100 rounded-2xl bg-white hover:bg-blue-50 transition-all flex items-center gap-4 text-right shadow-sm">
                    <div class="text-3xl bg-blue-100 p-2 rounded-xl">ğŸ’°</div>
                    <div class="leading-tight text-right"><span class="font-black text-blue-900 block uppercase">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-400 font-bold uppercase">×—×™×‘×•×¨ ×œ-Bit (××œ×¦×¨×™×)</span></div>
                </button>
                <button onclick="renderFinalStep('link')" class="btn-active w-full p-4 mb-10 border-2 border-orange-100 rounded-2xl bg-white hover:bg-orange-50 transition-all flex items-center gap-4 text-right shadow-sm">
                    <div class="text-3xl bg-orange-100 p-2 rounded-xl">ğŸš€</div>
                    <div class="leading-tight text-right"><span class="font-black text-orange-900 block uppercase">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400 font-bold uppercase">××¢×‘×¨ ×™×©×™×¨ ×œ×§×™×©×•×¨</span></div>
                </button>
                <button onclick="toggleModal('guide-modal',true)" class="text-xs font-bold text-orange-500 underline text-center block w-full mb-4 decoration-orange-200 uppercase tracking-wide">ğŸ“¸ ××™×š ××•×¦×™××™× QR?</button>
                <button onclick="toggleModal('faq-modal',true)" class="text-[10px] text-slate-300 font-black uppercase tracking-widest text-center block w-full hover:text-slate-500 transition-colors">×¢×–×¨×” ×•×©××œ×•×ª</button>
            `;
        }

        function renderFinalStep(m) {
            document.getElementById('main-view').innerHTML = `
                <button onclick="renderStartScreen()" class="text-xs font-bold text-slate-400 mb-6 flex items-center tracking-widest hover:text-slate-600 transition-colors">â† ×—×–×¨×”</button>
                
                <div class="space-y-4 text-right flex flex-col">
                    <h2 class="text-xl font-black text-center mb-2">${m==='tip'?'×”×’×“×¨×ª ×‘×™×˜':'×”×’×“×¨×ª ×§×™×©×•×¨'}</h2>
                    
                    ${m==='tip' ? `
                    <div><p class="text-xs font-bold text-slate-400 mr-1 mb-1 italic uppercase">×ª××•× ×ª QR ×-bit:</p>
                    <label id="ubox" class="flex flex-col items-center gap-2 p-6 border-2 border-dashed border-blue-200 rounded-2xl cursor-pointer hover:bg-blue-50 bg-white transition-colors">
                        <img src="${ASSETS.bit}" class="w-8 opacity-60">
                        <span id="stext" class="text-sm font-bold text-blue-400">×‘×—×¨ ×¦×™×œ×•× ××¡×š...</span>
                        <input type="file" id="fi" class="hidden" accept="image/*" onchange="selectedBitFile=this.files[0];document.getElementById('stext').innerText='×§×•×‘×¥ × ×‘×—×¨ âœ…';document.getElementById('ubox').classList.add('border-green-400','bg-green-50');">
                    </label></div>` : `
                    <div><p class="text-xs font-bold text-slate-400 mr-1 mb-1 italic uppercase">×”×“×‘×§ ×§×™×©×•×¨ (URL):</p>
                    <input type="url" id="link-field" dir="ltr" placeholder="www.example.com" class="w-full p-4 border-2 border-slate-100 rounded-2xl text-left bg-slate-50 focus:border-orange-400 outline-none font-bold"></div>`}
                    
                    <div>
                        <p class="text-xs font-bold text-slate-400 mr-1 italic uppercase mb-1">×©× ×©×™×•×¤×™×¢ ×‘×›×¨×˜×™×¡:</p>
                        <input type="text" id="name-field" placeholder="×“×•×’××”: ×“× ×™××œ" class="w-full p-4 border-2 border-slate-100 rounded-xl font-bold bg-slate-50 focus:border-slate-800 outline-none">
                    </div>
                    
                    <div>
                        <p class="text-xs font-bold text-slate-400 mt-2 mb-1 uppercase italic font-black">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª):</p>
                        <input type="tel" id="pin-field" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full p-4 border-2 border-slate-100 rounded-xl text-center text-xl font-black tracking-[0.6em] outline-none focus:border-slate-800 bg-slate-50">
                    </div>

                    <button onclick="handleSave('${m}')" class="btn-active w-full bg-slate-900 text-white font-black py-5 rounded-[1.5rem] shadow-xl text-lg mt-4">×©××•×¨ ×•×”×¤×¢×œ ğŸš€</button>
                    <p class="text-[9px] text-slate-300 text-center mt-2 uppercase font-bold tracking-wider">×§×•×“ ×”-PIN ××©××© ×œ× ×™×”×•×œ ×•××™×¤×•×¡ ×”×›×¨×˜×™×¡</p>
                </div>
            `;
        }

        async function handleSave(m) {
            const n = document.getElementById('name-field').value;
            const p = document.getElementById('pin-field').value;
            if(!n || p.length!==4) return alert("× × ×œ×”×–×™×Ÿ ×©× ×•×§×•×“ ×¡×•×“×™ ×‘×Ÿ 4 ×¡×¤×¨×•×ª");

            // ×œ×•××“×¨ ×‘×–××Ÿ ×©××™×¨×”
            document.getElementById('main-view').innerHTML = '<div class="py-20 flex flex-col items-center"><div class="loader mb-4"></div><p class="font-bold text-blue-600 animate-pulse italic uppercase">×©×•××¨ ×”×’×“×¨×•×ª...</p></div>';
            
            try {
                let bit = "", dir = "";
                if(m === 'tip') {
                    if(!selectedBitFile) throw "×—×•×‘×” ×œ×‘×—×•×¨ ×ª××•× ×ª QR";
                    bit = await scanQRNow(selectedBitFile); 
                    if(!bit) throw "QR ×œ× ×–×•×”×” ×‘×ª××•× ×”. × ×¡×• ×ª××•× ×” ×‘×¨×•×¨×” ×™×•×ª×¨.";
                } else {
                    const lf = document.getElementById('link-field');
                    if(!lf || !lf.value) throw "× × ×œ×”×–×™×Ÿ ×§×™×©×•×¨";
                    dir = lf.value.trim();
                    if(!dir.startsWith('http')) dir = 'https://' + dir;
                }
                
                // ×©×™××•×© ×‘×©×™×˜×ª Redirect ×©×œ GAS (×”×›×™ ×‘×˜×•×— ×‘×—×™× ×)
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${m}&name=${encodeURIComponent(n)}&pin=${p}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(dir)}`;
            } catch(e){ 
                alert(e); 
                window.location.reload(); 
            }
        }

        // --- ××¡×š ×›×¨×˜×™×¡ ×¤×¢×™×œ (Active) ---
        function renderPaymentPage(d) {
            let actionBtn = "";
            
            // ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× ×‘×”×ª×× ×œ××¡×œ×•×œ
            if (d.type === 'tip') {
                actionBtn = `
                <button onclick="triggerLink('${d.bit}')" class="btn-active group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-5 rounded-2xl flex items-center justify-between shadow-lg shadow-blue-50 mb-6 relative overflow-hidden">
                    <div class="flex items-center gap-4 italic font-black uppercase z-10">
                        <img src="${ASSETS.bit}" class="w-10">
                        <span>×ª×©×œ×•× ×‘-bit</span>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-full z-10">
                        <svg class="w-6 h-6 text-[#00b0e9]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" stroke-linecap="round"/></svg>
                    </div>
                </button>`;
            } else {
                // ×©×™× ×œ×‘: ×‘×§×™×©×•×¨ ×¨×’×™×œ ×”×•×¡×¤×ª×™ triggerLink ×’× ×›×“×™ ×œ×”×¤×¢×™×œ ××ª ×”×§×•× ×¤×˜×™
                actionBtn = `
                <button onclick="triggerLink('${d.link}')" class="btn-active group w-full bg-gradient-to-l from-slate-900 to-slate-800 text-white p-5 rounded-2xl flex items-center justify-between shadow-lg shadow-slate-200 mb-8">
                    <div class="flex items-center gap-4 italic font-black uppercase">
                        <div class="bg-white/20 p-2 rounded-lg text-xl">ğŸ”—</div>
                        <span>××¢×‘×¨ ×œ×§×™×©×•×¨</span>
                    </div>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" stroke-linecap="round"/></svg>
                </button>`;
            }

            document.getElementById('main-view').innerHTML = `
                <h1 class="text-3xl font-black text-slate-800 mb-1 uppercase italic tracking-tight">×¤×¨×’×Ÿ ×œ${d.name}!</h1>
                <p class="text-slate-500 text-sm mb-12 tracking-tight italic font-bold">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×©×™×¨×•×ª ×××•×‘×˜×—</p>
                
                ${actionBtn}
                
                <div class="mt-4 bg-green-50 border border-green-100 rounded-2xl p-4 flex items-center justify-center gap-3">
                   <div class="bg-green-100 text-green-600 rounded-full p-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2.166 10.324a.75.75 0 01.666-1.292C6.197 10.885 10 10.885 13.168 9.032a.75.75 0 01.764 1.288c-3.583 2.095-7.965 2.095-11.766-.996zM10 1.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 1.5z"/></svg></div>
                   <span class="text-green-800 font-bold text-[10px] italic">ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×”×¡×ª×™×™××”</span>
                </div>

                <div class="mt-14"><button onclick="toggleModal('smv',true)" class="text-[10px] font-black text-slate-300 hover:text-blue-500 underline py-2 uppercase tracking-widest transition-colors">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button></div>
            `;

            // ×‘× ×™×™×ª ×”××•×“×œ ×œ××–×•×¨ ××™×©×™ (×× ×œ× ×§×™×™×)
            if(!document.getElementById('smv')) {
                document.body.insertAdjacentHTML('beforeend', `
                <div id="smv" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm" onclick="if(event.target.id==='smv') toggleModal('smv',false)">
                   <div class="bg-white rounded-[2rem] p-8 w-full max-w-xs text-center shadow-2xl relative modal-enter">
                      <h3 class="font-black text-xl mb-6 border-b pb-4 text-right">××–×•×¨ ××™×©×™</h3>
                      <input type="tel" id="ppin" placeholder="PIN" maxlength="4" class="w-full text-center text-4xl font-black p-4 border-2 border-slate-100 rounded-xl mb-6 bg-slate-50 outline-none italic tracking-widest focus:border-blue-400">
                      <button id="sgo" onclick="getPersonalS()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl text-xl shadow-lg btn-active">×›× ×™×¡×”</button>
                      <button onclick="toggleModal('smv',false)" class="text-slate-400 mt-6 text-[10px] font-bold uppercase tracking-widest">×¡×’×•×¨</button>
                      <div id="pout" class="mt-6 hidden bg-blue-50 p-6 rounded-3xl text-center border border-blue-100"></div>
                   </div>
                </div>`);
            }
        }

        async function getPersonalS() {
            const p = document.getElementById('ppin').value; if(p.length!==4) return;
            document.getElementById('sgo').innerText='×‘×•×“×§...';
            try {
               const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${p}`);
               const d = await r.json(); document.getElementById('sgo').innerText='×›× ×™×¡×”';
               const out = document.getElementById('pout'); out.classList.remove('hidden');
               if(d.success) {
                   out.innerHTML=`
                   <div class='space-y-4 text-center animate-pulse'>
                        <div class='border-b border-blue-100 pb-4'>
                            <p class='text-[10px] text-slate-400 uppercase font-bold'>×¡×¨×™×§×•×ª:</p>
                            <p class='text-4xl font-black text-blue-600'>${d.total}</p>
                        </div>
                        <div>
                            <p class='text-[10px] text-slate-400 uppercase font-bold'>×××•×¦×¢ ×œ×™×•×:</p>
                            <p class='text-2xl font-bold text-slate-700'>${d.average}</p>
                        </div>
                        <button onclick="if(confirm('××—×™×§×ª ×›×œ ×”×§×™×©×•×¨×™× ××”×›×¨×˜×™×¡?')) window.location.href='${API_URL}?action=reset&id=${cardId}&pin=${p}'" class='text-red-500 font-bold underline mt-4 text-[10px] uppercase tracking-wide'>ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×”</button>
                   </div>`;
               }
               else out.innerHTML=`<span class='text-red-600 font-bold'>×§×•×“ ×©×’×•×™ âŒ</span>`;
            } catch(e) { alert("×©×’×™××ª ×¨×©×ª"); }
        }

        // --- ×¤×•× ×§×¦×™×™×ª ×˜×¨×™×’×¨ + ×§×•× ×¤×˜×™ (×”×©×™×¤×•×¨ ×”××‘×•×§×©) ---
        function triggerLink(u) { 
            if(!u) return; 
            
            // 1. ×”×¤×¢×œ×ª ×× ×™××¦×™×™×ª ×§×•× ×¤×˜×™
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#00b0e9', '#ffffff', '#fbbf24'] // ×¦×‘×¢×™ TipTap/Bit
            });

            const targetUrl = u.trim().startsWith('http') ? u : 'https://'+u;
            
            // 2. ×”×©×”×™×™×” ×§×œ×” ×›×“×™ ×©×™×¨××• ××ª ×”×§×•× ×¤×˜×™, ×•××– ×‘×™×¦×•×¢ ×”××¢×‘×¨ (Deep Linking Logic)
            setTimeout(() => {
                 // × ×™×¡×™×•×Ÿ ×¤×ª×™×—×” ×‘×˜××‘ ×—×“×© (×¢×“×™×£ ×œ××¤×œ×™×§×¦×™×•×ª)
                 const w = window.open(targetUrl,'_blank'); 
                 // ×× × ×—×¡× ××• ×œ× ×”×¦×œ×™×—, × ×™×ª×•×‘ ×‘××•×ª×• ×¢××•×“
                 if(!w || w.closed || typeof w.closed=='undefined') {
                     window.top.location.href = targetUrl;
                 }
            }, 800); 
        }

        function toggleModal(i,s) { const el=document.getElementById(i); if(s){el.classList.remove('hidden');el.classList.add('flex');} else {el.classList.add('hidden');el.classList.remove('flex');} }

        // --- ×¤×•× ×§×¦×™×™×ª ×¡×¨×™×§×ª QR ×”××§×•×¨×™×ª (Smart Crop) ---
        async function scanQRNow(f) {
           return new Promise(r=>{
               const rd=new FileReader(); rd.readAsDataURL(f);
               rd.onload = e=>{
                   const im=new Image(); im.src=e.target.result;
                   im.onload=()=>{
                       const can=document.createElement('canvas'); const ct=can.getContext('2d');
                       const s = Math.min(800/im.width,800/im.height);
                       can.width=im.width*s; can.height=im.height*s;
                       ct.drawImage(im,0,0,can.width,can.height);
                       let q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                       // ×× ×œ× ×”×¦×œ×™×— - × ×¡×” ×œ×—×ª×•×š ××ª ×”×—×œ×§ ×”×¢×œ×™×•×Ÿ (×›×•×ª×¨×•×ª ×‘×™×˜ ×•×›×•')
                       if(!q){
                          ct.drawImage(im,0,im.height*0.25,im.width,im.height*0.5,0,0,can.width,can.height);
                          q=jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                       }
                       r(q?q.data:null);
                   }
               }
           });
        }
        
        // ×”×¤×¢×œ×”
        init();
    </script>
</body>
</html>
