<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×”×“×¨×š ×”×§×œ×” ×œ×¤×¨×’×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .step-hidden { display: none; }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-24 pb-12 text-right">

    <script>
        // ×”×§×™×©×•×¨ ×©×œ×š ×”××¢×•×“×›×Ÿ
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        
        const LOGO_TIPTAP = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg";
        const LOGO_BIT = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png";
        
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');
    </script>

    <div class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[500px]">
        
        <!-- Header ×§×‘×•×¢ -->
        <div id="static-header">
            <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg" 
                 class="w-32 h-32 bg-white rounded-3xl mx-auto -mt-20 mb-4 shadow-2xl border-4 border-white object-cover">
            <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight">TipTap</h1>
            <p id="display-card-id" class="text-[10px] text-slate-400 font-bold mb-6 uppercase tracking-widest"></p>
        </div>

        <!-- ×”×•×“×¢×ª ××™×¤×•×¡ ×”×¦×œ×™×— -->
        <div id="reset-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-xl font-bold text-sm">âœ… ×”×›×¨×˜×™×¡ ××•×¤×¡ ×‘×”×¦×œ×—×”!</div>

        <!-- ×˜×•×¢×Ÿ -->
        <div id="loader" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>

        <!-- ×ª×•×›×Ÿ ××ª×—×œ×£ -->
        <div id="main-content" class="hidden flex-grow"></div>
    </div>

    <!-- ××•×“×œ×™× × ×©××¨×™× ××—×•×¥ ×œ×›×¨×˜×™×¡ -->
    <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-6 modal-enter flex flex-col max-h-[85vh] text-right">
            <div class="flex justify-between items-center mb-4"><h3 class="font-black text-xl">×©××œ×•×ª × ×¤×•×¦×•×ª</h3><button onclick="toggleModal('faq-modal', false)" class="text-2xl text-slate-300">&times;</button></div>
            <div class="space-y-3 overflow-y-auto text-sm">
                <details class="bg-slate-50 p-3 rounded-xl"><summary class="font-bold cursor-pointer">××™×š ××•×¦×™××™× QR ×-Bit?</summary><div class="mt-2 text-slate-600">×”×™×›× ×¡×• ×œ-Bit > 3 × ×§×•×“×•×ª ("×¢×•×“") > "×§×•×“ ×”-QR ×”×§×‘×•×¢ ×©×œ×™ ×œ×§×‘×œ×ª ×›×¡×£" > ×¦×œ××• ××¡×š ×•×”×¢×œ×• ×›××Ÿ.</div></details>
                <details class="bg-white border border-red-100 p-3 rounded-xl"><summary class="font-bold text-red-600 cursor-pointer">×©×›×—×ª×™ ××ª ×”×§×•×“ ×”×¡×•×“×™?</summary><div class="mt-2 text-red-600 text-xs">××™×Ÿ ×“×¨×š ×œ×©×—×–×¨ ×§×•×“ ×©××‘×“. ×× ×©×›×—×ª - × ×“×¨×© ×›×¨×˜×™×¡ ×—×“×©. ×¨×©×•× ××•×ª×• ×œ×¢×¦××š!</div></details>
                <details class="bg-slate-50 p-3 rounded-xl"><summary class="font-bold cursor-pointer text-right">×”×× ×”×©×™×¨×•×ª ×¢×•×œ×” ×›×¡×£?</summary><div class="mt-2 text-slate-600 text-right">×œ×. ×”×›×¡×£ ××”×˜×™×¤ ×¢×•×‘×¨ ×™×©×™×¨×•×ª ××œ×™×š ×œ×‘×™×˜ ×œ×œ× ×¢××œ×”.</div></details>
                <details class="bg-slate-50 p-3 rounded-xl"><summary class="font-bold cursor-pointer text-right">××™×š ××™×¤×•×¡ ×›×¨×˜×™×¡ ×¢×•×‘×“?</summary><div class="mt-2 text-slate-600 text-right">×‘××–×•×¨ ×”××™×©×™ ×ª×•×›×œ ×œ××¤×¡ ××ª ×”×§×™×©×•×¨×™× ×‘×œ×‘×“, ×”×¡×˜×˜×™×¡×˜×™×§×” ×©×œ ××¡×¤×¨ ×”×¡×¨×™×§×•×ª ×ª×™×©××¨ ×ª××™×“.</div></details>
            </div>
            <button onclick="toggleModal('faq-modal', false)" class="w-full bg-slate-800 text-white py-4 rounded-2xl mt-6 font-bold shadow-lg">×”×‘× ×ª×™, ×ª×•×“×”</button>
        </div>
    </div>

    <!-- ××•×“×œ ×”×“×¨×›×” -->
    <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4 backdrop-blur-md">
        <div class="relative w-full max-w-lg modal-enter flex flex-col items-center">
            <button onclick="toggleModal('guide-modal', false)" class="self-end text-white text-3xl mb-2 p-2">&times;</button>
            <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="w-full rounded-3xl border-4 border-white shadow-2xl">
        </div>
    </div>

    <!-- ××•×“×œ ×ª×§× ×•×Ÿ -->
    <div id="terms-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-8 text-right modal-enter shadow-2xl border border-white">
            <h3 class="font-black text-xl mb-4 text-slate-800 border-b pb-4">×ª×§× ×•×Ÿ ×•×ª× ××™ ×©×™××•×©</h3>
            <div class="text-sm text-slate-500 space-y-4">
                <p>â€¢ ×”×©×™×¨×•×ª × ×™×ª×Ÿ ×œ×œ× ××—×¨×™×•×ª ×œ×©×™×‘×•×©×™× ×¦×“ ×’' (×›××• Bit).</p>
                <p>â€¢ ×”×›×¨×˜×™×¡ × × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”. ××™×‘×•×“ ×§×•×“ ×¡×•×“×™ ×™×“×¨×•×© ×›×¨×˜×™×¡ ×—×“×©.</p>
                <p>â€¢ ×”××¢×¨×›×ª ×¨×©××™×ª ×œ×”×¤×¡×™×§ ××ª ×”×©×™×¨×•×ª ×‘×›×œ ×¢×ª.</p>
            </div>
            <button onclick="toggleModal('terms-modal', false)" class="w-full bg-blue-600 text-white py-4 rounded-2xl mt-8 font-bold">×¡×’×•×¨ ×•××™×©×•×¨</button>
        </div>
    </div>

    <script>
        let selectedFile = null;

        async function init() {
            if (!cardId) {
                renderUI(`<h1 class="text-xl font-bold mt-10">× × ×œ×¡×¨×•×§ QR ××”×›×¨×˜×™×¡</h1>`);
                return;
            }
            document.getElementById('display-card-id').innerText = `CARD #${cardId}`;
            if (urlParams.get('reset') === 'true') document.getElementById('reset-success').classList.remove('hidden');

            try {
                const response = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const data = await response.json();
                
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');

                if (data.status === "ACTIVE") renderPayment(data);
                else renderSetup();
            } catch (err) {
                renderUI(`<p class="text-red-500 py-10 font-bold">×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª.</p>`);
            }
        }

        function renderUI(html) {
            document.getElementById('loader').classList.add('hidden');
            const el = document.getElementById('main-content');
            el.classList.remove('hidden');
            el.innerHTML = html;
        }

        function renderSetup() {
            document.getElementById('main-content').innerHTML = `
                <p class="text-sm font-bold text-slate-600 mb-6 text-center italic tracking-tight">××” ×”-TipTap ×©×œ×š ×™×¢×©×”?</p>
                <button onclick="renderForm('tip')" class="w-full p-5 mb-4 bg-white border-2 border-blue-100 rounded-[1.5rem] hover:border-blue-500 flex items-center gap-4 transition-all">
                   <div class="text-3xl">ğŸ’°</div><div class="text-right leading-tight"><span class="block font-black text-blue-900">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-500">×—×™×‘×•×¨ ××”×™×¨ ×œ-bit</span></div>
                </button>
                <button onclick="renderForm('link')" class="w-full p-5 mb-10 bg-white border-2 border-orange-100 rounded-[1.5rem] hover:border-orange-500 flex items-center gap-4 transition-all">
                   <div class="text-3xl">ğŸš€</div><div class="text-right leading-tight"><span class="block font-black text-orange-900 italic uppercase italic tracking-tighter">××¡×œ×•×œ ×¢×¡×§×™</span><span class="text-[10px] text-orange-400">××¢×‘×¨ ×œ×§×™×©×•×¨ ××ª×¨</span></div>
                </button>
                <div class="space-y-4 text-center">
                    <button onclick="toggleModal('guide-modal', true)" class="text-sm font-bold text-orange-600 underline">ğŸ“¸ ×”×“×¨×›×” ×¢×œ ×”×¤×¢×œ×ª ×”×›×¨×˜×™×¡</button><br>
                    <button onclick="toggleModal('faq-modal', true)" class="text-xs text-slate-400 underline italic font-bold uppercase tracking-widest">×¢×–×¨×” ×•×©××œ×•×ª × ×¤×•×¦×•×ª</button>
                </div>
            `;
        }

        function renderForm(type) {
            document.getElementById('main-content').innerHTML = `
                <button onclick="renderSetup()" class="text-right text-blue-500 font-bold text-xs mb-6 px-1">â† ×—×–×¨×”</button>
                <div class="text-right space-y-4">
                    ${type === 'tip' ? `
                    <label class="block text-xs font-black text-slate-400 mr-1 uppercase italic tracking-tighter">×”×¢×œ××ª ×§×•×“ QR ×§×‘×•×¢ ×-bit:</label>
                    <label id="upload-box" class="flex items-center gap-4 p-4 border-2 border-dashed border-blue-200 rounded-2xl bg-white cursor-pointer hover:bg-blue-50">
                        <img src="${LOGO_BIT}" class="w-8">
                        <span id="u-status" class="text-sm font-bold text-slate-500 italic uppercase">×œ×—×¥ ×œ×‘×—×™×¨×ª ×¦×™×œ×•× ××¡×š...</span>
                        <input type="file" accept="image/*" class="hidden" onchange="selectedFile=this.files[0]; document.getElementById('u-status').innerText='×§×•×‘×¥ × ×‘×—×¨ âœ…'">
                    </label>` : `
                    <label class="block text-xs font-black text-slate-400 mr-1 uppercase italic italic uppercase italic tracking-tighter">×”×“×‘×§ ×§×™×©×•×¨ (URL):</label>
                    <input type="url" id="in-url" placeholder="https://..." class="w-full p-4 border-2 border-slate-100 rounded-xl bg-slate-50 text-left focus:border-orange-400 outline-none">`}
                    
                    <label class="block text-xs font-black text-slate-400 mr-1 mt-4 italic uppercase">×©× ×‘×¢×œ ×”×›×¨×˜×™×¡ (××‘×™ ×”××œ×š):</label>
                    <input type="text" id="in-name" placeholder="×œ×“×•×’××”: ××‘×™ ×”××œ×š" class="w-full p-3 border-2 border-slate-100 rounded-xl font-bold bg-slate-50 outline-none focus:border-blue-400">
                    
                    <label class="block text-xs font-black text-slate-400 mr-1 mt-4 uppercase leading-tight italic uppercase tracking-tighter italic font-black">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª) - ×™×©××© ×œ××–×•×¨ ××™×©×™:</label>
                    <input type="tel" id="in-pin" maxlength="4" placeholder="____" class="w-full p-3 border-2 border-slate-100 rounded-xl text-center tracking-[1em] font-black text-2xl bg-slate-50 outline-none focus:border-blue-400">

                    <div class="flex gap-2 p-2 mt-4 bg-slate-100 rounded-xl border border-slate-200">
                        <input type="checkbox" id="in-check" class="mt-1 w-5 h-5 cursor-pointer">
                        <label class="text-[10px] text-slate-500 leading-tight">×× ×™ ×××©×¨ ××ª <button type="button" onclick="toggleModal('terms-modal', true)" class="underline font-bold text-blue-600 italic">×”×ª×§× ×•×Ÿ</button>. ×™×“×•×¢ ×œ×™ ×©×”×›×¨×˜×™×¡ ×—×“ ×¤×¢××™ ×•× × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”.</label>
                    </div>

                    <button onclick="handleActive('${type}')" class="w-full bg-blue-600 text-white font-black py-5 rounded-[1.8rem] shadow-xl mt-6 active:scale-95 transition-all">×”×¤×¢×œ TipTap ğŸš€</button>
                </div>
            `;
        }

        async function handleActive(type) {
            const name = document.getElementById('in-name').value;
            const pin = document.getElementById('in-pin').value;
            const checked = document.getElementById('in-check').checked; // ID FIXED HERE
            
            if(!name || pin.length !== 4 || !checked) return alert("××œ× ××ª ×›×œ ×”×¤×¨×˜×™× ×•××©×¨ ××ª ×”×ª×§× ×•×Ÿ");
            
            renderUI(`<div class="py-20 flex flex-col items-center"><div class="loader mb-4"></div><p class="font-bold text-blue-600 animate-pulse uppercase tracking-widest italic">××¢×‘×“ TipTap...</p></div>`);

            try {
                let bit = "", link = "";
                if(type === 'tip') {
                    if(!selectedFile) throw "×”×¢×œ×” ×¦×™×œ×•× ××¡×š ×©×œ ×‘×™×˜ ×§×•×“×";
                    bit = await scanImage(selectedFile);
                    if(!bit) throw "×œ× ×”×¦×œ×—× ×• ×œ×¤×¢× ×— QR. × ×¡×” ×©×•×‘.";
                } else {
                    link = document.getElementById('in-url').value; // ID FIXED HERE
                }
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${type}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(link)}&name=${encodeURIComponent(name)}&pin=${pin}`;
            } catch (err) { alert(err); renderSetup(); }
        }

        function renderPayment(data) {
            const displayName = data.name || "×‘×¢×œ ×”×›×¨×˜×™×¡";
            document.getElementById('main-content').innerHTML = `
                <h1 class="text-2xl font-black text-slate-800 mb-1 italic tracking-tight italic uppercase">×¤×¨×’×Ÿ ×œ${displayName}!</h1>
                <p class="text-slate-500 text-sm mb-10 tracking-tight italic">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×××•×‘×˜×— ×‘-bit</p>
                <button onclick="forceOpenBit('${data.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-4 rounded-2xl flex items-center justify-between shadow-lg mb-4">
                   <div class="flex items-center gap-3 italic"><img src="${LOGO_BIT}" class="w-10 h-10 object-contain"><span class="text-xl font-bold font-heebo italic">×ª×©×œ×•× ×‘-bit</span></div>
                   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
                ${data.type === 'link' ? `<a href="${data.link}" target="_top" class="w-full bg-orange-500 text-white p-5 rounded-2xl text-lg font-black shadow-lg block mb-8">×‘×™×§×•×¨ ×‘××ª×¨ ğŸš€</a>` : ''}
                <div class="mt-4 bg-green-50 border border-green-100 rounded-xl p-3 flex items-center justify-center gap-3">
                    <span class="text-green-700 font-bold text-[10px]">ğŸ›¡ï¸ ×¡×¨×™×§×ª ××‘×˜×—×” ×‘×•×¦×¢×” ×‘×”×¦×œ×—×” â€¢ ×ª×©×œ×•× ××•×’×Ÿ</span>
                </div>
                <div class="mt-12">
                   <button onclick="toggleModal('stats-v', true)" class="text-sm font-black text-blue-500 underline py-2 relative z-20 italic">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button>
                </div>
                <a href="mailto:TIPTAP2026@GMAIL.COM" class="text-xs text-slate-300 mt-6 block text-center uppercase font-bold tracking-widest italic decoration-slate-200">âœ‰ï¸ ×¦×•×¨ ×§×©×¨</a>
            `;

            document.getElementById('modals-container').insertAdjacentHTML('beforeend', `
            <div id="stats-v" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
                <div class="bg-white rounded-[2rem] p-6 w-full max-w-xs text-center shadow-2xl relative">
                    <h3 class="font-bold mb-4 border-b pb-4 text-right italic font-black">××–×•×¨ ××™×©×™</h3>
                    <input type="tel" id="v-pin" placeholder="×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª)" maxlength="4" class="w-full text-center text-3xl font-black p-4 border-2 border-slate-100 rounded-xl mb-4 bg-slate-50 focus:border-blue-400 outline-none">
                    <button onclick="runS()" id="v-btn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg shadow-blue-100 italic font-black transition-all">×›× ×™×¡×”</button>
                    <button onclick="toggleModal('stats-v', false)" class="text-xs text-slate-300 mt-4 underline font-black uppercase italic tracking-widest p-2">×‘×™×˜×•×œ</button>
                    <div id="res-div" class="mt-4 hidden text-center bg-blue-50 p-4 rounded-xl italic font-bold"></div>
                </div>
            </div>`);
        }

        async function runS() {
            const p = document.getElementById('v-pin').value;
            if(p.length !== 4) return alert("×”×–×Ÿ 4 ×¡×¤×¨×•×ª");
            document.getElementById('v-btn').innerText = '×‘×•×“×§...';
            try {
                const r = await fetch(`${API_URL}?action=getStats&id=${cardId}&pin=${p}`);
                const res = await r.json();
                document.getElementById('v-btn').innerText = '×›× ×™×¡×”';
                const div = document.getElementById('res-div'); div.classList.remove('hidden');
                if(res.success) {
                    div.innerHTML = `<p class="text-xs">×¡×¨×™×§×•×ª: <b class="text-xl text-blue-600">${res.total}</b></p><p class="text-xs mt-1 border-t pt-1">×××•×¦×¢ ×™×•××™: <b class="text-blue-900">${res.average}</b></p><button onclick="resCard('${p}')" class="text-red-500 mt-6 text-[10px] underline font-bold opacity-60 uppercase italic italic">ğŸ—‘ï¸ ××™×¤×•×¡ ×•××—×™×§×”</button>`;
                } else div.innerHTML = '×§×•×“ ×©×’×•×™ âŒ';
            } catch(e) { alert("×©×’×™××ª ×¨×©×ª"); document.getElementById('v-btn').innerText='×›× ×™×¡×”'; }
        }

        function resCard(pin) { if(confirm("×œ××—×•×§ ×”×›×œ?")) { window.location.href=`${API_URL}?action=reset&id=${cardId}&pin=${pin}`; } }
        
        function toggleModal(id, show) { 
            const m = document.getElementById(id);
            if(show) { m.classList.remove('hidden'); m.classList.add('flex'); }
            else { m.classList.add('hidden'); m.classList.remove('flex'); }
        }

        function forceOpenBit(url) { 
            const u = url.trim().toLowerCase().startsWith('http') ? url : 'https://' + url;
            const w = window.open(u, '_blank'); 
            if(!w || w.closed) window.top.location.href = u; 
        }

        async function scanImage(file) {
            return new Promise(r => {
                const rd = new FileReader(); rd.readAsDataURL(file);
                rd.onload = e => {
                    const im = new Image(); im.src = e.target.result;
                    im.onload = () => {
                        const can = document.createElement('canvas'); const ct = can.getContext('2d');
                        const s = Math.min(800/im.width, 800/im.height);
                        can.width = im.width*s; can.height = im.height*s;
                        ct.drawImage(im, 0, 0, can.width, can.height);
                        let qr = jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                        if(!qr) {
                            ct.drawImage(im, 0, im.height*0.25, im.width, im.height*0.5, 0, 0, canvas.width, canvas.height);
                            qr = jsQR(ct.getImageData(0,0,can.width,can.height).data, can.width, can.height);
                        }
                        r(qr ? qr.data : null);
                    }
                }
            });
        }
        init();
    </script>
</body>
</html>
