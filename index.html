<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTap | ×”×›×¨×˜×™×¡ ×”×—×›× ×©×œ×š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00b0e9; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 pt-24 pb-12">

    <script>
        // *** ×—×•×‘×” ×œ×”×“×‘×™×§ ×›××Ÿ ××ª ×”×§×™×©×•×¨ ×”××¨×•×š ×©×œ ×’×•×’×œ ××”×¤×¨×™×¡×” ×”××—×¨×•× ×” ***
        const API_URL = "https://script.google.com/macros/s/AKfycbwEetH73WOCUrLOuNoyUNByH0JAFlxqSdi3UDJJdP5LwV9Z3WXQQDITaHM6hscW89e-/exec";
        
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get('id');

        const LOGO_TIPTAP = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1767290938556.jpg.jpeg";
        const LOGO_BIT = "https://raw.githubusercontent.com/mc26589/EASYTIP/main/1200px-Bit_logo_2024.svg.png";
    </script>

    <div id="app" class="glass max-w-md w-full rounded-[2.5rem] p-8 text-center shadow-2xl relative border border-white flex flex-col min-h-[450px]">
        <div id="loader" class="py-20 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 font-bold tracking-widest">××ª×—×‘×¨ ×œ××¢×¨×›×ª...</p>
        </div>
        <div id="main-content" class="hidden flex-grow flex flex-col"></div>
    </div>

    <!-- ××•×“×œ×™× × ×¡×ª×¨×™× -->
    <div id="modals-container">
        <!-- ××•×“×œ ×”×“×¨×›×” -->
        <div id="guide-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center p-4 backdrop-blur-md">
            <div class="relative w-full max-w-lg modal-enter flex flex-col">
                <button onclick="toggleModal('guide-modal', false)" class="self-end text-white text-3xl p-2">&times;</button>
                <img src="https://raw.githubusercontent.com/mc26589/EASYTIP/main/Gemini_Generated_Image_34mb2434mb2434mb.png" class="w-full rounded-3xl border-4 border-white shadow-2xl">
            </div>
        </div>

        <!-- ××•×“×œ FAQ -->
        <div id="faq-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-[2rem] w-full max-w-md p-6 modal-enter flex flex-col max-h-[85vh] text-right">
                <div class="flex justify-between items-center mb-4"><h3 class="font-black text-xl">×©××œ×•×ª × ×¤×•×¦×•×ª</h3><button onclick="toggleModal('faq-modal', false)" class="text-2xl">&times;</button></div>
                <div class="space-y-3 overflow-y-auto pr-1 text-sm flex-grow">
                    <details class="bg-slate-50 p-3 rounded-xl border border-slate-100"><summary class="font-bold cursor-pointer">××™×š ××•×¦×™××™× QR ×-Bit?</summary><div class="mt-2 text-slate-600 leading-relaxed italic text-right">×”×™×›× ×¡×• ×œ-Bit > ×©×œ×•×© × ×§×•×“×•×ª ("×¢×•×“") > "×§×•×“ ×”-QR ×”×§×‘×•×¢ ×©×œ×™ ×œ×§×‘×œ×ª ×›×¡×£" > ×¦×œ××• ××¡×š ×•×”×¢×œ×•.</div></details>
                    <details class="bg-slate-50 border border-red-100 p-3 rounded-xl"><summary class="font-bold cursor-pointer text-red-600">×©×›×—×ª×™ ×§×•×“ ×¡×•×“×™?</summary><div class="mt-2 text-red-600 leading-relaxed">×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨. ×‘××™×“×” ×•××‘×“, ×œ× ×ª×•×›×œ ×œ××¤×¡ ××ª ×”×›×¨×˜×™×¡ ×•×ª×™××œ×¥ ×œ×¨×›×•×© ×—×“×©. ×©××•×¨ ××•×ª×• ×‘××§×•× ×‘×˜×•×—!</div></details>
                </div>
                <button onclick="toggleModal('faq-modal', false)" class="w-full bg-slate-800 text-white py-4 rounded-2xl mt-6 font-bold shadow-lg">×”×‘× ×ª×™, ×ª×•×“×”!</button>
            </div>
        </div>

        <!-- ××•×“×œ ×ª×§× ×•×Ÿ -->
        <div id="terms-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-[2rem] w-full max-w-md p-8 text-right modal-enter">
                <h3 class="font-black text-xl mb-4 border-b pb-4">×ª×§× ×•×Ÿ ×•×ª× ××™ ×©×™××•×©</h3>
                <div class="text-sm text-slate-500 space-y-4">
                   <p>â€¢ ×”×©×™×¨×•×ª × ×™×ª×Ÿ ×œ×œ× ××—×¨×™×•×ª ×œ×©×™×‘×•×©×™× ×¦×“ ×’'.</p>
                   <p>â€¢ ×”×›×¨×˜×™×¡ × × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×” ×”×¨××©×•× ×™×ª.</p>
                   <p>â€¢ ×”×—×‘×¨×” ×¨×©××™×ª ×œ×”×¤×¡×™×§ ×©×™×¨×•×ª ×‘×›×œ ×¢×ª.</p>
                </div>
                <button onclick="toggleModal('terms-modal', false)" class="w-full bg-blue-600 text-white py-4 rounded-2xl mt-8 font-bold shadow-lg shadow-blue-200 hover:bg-blue-700">×¡×’×•×¨ ×•××™×©×•×¨</button>
            </div>
        </div>

        <!-- ××•×“×œ ×¡×˜×˜×™×¡×˜×™×§×” -->
        <div id="statsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
          <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl relative">
            <h3 class="font-bold mb-4 border-b pb-2 text-right">×›× ×™×¡×” ×œ××–×•×¨ ××™×©×™</h3>
            <input type="tel" id="pinInput" placeholder="×§×•×“ ×¡×•×“×™" maxlength="4" class="w-full text-center text-2xl p-3 border-2 rounded-xl mb-4 outline-none">
            <button onclick="checkStats()" id="checkBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mb-2">×›× ×™×¡×”</button>
            <button onclick="toggleModal('statsModal', false)" class="text-sm text-gray-400 p-2 w-full">×‘×™×˜×•×œ</button>
            <div id="statsResult" class="mt-4 hidden text-right bg-blue-50 p-4 rounded-xl border border-blue-100 text-center"></div>
          </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ×–×™×”×•×™ ×§×‘×¦×™×
        let selectedBitFile = null;

        async function init() {
            if (!cardId) {
                renderError("× × ×œ×¡×¨×•×§ ×§×•×“ QR ×ª×§×™×Ÿ ××”×›×¨×˜×™×¡");
                return;
            }
            try {
                // ×”×‘××ª × ×ª×•× ×™× ××’×•×’×œ (××¦×‘ ×“×£ × ×§×™ ×œ×œ× ×¢×™×¦×•×‘)
                const res = await fetch(`${API_URL}?id=${cardId}&action=getData`);
                const data = await res.json();
                
                hideLoader();
                if (data.status === "ACTIVE") {
                    renderPayment(data);
                } else {
                    renderPathSelection();
                }
            } catch (err) {
                renderError("×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª ×’×•×’×œ. ×•×•×“× ×©×”×¤×¨×™×¡×” ×”×•×’×“×¨×” ×œ-'Anyone'.");
            }
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×™×‘×•×“ ×•×™×–×•××œ×™ ---

        function hideLoader() { document.getElementById('loader').style.display = 'none'; }

        function renderError(msg) {
            hideLoader();
            const el = document.getElementById('main-content');
            el.classList.remove('hidden');
            el.innerHTML = `<img src="${LOGO_TIPTAP}" class="w-24 h-24 mx-auto mb-6 opacity-30 grayscale"><p class="font-bold text-slate-800">${msg}</p>`;
        }

        // 1. ×“×£ ×ª×©×œ×•×
        function renderPayment(data) {
            const el = document.getElementById('main-content');
            el.classList.remove('hidden');
            const cleanName = data.name || "××‘×™ ×”××œ×š";
            el.innerHTML = `
                <img src="${LOGO_TIPTAP}" class="w-32 h-32 mx-auto mb-6 rounded-3xl shadow-2xl border-4 border-white object-cover -mt-16">
                <h1 class="text-2xl font-black text-slate-800 mb-1">×¤×¨×’×Ÿ ×œ${cleanName}!</h1>
                <p class="text-slate-500 text-sm mb-10 tracking-tight italic italic">××¦××™×“×™× ×•××¤×¨×’× ×™× â€¢ ×××•×‘×˜×— ×‘-bit</p>
                <button onclick="forceOpenBit('${data.bit}')" class="group w-full bg-white border-2 border-[#00b0e9] text-[#00b0e9] p-4 rounded-2xl flex items-center justify-between shadow-lg active:scale-95 transition-all mb-4">
                   <div class="flex items-center gap-3">
                     <img src="${LOGO_BIT}" class="w-10 h-10 object-contain"><span class="text-xl font-bold tracking-tighter">×ª×©×œ×•× ×‘-bit</span>
                   </div>
                   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                ${data.type === 'link' ? `<a href="${data.link}" target="_top" class="w-full bg-orange-500 text-white p-5 rounded-2xl text-lg font-black shadow-lg mb-6">×‘×™×§×•×¨ ×‘××ª×¨ / ×§×™×©×•×¨ ğŸš€</a>` : ''}
                <div class="mt-auto pt-10"><button onclick="toggleModal('statsModal', true)" class="text-sm font-bold text-blue-500 underline decoration-blue-200">××–×•×¨ ××™×©×™ ×œ×‘×¢×œ ×”×›×¨×˜×™×¡</button></div>
                <a href="mailto:TIPTAP2026@GMAIL.COM" class="text-xs text-slate-300 mt-6">âœ‰ï¸ ×¦×•×¨ ×§×©×¨</a>
            `;
        }

        // 2. ×“×£ ×‘×—×™×¨×ª ××¡×œ×•×œ
        function renderPathSelection() {
            const el = document.getElementById('main-content');
            el.classList.remove('hidden');
            el.innerHTML = `
                <img src="${LOGO_TIPTAP}" class="w-32 h-32 mx-auto mb-6 rounded-3xl shadow-2xl border-4 border-white object-cover -mt-16">
                <h1 class="text-2xl font-black text-slate-800 italic">×”×¤×¢×œ×ª TipTap</h1>
                <p class="text-xs text-slate-400 font-bold mb-8 uppercase tracking-widest leading-none">Card #${cardId}</p>
                <p class="text-sm font-bold text-slate-600 mb-6">××” ×”-TipTap ×©×œ×š ×™×¢×©×”?</p>
                <button onclick="renderFullActivation('tip')" class="w-full p-4 mb-4 bg-white border-2 border-blue-100 rounded-2xl hover:border-blue-500 flex items-center gap-4 transition-all">
                   <div class="text-3xl">ğŸ’°</div><div class="text-right leading-none"><span class="block font-black text-blue-900">××¡×œ×•×œ ×˜×™×¤</span><span class="text-[10px] text-blue-500">×—×™×‘×•×¨ ××”×™×¨ ×œ-bit</span></div>
                </button>
                <button onclick="renderFullActivation('link')" class="w-full p-4 mb-8 bg-white border-2 border-orange-100 rounded-2xl hover:border-orange-500 flex items-center gap-4 transition-all">
                   <div class="text-3xl">ğŸš€</div><div class="text-right leading-none"><span class="block font-black text-orange-900 font-bold">××¡×œ×•×œ ×¢×¡×§×™ / ××™×©×™</span><span class="text-[10px] text-orange-400 italic">××¢×‘×¨ ×™×©×™×¨ ×œ××ª×¨ ××• ×§×™×©×•×¨</span></div>
                </button>
                <button onclick="toggleModal('guide-modal', true)" class="text-sm font-bold text-orange-600 underline px-4 py-2 mb-2 italic">ğŸ“¸ ×”×“×¨×›×” ×¢×œ ×”×¤×¢×œ×ª ×”×›×¨×˜×™×¡</button>
                <button onclick="toggleModal('faq-modal', true)" class="text-xs text-slate-400 underline italic">×¢×–×¨×” ×•×©××œ×•×ª</button>
            `;
        }

        // 3. ×˜×•×¤×¡ ×”×¤×¢×œ×” ××œ×
        function renderFullActivation(pathType) {
            const el = document.getElementById('main-content');
            const color = pathType === 'tip' ? 'blue' : 'orange';
            el.innerHTML = `
                <button onclick="renderPathSelection()" class="text-right text-blue-500 font-bold text-xs mb-4">â† ×—×–×¨×”</button>
                <div class="text-right space-y-4">
                   ${pathType === 'tip' ? `
                      <label class="block text-xs font-black text-slate-500 mb-2">×”×¢×œ××ª ×§×•×“ ×”-QR ×”×§×‘×•×¢ ×©×œ×š ×-Bit:</label>
                      <label id="upload-box" class="flex items-center gap-4 p-4 border-2 border-dashed border-blue-200 rounded-2xl bg-white cursor-pointer transition-all hover:bg-blue-50">
                        <img src="${LOGO_BIT}" class="w-8 h-8 object-contain">
                        <span id="upload-status" class="text-sm font-bold text-slate-700 italic">×‘×—×¨ ×¦×™×œ×•× ××¡×š ××‘×™×˜...</span>
                        <input type="file" id="input-qr" accept="image/*" class="hidden" onchange="handleFileChange(event)">
                      </label>
                   ` : `
                      <label class="block text-xs font-black text-slate-500 mb-2 italic tracking-tighter uppercase">×”×“×‘×§ ×§×™×©×•×¨ (URL):</label>
                      <input type="url" id="input-url" placeholder="https://..." class="w-full p-4 border-2 border-slate-100 rounded-xl bg-slate-50 outline-none text-left">
                   `}
                   <label class="block text-xs font-black text-slate-500 italic mt-6 uppercase">×©× (×™×•×¤×™×¢ ×œ×œ×§×•×—):</label>
                   <input type="text" id="input-name" placeholder="×“×•×’××”: ××‘×™ ×”××œ×š" class="w-full p-3 border-2 border-slate-100 rounded-xl bg-slate-50 focus:border-blue-400 outline-none italic font-bold">
                   <label class="block text-xs font-black text-slate-500 mt-4 leading-none italic uppercase">×§×•×“ ×¡×•×“×™ (4 ×¡×¤×¨×•×ª) - ×œ××–×•×¨ ×”××™×©×™:</label>
                   <input type="tel" id="input-pin" maxlength="4" placeholder="____" class="w-full p-3 border-2 border-slate-100 rounded-xl bg-slate-50 text-center tracking-[1em] font-black text-2xl outline-none focus:border-blue-400">
                   <div class="flex gap-2 p-2"><input type="checkbox" id="check-terms" class="mt-1"><label class="text-[10px] text-slate-400 leading-tight">×× ×™ ×××©×¨ ×©×§×¨××ª×™ ××ª ×”×ª×§× ×•×Ÿ. ×”×›×¨×˜×™×¡ × × ×¢×œ ×œ××—×¨ ×”×”×¤×¢×œ×”.</label></div>
                   <button onclick="submitActivation('${pathType}')" class="w-full bg-blue-600 text-white font-black py-5 rounded-[2rem] shadow-xl mt-6 active:scale-95 transition-all">×”×¤×¢×œ TipTap ğŸš€</button>
                </div>
            `;
        }

        // --- ×œ×•×’×™×§×” ×˜×›× ×™×ª ---

        function handleFileChange(e) {
            const f = e.target.files[0];
            if (f) {
                selectedBitFile = f;
                document.getElementById('upload-status').innerText = "×”×§×•×‘×¥ × ×‘×—×¨ âœ…";
                document.getElementById('upload-box').classList.add('border-blue-600', 'bg-blue-100');
            }
        }

        async function submitActivation(path) {
            const name = document.getElementById('input-name').value;
            const pin = document.getElementById('input-pin').value;
            const terms = document.getElementById('check-terms').checked;

            if(!name || pin.length !== 4 || !terms) return alert("××œ× ×¤×¨×˜×™×, 4 ×¡×¤×¨×•×ª ×§×•×“ ×•××™×©×•×¨ ×ª×§× ×•×Ÿ");
            
            const main = document.getElementById('main-content');
            main.innerHTML = `<div class="py-20 text-center flex flex-col items-center"><div class="loader mb-4"></div><p id="sub-msg" class="text-blue-700 font-bold">××¤×¢× ×— ×•××’×“×™×¨...</p></div>`;

            try {
                let bit = "", link = "";
                if(path === 'tip') {
                    if(!selectedBitFile) return alert("×”×¢×œ×” ×¦×™×œ×•× ××¡×š ×§×•×“×");
                    bit = await scanImageFile(selectedBitFile);
                    if(!bit) throw "×œ× ××¦×× ×• QR ×‘×ª××•× ×”. × ×¡×” ×©×•×‘.";
                } else {
                    link = document.getElementById('input-url').value;
                }

                // ×©×œ×‘ ×”"×§×¡×": ×‘××§×•× ×œ× ×¡×•×ª fetch DOPost ×©××¡×ª×‘×š, ××©×ª××©×™× ×‘×˜×¨×™×§ ×”×§×™×™× ×©×œ ×“×£ ×”×ª×™×•×•×š (×’×•×’×œ ×™×¢×‘×“ ×•×™×—×–×•×¨ ×¢× Success)
                // ×›××Ÿ ×× ×—× ×• ×—×™×™×‘×™× ×œ×”×©×ª××© ×‘-google.script.run ×”××•×‘× ×” ××‘×œ Vercel ×œ× ×ª×•××š ×‘×•. 
                // ×œ×›×Ÿ ×”×¤×ª×¨×•×Ÿ ×”× ×›×•×Ÿ ×”×•×:
                window.location.href = `${API_URL}?action=save&id=${cardId}&type=${path}&bit=${encodeURIComponent(bit)}&direct=${encodeURIComponent(link)}&name=${encodeURIComponent(name)}&pin=${pin}`;

            } catch (err) {
                alert("×©×’×™××”: " + err);
                renderPathSelection();
            }
        }

        async function scanImageFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let result = scanOneAttempt(img, 'normal') || scanOneAttempt(img, 'crop-center');
                        resolve(result);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function scanOneAttempt(img, mode) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let w = img.width, h = img.height;
            if(mode === 'crop-center') h = h * 0.5;
            const scale = Math.min(800/w, 800/h);
            canvas.width = w*scale; canvas.height = h*scale;
            ctx.drawImage(img, 0, mode === 'crop-center' ? img.height*0.25 : 0, img.width, mode === 'crop-center' ? img.height*0.5 : img.height, 0, 0, canvas.width, canvas.height);
            const raw = ctx.getImageData(0,0,canvas.width,canvas.height);
            const code = jsQR(raw.data, canvas.width, canvas.height);
            return code ? code.data : null;
        }

        function toggleModal(id, show) {
            const m = document.getElementById(id);
            m.classList.toggle('hidden', !show);
            m.classList.toggle('flex', show);
        }

        function forceOpenBit(url) {
            const u = url.trim();
            const bit = u.toLowerCase().startsWith('http') ? u : "https://" + u;
            const win = window.open(bit, '_blank');
            if(!win || win.closed) window.top.location.href = bit;
        }

        // ×¡×˜×˜×™×¡×˜×™×§×” ×•××™×¤×•×¡ (×“×—×™×¤×” ×œ×¡×§×¨×™×¤×˜ ×’×•×’×œ)
        function checkStats() {
           const p = document.getElementById('pinInput').value;
           fetch(`${API_URL}?id=${cardId}&action=getStats&pin=${p}`)
             .then(r => r.json())
             .then(res => {
               const div = document.getElementById('statsResult'); div.classList.remove('hidden');
               if(res.success) div.innerHTML = `×¡×¨×™×§×•×ª: <b>${res.total}</b><br>×××•×¦×¢ ×œ×™×•×: <b>${res.average}</b><hr class='my-4'><button onclick="resetReq('${p}')" class='text-red-500 font-bold'>ğŸ—‘ï¸ ××™×¤×•×¡ ×›×¨×˜×™×¡</button>`;
               else div.innerHTML = `<p class='text-red-500'>×§×•×“ ×©×’×•×™ âŒ</p>`;
             });
        }

        function resetReq(pin) {
           if(confirm("×œ××¤×¡? ×”×›×œ ×™××—×§!")) {
             window.location.href = `${API_URL}?id=${cardId}&action=reset&pin=${pin}`;
           }
        }

        init();
    </script>
</body>
</html>
